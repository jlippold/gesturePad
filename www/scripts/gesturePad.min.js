/*!  gesturePad 2014-03-14 */
var DirecTV={recentChannels:[],changeChannel:function(e){var t=util.getCurrentDevice();DirecTV.addToRecentChannels(e),$.getJSON("http://"+t.IPAddress+":"+t.Port+"/tv/tune?major="+e,function(){ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},3e3)})},getTitleForChannel:function(e){var t=e;return $.each(guide.channels,function(i){var a=guide.channels[i];return a.number==e?(t=""===a.nowplaying?a.fullname:a.nowplaying,!1):void 0}),t},addToRecentChannels:function(e){var t=DirecTV.recentChannels;t=jQuery.grep(t,function(t){return t!=e}),t.unshift(e),t=t.slice(0,4),DirecTV.recentChannels=t},startWorker:function(){try{clearTimeout(workerTimer)}catch(e){}for(var t=[],i=0,a=0;settings.userSettings.rooms.length>a;a++)for(var o=0;settings.userSettings.rooms[a].devices.length>o;o++)"DTV"==settings.userSettings.rooms[a].devices[o].shortname&&(t[i]="http://"+settings.userSettings.rooms[a].devices[o].IPAddress+":"+settings.userSettings.rooms[a].devices[o].Port+"/",$.ajaxq("DTVWorker"+i),i+=1);i=0;var n=!1;$.each(guide.channels,function(e){var a=guide.channels[e],o="0:00";if(a.startTime>0&&a.duration>0&&(o=util.hms2(a.startTime+a.duration-Math.floor((new Date).getTime()/1e3))),""===a.nowplaying||"0:00"==o){a.nowplaying="";for(var r=!1;r===!1;)i>t.length-1&&(i=0),t[i].room!=util.getCurrentDevice().shortname&&(DirecTV.refreshChannel(t[i],"DTVWorker"+i,e),n=!0,r=!0),i+=1}}),n===!1&&(workerTimer=setTimeout(function(){DirecTV.startWorker()},3e4))},setupWorker:function(e){if(DirecTV.hasDirecTV()!==!1){guide.channels=[];var t="";$(e).find("channels > channel").each(function(){if(t!=$(this).find("number").text()){var i={};i.number=$(this).find("number").text(),i.logo=$(this).find("logo").text(),i.callsign=$(this).find("callsign").text(),i.nowplaying="",i.ending=0,i.timeleft="",i.fullname=$(this).find("fullname").text(),i.startTime=0,i.duration=0;var a=$(e).find("channels > favorites > category > number").filter(function(){return $(this).text()==i.number});$(a).size()>0?(i.category=$(a).parent().attr("name"),i.catIndex=parseInt($(a).parent().attr("idx"),10)):(i.category="Unsorted",i.catIndex=999),guide.channels.push(i),t=i.number}}),guide.channels.sort(util.compare),DirecTV.startWorker()}},hasDirecTV:function(){for(var e=!1,t=0;settings.userSettings.rooms.length>t;t++)if(null!==settings.userSettings.rooms[t].DTV){e=!0;break}return e},loadChannelList:function(){var e="xml/channellist.xml?r="+Math.random();$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){DirecTV.setupWorker(e)},error:function(){util.doAlert("Error loading channel list: "+e)}})},refreshChannel:function(e,t,i){var a=guide.channels[i];$.ajaxq(t,{url:e+"tv/getProgInfo",dataType:"json",type:"GET",timeout:1e4,data:"major="+a.number,success:function(e){try{a.nowplaying=e.title,a.startTime=e.startTime,a.duration=e.duration,a.timeleft=util.hms2(e.startTime+e.duration-Math.floor((new Date).getTime()/1e3)),a.ending=e.startTime+e.duration}catch(i){document.ajaxq.q[t].shift()}DirecTV.checkIfWorkerIsComplete()},error:function(){document.ajaxq.q[t].shift(),DirecTV.checkIfWorkerIsComplete()}})},checkIfWorkerIsComplete:function(){var e=!0;$.each(document.ajaxq.q,function(t){document.ajaxq.q[t].length>1&&t.indexOf("DTVWorker")>-1&&(e=!1)}),e===!0&&(workerTimer=setTimeout(function(){DirecTV.startWorker()},3e4))}},MediaBrowser={lastOpenedCallBack:function(){MediaBrowser.createInitialListView()},resetCallback:function(){MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.createInitialListView()}},playByID:function(e,t){if(2==e&&DoShuffle(),1==e){var i=util.getMBUrl();i+="ui?command=play&id="+t,$.getJSON(i,function(){setTimeout(function(){ui.queryNowPlaying()},1500)})}},playTitle:function(e,t,i){if(util.isWifi()===!1)return util.doAlert("You are not on Wifi. To play this title, connect to Wifi and try again"),void 0;var a=util.getMBUrl(),o="";if(i)o=$(e).attr("data-guid"),a+="ui?command=play&id="+o,$.getJSON(a,function(){setTimeout(function(){ui.queryNowPlaying()},1500)}),util.doAlert("Now Playing\n"+t);else{var n=window.plugins.actionSheet,r=["Play","Resume","View on Screen"];"1"==$(e).attr("data-imdb")&&r.push("View Imdb Page"),r.push("Cancel"),o=$(e).attr("data-guid");var s="Actions";void 0!==s&&(s=t),n.create({title:s,items:r,destructiveButtonIndex:r.length-1},function(e,t){if(-1!=t&&t!=r.length-1){switch(r[t]){case"Play":a+="ui?command=play&id="+o;break;case"Resume":a+="ui?command=resume&id="+o;break;case"View on Screen":a+="ui?command=navigatetoitem&id="+o;break;case"View Imdb Page":a=""}""!==a?$.getJSON(a,function(){setTimeout(function(){ui.queryNowPlaying()},1500)}):$.ajax({url:util.getMBUrl()+"library/?Id="+o+"&lightData=1",dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(e){if(e.Data.ImdbID){var t=window.plugins.NativeTable;t.hideTable(function(){cb=window.plugins.childBrowser,null!==cb&&(cb.onClose=function(){setTimeout(function(){ui.view.trigger("rightNavButtonTap")},1e3)},cb.showWebPage("http://m.imdb.com/title/"+e.Data.ImdbID))})}else util.doAlert("Sorry, This title does not have an IMBD id")},error:function(){parse&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}})}})}},ShowItems:function(e,t){var i="click";t&&(i=t),util.getMBUrl(),util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var a=function(e){if("StartupFolder"==e.Data.Name)return MediaBrowser.createInitialListView(),void 0;var t=[];!settings.userSettings.moviesByDate||"Folder"!=e.Data.Type&&"FavoriteFolder"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),!settings.userSettings.tvByDate||"Season"!=e.Data.Type&&"Series"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),$.each(e.Data.Children,function(i){"Folder"==e.Data.Children[i].Type||"Season"==e.Data.Children[i].Type||"Series"==e.Data.Children[i].Type||"FavoriteFolder"==e.Data.Children[i].Type?t.push({textLabel:e.Data.Children[i].Name,detailTextLabel:""+e.Data.Children[i].ChildCount+" total, "+(e.Data.Children[i].UnwatchedCount?e.Data.Children[i].UnwatchedCount+" not watched, ":"")+e.Data.Children[i].RecentlyAddedUnplayedItemCount+" new",icon:"greyarrow",sectionHeader:"StartupFolder"==e.Data.Name?"Folders":e.Data.Children[0].Type,image:util.getRandomMBServer()+"image/?Id="+e.Data.Children[i].Id+"&maxwidth=120&maxheight=120",guid:e.Data.Children[i].Id,type:e.Data.Children[i].Type,imdb:e.Data.Children[i].ImdbRating>0?"1":"0"}):t.push({textLabel:(0===e.Data.Children[i].WatchedPercentage?"ðŸ”¹ ":"")+e.Data.Children[i].Name+(e.Data.Children[i].ProductionYear?" ("+e.Data.Children[i].ProductionYear+")":""),detailTextLabel:(e.Data.Children[i].ImdbRating?e.Data.Children[i].ImdbRating+"/10 ":"")+(e.Data.Children[i].TagLine?e.Data.Children[i].TagLine:""),icon:"none",sectionHeader:"StartupFolder"==e.Data.Name?"Folders":e.Data.Children[0].Type,image:util.getRandomMBServer()+"image/?Id="+e.Data.Children[i].Id+"&maxwidth=120&maxheight=120",guid:e.Data.Children[i].Id,type:e.Data.Children[i].Type,imdb:e.Data.Children[i].ImdbRating>0?"1":"0"})});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"StartupFolder"==e.Data.Name?"Folders":e.Data.Name,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:"StartupFolder"!=e.Data.Name?!0:!1,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.setRowSelectCallBackFunction(function(e){var a=t[e];if("none"==a.icon){var o=$("<tr data-guid='"+a.guid+"' data-imdb='"+a.imdb+"'></tr>");MediaBrowser.playTitle($(o),a.textLabel,!1)}else i.hideTable(function(){MediaBrowser.ShowItems(a)})}),"StartupFolder"==e.Data.Name?i.onBackButtonTap(function(){}):i.onBackButtonTap(function(){i.hideTable(function(){MediaBrowser.ShowItems({type:"Folder",guid:e.Data.parentId})})}),i.setTableData(t),util.doHud({show:!1}),i.showTable(function(){})},o=function(e,t){return util.isWifi()===!1&&t?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),void 0):($.ajax({url:e,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(i){null!==i.Data&&cache.saveJson(e,i),t&&a(i)},error:function(){t&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)};if("CustomFolder"==e.type){switch(e.folderType){case"Genres":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfGenres()};break;case"Years":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfYears()};break;case"Actors":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfActors()};break;case"Directors":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfDirectors()};break;case"OfficialRating":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfRating()};break;case"IMDBRating":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfIMDBRating()};break;case"Unwatched":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfUnwatched()};break;case"Custom TV":MediaBrowser.lastOpenedCallBack=function(){MediaBrowserNowPlaying.buildListView()}}MediaBrowser.lastOpenedCallBack()}else MediaBrowser.lastOpenedCallBack=function(){var t=util.getMBUrl()+"library/?lightData=1&Id="+e.guid;cache.getJson(t,function(e){null===e?o(t,!0):(a(e),o(t,!1))})},MediaBrowser.lastOpenedCallBack()},createInitialListView:function(){var e=function(e){var t=[];$.each(e.Data.Children,function(i){t.push({textLabel:e.Data.Children[i].Name,detailTextLabel:""+e.Data.Children[i].ChildCount+" total, "+e.Data.Children[i].UnwatchedCount+" not watched, "+e.Data.Children[i].RecentlyAddedUnplayedItemCount+" new",icon:"greyarrow",sectionHeader:"Folders",image:util.getMBUrl()+"image/?Id="+e.Data.Children[i].Id+"&maxwidth=120&maxheight=120",nomask:!1,guid:e.Data.Children[i].Id,type:e.Data.Children[i].Type,imdb:e.Data.Children[i].ImdbRating})}),t.unshift({textLabel:"Custom TV",detailTextLabel:"TV Channels based off your library",icon:"greyarrow",sectionHeader:"Now Playing",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Custom TV"}),t.push({textLabel:"Genres",detailTextLabel:"Movies Separated By Genre",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Genres"}),t.push({textLabel:"Rating",detailTextLabel:"Movies sorted by IMDB Rating",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"IMDBRating"}),t.push({textLabel:"Release Year",detailTextLabel:"Movies Separated By Production Year",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Years"}),t.push({textLabel:"Unwatched",detailTextLabel:"Movies that have not been watched",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Unwatched"}),t.push({textLabel:"Actors",detailTextLabel:"Movie Actors",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Actors"}),t.push({textLabel:"Directors",detailTextLabel:"Movie Directors",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Directors"}),t.push({textLabel:"MPAA Rating",detailTextLabel:"Official rating by the MPAA",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"OfficialRating"});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"Movies",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.setRowSelectCallBackFunction(function(e){var a=t[e];i.hideTable(function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."}),setTimeout(function(){MediaBrowser.ShowItems(a)},250)})}),i.setTableData(t),util.doHud({show:!1}),i.showTable(function(){})},t=function(t,i){return util.isWifi()===!1&&i?(util.doAlert("You are not on Wifi and no cached version exists. To do this, connect to Wifi and try again"),MediaBrowser.createInitialListView(),void 0):($.ajax({url:t,dataType:"json",timeout:settings.MBServiceTimeout,success:function(a){cache.saveJson(t,a),i&&e(a)},error:function(){i&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)},i=util.getMBUrl();i+="library/",MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.createInitialListView()},cache.getJson(i,function(a){null===a?t(i,!0):(e(a),t(i,!1))})},loadGeniusResults:function(e){cache.getJson("genius",function(t){null===t&&(t={refreshQueue:[],Titles:{},TitlesQueue:{},allItems:[],loaded:!1}),e(t)})},toolbarButtonClickEvent:function(e,t){1==e&&(MediaBrowserNowPlaying.allItemsPopulated=!1,t.hideTable(function(){ui.view.trigger("rightNavButtonTap")})),2==e&&gestures.executeGestureByCommandName("VolumeDown"),3==e&&gestures.executeGestureByCommandName("VolumeUp"),4==e&&t.hideTable(function(){util.setDeviceByShortName("DTV"),ui.view.trigger("rightNavButtonTap")}),5==e&&t.hideTable(function(){ui.view.trigger("rightNavButtonTap")})},createCustomTable:function(e,t,i,a){var o=window.plugins.NativeTable;o.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:t,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),o.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,o)}),o.onRightButtonTap(function(){o.hideTable(function(){})}),o.setRowSelectCallBackFunction(function(e){a(e,o)}),o.onBackButtonTap(function(){o.hideTable(function(){i()})}),o.setTableData(e),util.doHud({show:!1}),o.showTable(function(){})},showListOfYears:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){""!==a.ProductionYear&&null!==a.ProductionYear&&-1==jQuery.inArray(a.ProductionYear,t)&&(t.push(a.ProductionYear),e.push({textLabel:""+a.ProductionYear,detailTextLabel:"Movies Released in "+a.ProductionYear,icon:"greyarrow",sectionHeader:"Movies By Year",type:"CustomFolder",folderType:"Years"}))}),t=null,0===e.length?(util.doAlert("No Years found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("-textLabel")),MediaBrowser.createCustomTable(e,"Years",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByYear(a.textLabel)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByYear(a.textLabel)}}),void 0)})},showListOfMoviesByYear:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){a.ProductionYear==e&&t.push({textLabel:(0===a.WatchedPercentage?"ðŸ”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",sectionHeader:a.SortName.substring(0,1).toUpperCase(),guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this year."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfYears()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfGenres:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Genres)for(var o=0;a.Genres.length>o;o++)""!==a.Genres[o]&&null!==a.Genres[o]&&-1==jQuery.inArray(a.Genres[o],t)&&(t.push(a.Genres[o]),e.push({textLabel:a.Genres[o],detailTextLabel:""+a.Genres[o]+" movies",icon:"greyarrow",sectionHeader:"Movies By Genre",type:"CustomFolder",folderType:"Genres"}))}),t=null,0===e.length?(util.doAlert("No Genres found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("textLabel")),MediaBrowser.createCustomTable(e,"Genres",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByGenre(a.textLabel)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByGenre(a.textLabel)}}),void 0)})},showListOfMoviesByGenre:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Genres)for(var o=0;a.Genres.length>o;o++)a.Genres[o]==e&&t.push({textLabel:(0===a.WatchedPercentage?"ðŸ”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this genre."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfGenres()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfActors:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Actors)for(var o=0;a.Actors.length>o;o++)if(""!==$.trim(a.Actors[o].Name)&&null!==a.Actors[o].Name&&-1==jQuery.inArray(a.Actors[o].Name,t)){t.push(a.Actors[o].Name);var n=a.Actors[o].Name.split(" ").pop().replace(/[^a-zA-Z 0-9]+/g,"");if(n+=", "+a.Actors[o].Name.split(" ")[0].replace(/[^a-zA-Z 0-9]+/g,""),n.length>4){var r={textLabel:n,detailTextLabel:"",icon:"greyarrow",image:util.getRandomMBServer()+"image/?Id="+a.Actors[o].Person.Id+"&maxwidth=120&maxheight=120",sectionHeader:n.substring(0,1).toUpperCase(),type:"CustomFolder",folderType:"Actors",customSort:n,ActualName:a.Actors[o].Name};a.Actors[o].Person&&""!==a.Actors[o].Person.PrimaryImagePath&&null!==a.Actors[o].Person.PrimaryImagePath&&(r.image=util.getRandomMBServer()+"image/?Path="+encodeURIComponent(a.Actors[o].Person.PrimaryImagePath)+"&maxwidth=120&maxheight=120",r.guid=a.Actors[o].Person.Id),e.push(r)}}}),t=null,0===e.length?(util.doAlert("No Actors found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("customSort")),MediaBrowser.createCustomTable(e,"Actors",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByActor(a.ActualName)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByActor(a.ActualName)}}),void 0)})},showListOfMoviesByActor:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Actors)for(var o=0;a.Actors.length>o;o++)a.Actors[o].Name==e&&t.push({textLabel:(0===a.WatchedPercentage?"ðŸ”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this actor."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfActors()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfDirectors:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Directors)for(var o=0;a.Directors.length>o;o++)if(""!==$.trim(a.Directors[o])&&null!==a.Directors[o]&&-1==jQuery.inArray(a.Directors[o],t)){t.push(a.Directors[o]);var n=a.Directors[o].split(" ").pop().replace(/[^a-zA-Z 0-9]+/g,"");n+=", "+a.Directors[o].split(" ")[0].replace(/[^a-zA-Z 0-9]+/g,""),n.length>4&&e.push({textLabel:n,detailTextLabel:"",icon:"greyarrow",sectionHeader:n.substring(0,1).toUpperCase(),type:"CustomFolder",folderType:"Directors",customSort:n,ActualName:a.Directors[o]})}}),t=null,0===e.length?(util.doAlert("No Directors found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("customSort")),MediaBrowser.createCustomTable(e,"Directors",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByDirector(a.ActualName)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByDirector(a.ActualName)}}),void 0)})},showListOfMoviesByDirector:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Directors)for(var o=0;a.Directors.length>o;o++)a.Directors[o]==e&&t.push({textLabel:(0===a.WatchedPercentage?"ðŸ”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this Director."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfDirectors()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfRating:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){""!==a.OfficialRating&&null!==a.OfficialRating&&-1==jQuery.inArray(a.OfficialRating,t)&&(t.push(a.OfficialRating),e.push({textLabel:""+a.OfficialRating,detailTextLabel:"Movies Rated: "+a.OfficialRating,icon:"greyarrow",sectionHeader:"Movies By MPAA Rating",type:"CustomFolder",folderType:"Rating"}))}),t=null,0===e.length?(util.doAlert("No Ratings found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("textLabel")),MediaBrowser.createCustomTable(e,"Rating",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByRating(a.textLabel)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByRating(a.textLabel)}}),void 0)})},showListOfMoviesByRating:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){a.OfficialRating==e&&t.push({textLabel:(0===a.WatchedPercentage?"ðŸ”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this rating."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfRating()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfIMDBRating:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(util.isNumeric(a.ImdbRating)&&a.ImdbRating>0){var o=Math.floor(a.ImdbRating);-1==jQuery.inArray(o,t)&&(t.push(o),e.push({textLabel:o+" stars",detailTextLabel:"Movies with greater or equal to "+o+" stars",icon:"greyarrow",sectionHeader:"Movies By Rank",type:"CustomFolder",folderType:"imdbRating",imdbRating:""+o,sortOn:(10>o?"0":"")+o}))}}),t=null,0===e.length?(util.doAlert("No imdb ratings found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("-sortOn")),MediaBrowser.createCustomTable(e,"Rating",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByIMDBRating(a.imdbRating)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByIMDBRating(a.imdbRating)}}),void 0)})},showListOfMoviesByIMDBRating:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];e=parseInt(e,10),MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(util.isNumeric(a.ImdbRating)&&a.ImdbRating>0){var o=Math.floor(a.ImdbRating);o==e&&t.push({textLabel:(0===a.WatchedPercentage?"ðŸ”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}}),0===t.length?(util.doAlert("No movies found for this rating."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e.toString,function(){MediaBrowser.showListOfIMDBRating()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfUnwatched:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[];MediaBrowser.loadGeniusResults(function(t){return $.each(t.Titles,function(t,i){0===i.WatchedPercentage&&e.push({textLabel:(0===i.WatchedPercentage?"ðŸ”¹ ":"")+i.Name+(i.ProductionYear?" ("+i.ProductionYear+")":""),detailTextLabel:(i.ImdbRating?i.ImdbRating+"/10 ":"")+(i.TagLine?i.TagLine:""),icon:"none",sectionHeader:i.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+i.Id+"&maxwidth=120&maxheight=120",guid:i.Id,type:i.Type,imdb:i.ImdbRating>0?"1":"0",sortName:i.SortName})}),0===e.length?(util.doAlert("No unwatched movies found."),void 0):(e.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(e,"Unwatched",function(){MediaBrowser.createInitialListView()},function(t){var i=e[t],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},startWorker:function(e,t){var i=2880,a=new Date,o=util.getItem("lastRefresh");o=null===o?new Date("2010-01-01T23:44:52.790Z"):new Date(o);var n=(a.getTime()-o.getTime())/6e4,r=!1;if(n>i&&(r=!0),!(e===!0&&r===!1||e===!1&&r===!1)){var s="It's been a while since you last refreshed, \nWould you like to refresh now?";t&&(s="Refresh Now?"),navigator.notification.confirm(s,function(e){1==e&&(util.doHud({show:!0,labelText:"Checking for new media...",detailsLabelText:"Tap to cancel",tappedEvent:function(){util.setStatusBarForceClear(),util.doHud({show:!1}),geniusResults&&(geniusResults.refreshQueue=[],geniusResults.TitlesQueue=[]),$.ajaxq("genuisWorker")}}),cordova.require("cordova/plugin/powermanagement").acquire(function(){MediaBrowser.loadGeniusResults(function(e){e.refreshQueue=[],e.TitlesQueue=[],$.ajaxq("genuisWorker"),util.setStatusBarMessage("Searching for new titles");var t=util.getRandomMBServer()+"library?lightData=1";console.log(t),$.ajax({url:t,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(t){t.Data&&(console.log(t),$.each(t.Data.Children,function(i){var a=t.Data.Children[i];"Folder"==a.Type&&e.refreshQueue.push({Id:a.Id,title:a.Name})}),util.setStatusBarMessage("Searching "+e.refreshQueue.length+" folders for new titles"),cache.saveJson("genius",e),MediaBrowser.processGeniusQueue(e))},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})})},function(){})),2==e&&util.setItem("lastRefresh",(new Date).toISOString())},"gesturePad","Refresh,Maybe Later")}},processGeniusQueue:function(e){if(e.loaded=!0,e.refreshQueue.length>0){var t=e.refreshQueue[e.refreshQueue.length-1];util.setStatusBarMessage("Processing "+t.title);var i=util.getRandomMBServer()+"library?lightData=1&Id="+t.Id;$.ajax({url:i,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(i){var a=!1;i.Data?$.each(i.Data.Children,function(t){var o=i.Data.Children[t],n=o.Id;"Movie"==o.Type&&(e.Titles[n]||e.TitlesQueue[n]||(a=!0,e.TitlesQueue[n]={},$.ajaxq("genuisWorker",{url:util.getRandomMBServer()+"library/?Id="+n+"&lightData=0",dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(t){MediaBrowser.saveGeniusResult(t,e)},error:function(){console.log("error"),delete e.TitlesQueue[n]}})))}):console.log("no data in response."),a===!1&&(util.setStatusBarMessage(t.title+" Completed"),e.refreshQueue.pop(),MediaBrowser.processGeniusQueue(e))},error:function(){console.log("process error")}})}else cordova.require("cordova/plugin/powermanagement").release(function(){},function(){}),util.doHud({show:!1}),util.setStatusBarMessage("All Titles Indexed."),setTimeout(function(){util.setItem("lastRefresh",(new Date).toISOString()),util.setStatusBarForceClear(),MediaBrowserNowPlaying.allItemsPopulated=!1},1500)},saveGeniusResult:function(e,t){var i=e.Data,a=i.Id;t.Titles[a]=i,delete t.TitlesQueue[a];var o=Object.keys(t.TitlesQueue).length;if(0===o%10){cache.saveJson("genius",t);var n="";$.each(t.refreshQueue,function(e){t.refreshQueue[e].Id==i.parentId&&(n=t.refreshQueue[e].title)}),util.setStatusBarMessage("Indexing "+o+" "+n+" Titles"),util.doHud({show:!1}),util.doHud({show:!0,labelText:"Indexing "+o+" "+n+" Titles",detailsLabelText:"Tap to cancel",tappedEvent:function(){util.doHud({show:!1}),t&&(t.refreshQueue=[],t.TitlesQueue=[]),$.ajaxq("genuisWorker")}})}0===o%50&&util.setStatusBarForceClear(),0===o&&(t.refreshQueue.pop(),cache.saveJson("genius",t),MediaBrowser.processGeniusQueue(t))}},mb3={config:{server:"192.168.1.146",port:"8096",userName:"treason",password:"urchin",userID:""},getServiceUrl:function(){return"http://"+mb3.config.server+":"+mb3.config.port},getUserId:function(){return mb3.config.userID
},hashPassword:function(e){function t(e,t){var i=e<<t|e>>>32-t;return i}function i(e){var t,i,a="";for(t=7;t>=0;t--)i=15&e>>>4*t,a+=i.toString(16);return a}function a(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;e.length>i;i++){var a=e.charCodeAt(i);128>a?t+=String.fromCharCode(a):a>127&&2048>a?(t+=String.fromCharCode(192|a>>6),t+=String.fromCharCode(128|63&a)):(t+=String.fromCharCode(224|a>>12),t+=String.fromCharCode(128|63&a>>6),t+=String.fromCharCode(128|63&a))}return t}var o,n,r,s,l,u,d,c,g,h=Array(80),m=1732584193,f=4023233417,w=2562383102,p=271733878,v=3285377520;e=a(e);var b=e.length,T=[];for(n=0;b-3>n;n+=4)r=e.charCodeAt(n)<<24|e.charCodeAt(n+1)<<16|e.charCodeAt(n+2)<<8|e.charCodeAt(n+3),T.push(r);switch(b%4){case 0:n=2147483648;break;case 1:n=8388608|e.charCodeAt(b-1)<<24;break;case 2:n=32768|(e.charCodeAt(b-2)<<24|e.charCodeAt(b-1)<<16);break;case 3:n=128|(e.charCodeAt(b-3)<<24|e.charCodeAt(b-2)<<16|e.charCodeAt(b-1)<<8)}for(T.push(n);14!=T.length%16;)T.push(0);for(T.push(b>>>29),T.push(4294967295&b<<3),o=0;T.length>o;o+=16){for(n=0;16>n;n++)h[n]=T[o+n];for(n=16;79>=n;n++)h[n]=t(h[n-3]^h[n-8]^h[n-14]^h[n-16],1);for(s=m,l=f,u=w,d=p,c=v,n=0;19>=n;n++)g=4294967295&t(s,5)+(l&u|~l&d)+c+h[n]+1518500249,c=d,d=u,u=t(l,30),l=s,s=g;for(n=20;39>=n;n++)g=4294967295&t(s,5)+(l^u^d)+c+h[n]+1859775393,c=d,d=u,u=t(l,30),l=s,s=g;for(n=40;59>=n;n++)g=4294967295&t(s,5)+(l&u|l&d|u&d)+c+h[n]+2400959708,c=d,d=u,u=t(l,30),l=s,s=g;for(n=60;79>=n;n++)g=4294967295&t(s,5)+(l^u^d)+c+h[n]+3395469782,c=d,d=u,u=t(l,30),l=s,s=g;m=4294967295&m+s,f=4294967295&f+l,w=4294967295&w+u,p=4294967295&p+d,v=4294967295&v+c}var y=i(m)+i(f)+i(w)+i(p)+i(v);return y.toLowerCase()},authenticateUser:function(e,t){var i=mb3.getServiceUrl()+"/mediabrowser/Users/AuthenticateByName?format=json";$.ajax({url:i,data:"Username="+e+"&Password="+mb3.hashPassword(t),type:"POST",success:function(e){mb3.config.userID=e.User.Id},error:function(e,t,i){console.log("Auth Error"),console.log(e),console.log(t),console.log(i)}})},lastOpenedCallBack:function(){mb3.createInitialListView()},backButtonCallback:function(){mb3.createInitialListView()},resetCallback:function(){MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.createInitialListView()}},playByID:function(e,t){if(2==e&&DoShuffle(),1==e){var i=util.getMBUrl();i+="ui?command=play&id="+t,$.getJSON(i,function(){setTimeout(function(){ui.queryNowPlaying()},1500)})}},playTitle:function(e,t,i){if(util.isWifi()===!1)return util.doAlert("You are not on Wifi. To play this title, connect to Wifi and try again"),void 0;var a=util.getMBUrl(),o="";if(i)o=$(e).attr("data-guid"),a+="ui?command=play&id="+o,$.getJSON(a,function(){setTimeout(function(){ui.queryNowPlaying()},1500)}),util.doAlert("Now Playing\n"+t);else{var n=window.plugins.actionSheet,r=["Play","Resume","View on Screen"];"1"==$(e).attr("data-imdb")&&r.push("View Imdb Page"),r.push("Cancel"),o=$(e).attr("data-guid");var s="Actions";void 0!==s&&(s=t),n.create({title:s,items:r,destructiveButtonIndex:r.length-1},function(e,t){if(-1!=t&&t!=r.length-1){switch(r[t]){case"Play":a+="ui?command=play&id="+o;break;case"Resume":a+="ui?command=resume&id="+o;break;case"View on Screen":a+="ui?command=navigatetoitem&id="+o;break;case"View Imdb Page":a=""}""!==a?$.getJSON(a,function(){setTimeout(function(){ui.queryNowPlaying()},1500)}):$.ajax({url:util.getMBUrl()+"library/?Id="+o+"&lightData=1",dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(e){if(e.Data.ImdbID){var t=window.plugins.NativeTable;t.hideTable(function(){cb=window.plugins.childBrowser,null!==cb&&(cb.onClose=function(){setTimeout(function(){ui.view.trigger("rightNavButtonTap")},1e3)},cb.showWebPage("http://m.imdb.com/title/"+e.Data.ImdbID))})}else util.doAlert("Sorry, This title does not have an IMBD id")},error:function(){parse&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}})}})}},ShowItems:function(e,t){var i="click";t&&(i=t),mb3.getServiceUrl(),util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var a=function(e){if("StartupFolder"==e.back)return MediaBrowser.createInitialListView(),void 0;var t=[];$.each(e.Items,function(e,i){"Folder"==i.Type||"Season"==i.Type||"Series"==i.Type||"FavoriteFolder"==i.Type?t.push({textLabel:i.Name,detailTextLabel:""+i.RecursiveItemCount+" total, "+i.RecursiveUnplayedItemCount+" not watched, "+i.RecentlyAddedItemCount+" new",icon:"greyarrow",sectionHeader:i.Type,image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:i.Id,type:i.Type,imdb:"0"}):t.push({textLabel:(0===i.UserData.PlayCount?"ï”¹ ":"")+i.Name+(i.ProductionYear?" ("+i.ProductionYear+")":""),detailTextLabel:(i.CommunityRating?i.CommunityRating+"/10 ":"")+(i.Overview?i.Overview:""),icon:"none",sectionHeader:i.Type,image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:i.Id,type:i.Type,imdb:i.ProviderIds.Imdb?"1":"0"})});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:e.Title,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.setRowSelectCallBackFunction(function(e){var a=t[e];if("none"==a.icon){var o=$("<tr data-guid='"+a.guid+"' data-imdb='"+a.imdb+"'></tr>");MediaBrowser.playTitle($(o),a.textLabel,!1)}else i.hideTable(function(){mb3.ShowItems(a)})}),i.onBackButtonTap(function(){i.hideTable(function(){mb3.backButtonCallback()})}),i.setTableData(t),util.doHud({show:!1}),i.showTable(function(){})},o=function(e,t,i){return util.isWifi()===!1&&t?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),void 0):($.ajax({url:e,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(o){null!==o&&(o.Title=i,cache.saveJson(e,o)),t&&a(o)},error:function(){t&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)};if("CustomFolder"==e.type){switch(e.folderType){case"Genres":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfGenres()};break;case"Years":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfYears()};break;case"Actors":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfActors()};break;case"Directors":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfDirectors()};break;case"OfficialRating":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfRating()};break;case"IMDBRating":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfIMDBRating()};break;case"Unwatched":MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfUnwatched()};break;case"Custom TV":MediaBrowser.lastOpenedCallBack=function(){MediaBrowserNowPlaying.buildListView()}}MediaBrowser.lastOpenedCallBack()}else mb3.lastOpenedCallBack=function(){var t=mb3.getServiceUrl()+"/mediabrowser/Users/"+mb3.getUserId()+"/Items?format=json&Fields=Overview,ProviderIds&ParentId="+e.guid;settings.userSettings.moviesByDate&&(t+="&SortBy=DateCreated&SortOrder=Descending"),cache.getJson(t,function(i){null===i?o(t,!0,e.Name):(a(i),o(t,!1,e.Name))})},mb3.backButtonCallback=jQuery.extend(!0,{},mb3.lastOpenedCallBack),mb3.lastOpenedCallBack()},createInitialListView:function(){var e=function(e){var t=[];$.each(e.Items,function(e,i){t.push({textLabel:i.Name,detailTextLabel:""+i.RecursiveItemCount+" total, "+i.RecursiveUnplayedItemCount+" not watched, "+i.RecentlyAddedItemCount+" new",icon:"greyarrow",sectionHeader:"Folders",image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",nomask:!1,guid:i.Id,type:i.Type})}),t.unshift({textLabel:"Custom TV",detailTextLabel:"TV Channels based off your library",icon:"greyarrow",sectionHeader:"Now Playing",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Custom TV"}),t.push({textLabel:"Genres",detailTextLabel:"Movies Separated By Genre",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Genres"}),t.push({textLabel:"Rating",detailTextLabel:"Movies sorted by IMDB Rating",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"IMDBRating"}),t.push({textLabel:"Release Year",detailTextLabel:"Movies Separated By Production Year",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Years"}),t.push({textLabel:"Unwatched",detailTextLabel:"Movies that have not been watched",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Unwatched"}),t.push({textLabel:"Actors",detailTextLabel:"Movie Actors",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Actors"}),t.push({textLabel:"Directors",detailTextLabel:"Movie Directors",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Directors"}),t.push({textLabel:"MPAA Rating",detailTextLabel:"Official rating by the MPAA",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"OfficialRating"});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"Movies",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.setRowSelectCallBackFunction(function(e){var a=t[e];i.hideTable(function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."}),mb3.backButtonCallback=function(){mb3.createInitialListView()},setTimeout(function(){mb3.ShowItems(a)},250)})}),i.setTableData(t),util.doHud({show:!1}),i.showTable(function(){})},t=function(t,i){return util.isWifi()===!1&&i?(util.doAlert("You are not on Wifi and no cached version exists. To do this, connect to Wifi and try again"),mb3.createInitialListView(),void 0):($.ajax({url:t,dataType:"json",timeout:settings.MBServiceTimeout,success:function(a){cache.saveJson(t,a),i&&e(a)},error:function(){i&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)},i=mb3.getServiceUrl()+"/mediabrowser/Users/"+mb3.getUserId()+"/Items?format=json";mb3.lastOpenedCallBack=function(){mb3.createInitialListView()},cache.getJson(i,function(a){null===a?t(i,!0):(e(a),t(i,!1))})},loadGeniusResults:function(e){cache.getJson("genius",function(t){null===t&&(t={refreshQueue:[],Titles:{},TitlesQueue:{},allItems:[],loaded:!1}),e(t)})},toolbarButtonClickEvent:function(e,t){1==e&&(MediaBrowserNowPlaying.allItemsPopulated=!1,t.hideTable(function(){ui.view.trigger("rightNavButtonTap")})),2==e&&gestures.executeGestureByCommandName("VolumeDown"),3==e&&gestures.executeGestureByCommandName("VolumeUp"),4==e&&t.hideTable(function(){util.setDeviceByShortName("DTV"),ui.view.trigger("rightNavButtonTap")}),5==e&&t.hideTable(function(){ui.view.trigger("rightNavButtonTap")})},createCustomTable:function(e,t,i,a){var o=window.plugins.NativeTable;o.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:t,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),o.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,o)}),o.onRightButtonTap(function(){o.hideTable(function(){})}),o.setRowSelectCallBackFunction(function(e){a(e,o)}),o.onBackButtonTap(function(){o.hideTable(function(){i()})}),o.setTableData(e),util.doHud({show:!1}),o.showTable(function(){})},showListOfYears:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){""!==a.ProductionYear&&null!==a.ProductionYear&&-1==jQuery.inArray(a.ProductionYear,t)&&(t.push(a.ProductionYear),e.push({textLabel:""+a.ProductionYear,detailTextLabel:"Movies Released in "+a.ProductionYear,icon:"greyarrow",sectionHeader:"Movies By Year",type:"CustomFolder",folderType:"Years"}))}),t=null,0===e.length?(util.doAlert("No Years found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("-textLabel")),MediaBrowser.createCustomTable(e,"Years",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByYear(a.textLabel)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByYear(a.textLabel)}}),void 0)})},showListOfMoviesByYear:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){a.ProductionYear==e&&t.push({textLabel:(0===a.WatchedPercentage?"ï”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",sectionHeader:a.SortName.substring(0,1).toUpperCase(),guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this year."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfYears()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfGenres:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Genres)for(var o=0;a.Genres.length>o;o++)""!==a.Genres[o]&&null!==a.Genres[o]&&-1==jQuery.inArray(a.Genres[o],t)&&(t.push(a.Genres[o]),e.push({textLabel:a.Genres[o],detailTextLabel:""+a.Genres[o]+" movies",icon:"greyarrow",sectionHeader:"Movies By Genre",type:"CustomFolder",folderType:"Genres"}))}),t=null,0===e.length?(util.doAlert("No Genres found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("textLabel")),MediaBrowser.createCustomTable(e,"Genres",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByGenre(a.textLabel)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByGenre(a.textLabel)}}),void 0)})},showListOfMoviesByGenre:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Genres)for(var o=0;a.Genres.length>o;o++)a.Genres[o]==e&&t.push({textLabel:(0===a.WatchedPercentage?"ï”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this genre."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfGenres()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfActors:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Actors)for(var o=0;a.Actors.length>o;o++)if(""!==$.trim(a.Actors[o].Name)&&null!==a.Actors[o].Name&&-1==jQuery.inArray(a.Actors[o].Name,t)){t.push(a.Actors[o].Name);var n=a.Actors[o].Name.split(" ").pop().replace(/[^a-zA-Z 0-9]+/g,"");if(n+=", "+a.Actors[o].Name.split(" ")[0].replace(/[^a-zA-Z 0-9]+/g,""),n.length>4){var r={textLabel:n,detailTextLabel:"",icon:"greyarrow",image:util.getRandomMBServer()+"image/?Id="+a.Actors[o].Person.Id+"&maxwidth=120&maxheight=120",sectionHeader:n.substring(0,1).toUpperCase(),type:"CustomFolder",folderType:"Actors",customSort:n,ActualName:a.Actors[o].Name};a.Actors[o].Person&&""!==a.Actors[o].Person.PrimaryImagePath&&null!==a.Actors[o].Person.PrimaryImagePath&&(r.image=util.getRandomMBServer()+"image/?Path="+encodeURIComponent(a.Actors[o].Person.PrimaryImagePath)+"&maxwidth=120&maxheight=120",r.guid=a.Actors[o].Person.Id),e.push(r)}}}),t=null,0===e.length?(util.doAlert("No Actors found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("customSort")),MediaBrowser.createCustomTable(e,"Actors",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByActor(a.ActualName)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByActor(a.ActualName)}}),void 0)})},showListOfMoviesByActor:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Actors)for(var o=0;a.Actors.length>o;o++)a.Actors[o].Name==e&&t.push({textLabel:(0===a.WatchedPercentage?"ï”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this actor."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfActors()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfDirectors:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Directors)for(var o=0;a.Directors.length>o;o++)if(""!==$.trim(a.Directors[o])&&null!==a.Directors[o]&&-1==jQuery.inArray(a.Directors[o],t)){t.push(a.Directors[o]);var n=a.Directors[o].split(" ").pop().replace(/[^a-zA-Z 0-9]+/g,"");n+=", "+a.Directors[o].split(" ")[0].replace(/[^a-zA-Z 0-9]+/g,""),n.length>4&&e.push({textLabel:n,detailTextLabel:"",icon:"greyarrow",sectionHeader:n.substring(0,1).toUpperCase(),type:"CustomFolder",folderType:"Directors",customSort:n,ActualName:a.Directors[o]})}}),t=null,0===e.length?(util.doAlert("No Directors found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("customSort")),MediaBrowser.createCustomTable(e,"Directors",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByDirector(a.ActualName)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByDirector(a.ActualName)}}),void 0)})},showListOfMoviesByDirector:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(a.Directors)for(var o=0;a.Directors.length>o;o++)a.Directors[o]==e&&t.push({textLabel:(0===a.WatchedPercentage?"ï”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this Director."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfDirectors()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfRating:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){""!==a.OfficialRating&&null!==a.OfficialRating&&-1==jQuery.inArray(a.OfficialRating,t)&&(t.push(a.OfficialRating),e.push({textLabel:""+a.OfficialRating,detailTextLabel:"Movies Rated: "+a.OfficialRating,icon:"greyarrow",sectionHeader:"Movies By MPAA Rating",type:"CustomFolder",folderType:"Rating"}))}),t=null,0===e.length?(util.doAlert("No Ratings found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("textLabel")),MediaBrowser.createCustomTable(e,"Rating",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByRating(a.textLabel)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByRating(a.textLabel)}}),void 0)})},showListOfMoviesByRating:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){a.OfficialRating==e&&t.push({textLabel:(0===a.WatchedPercentage?"ï”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}),0===t.length?(util.doAlert("No movies found for this rating."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e,function(){MediaBrowser.showListOfRating()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfIMDBRating:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(util.isNumeric(a.ImdbRating)&&a.ImdbRating>0){var o=Math.floor(a.ImdbRating);-1==jQuery.inArray(o,t)&&(t.push(o),e.push({textLabel:o+" stars",detailTextLabel:"Movies with greater or equal to "+o+" stars",icon:"greyarrow",sectionHeader:"Movies By Rank",type:"CustomFolder",folderType:"imdbRating",imdbRating:""+o,sortOn:(10>o?"0":"")+o}))}}),t=null,0===e.length?(util.doAlert("No imdb ratings found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("-sortOn")),MediaBrowser.createCustomTable(e,"Rating",function(){MediaBrowser.createInitialListView()},function(t,i){var a=e[t];i.hideTable(function(){MediaBrowser.showListOfMoviesByIMDBRating(a.imdbRating)}),MediaBrowser.lastOpenedCallBack=function(){MediaBrowser.showListOfMoviesByIMDBRating(a.imdbRating)}}),void 0)})},showListOfMoviesByIMDBRating:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];e=parseInt(e,10),MediaBrowser.loadGeniusResults(function(i){return $.each(i.Titles,function(i,a){if(util.isNumeric(a.ImdbRating)&&a.ImdbRating>0){var o=Math.floor(a.ImdbRating);o==e&&t.push({textLabel:(0===a.WatchedPercentage?"ï”¹ ":"")+a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":""),detailTextLabel:(a.ImdbRating?a.ImdbRating+"/10 ":"")+(a.TagLine?a.TagLine:""),icon:"none",sectionHeader:a.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+a.Id+"&maxwidth=120&maxheight=120",guid:a.Id,type:a.Type,imdb:a.ImdbRating>0?"1":"0",sortName:a.SortName})}}),0===t.length?(util.doAlert("No movies found for this rating."),void 0):(t.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(t,e.toString,function(){MediaBrowser.showListOfIMDBRating()},function(e){var i=t[e],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},showListOfUnwatched:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[];MediaBrowser.loadGeniusResults(function(t){return $.each(t.Titles,function(t,i){0===i.WatchedPercentage&&e.push({textLabel:(0===i.WatchedPercentage?"ï”¹ ":"")+i.Name+(i.ProductionYear?" ("+i.ProductionYear+")":""),detailTextLabel:(i.ImdbRating?i.ImdbRating+"/10 ":"")+(i.TagLine?i.TagLine:""),icon:"none",sectionHeader:i.SortName.substring(0,1).toUpperCase(),image:util.getRandomMBServer()+"image/?Id="+i.Id+"&maxwidth=120&maxheight=120",guid:i.Id,type:i.Type,imdb:i.ImdbRating>0?"1":"0",sortName:i.SortName})}),0===e.length?(util.doAlert("No unwatched movies found."),void 0):(e.sort(util.dynamicSort("sortName")),MediaBrowser.createCustomTable(e,"Unwatched",function(){MediaBrowser.createInitialListView()},function(t){var i=e[t],a=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");MediaBrowser.playTitle($(a),i.textLabel,!1)}),void 0)})},startWorker:function(e,t){var i=2880,a=new Date,o=util.getItem("lastRefresh");o=null===o?new Date("2010-01-01T23:44:52.790Z"):new Date(o);var n=(a.getTime()-o.getTime())/6e4,r=!1;if(n>i&&(r=!0),!(e===!0&&r===!1||e===!1&&r===!1)){var s="It's been a while since you last refreshed, \nWould you like to refresh now?";t&&(s="Refresh Now?"),navigator.notification.confirm(s,function(e){1==e&&(util.doHud({show:!0,labelText:"Checking for new media...",detailsLabelText:"Tap to cancel",tappedEvent:function(){util.setStatusBarForceClear(),util.doHud({show:!1}),geniusResults&&(geniusResults.refreshQueue=[],geniusResults.TitlesQueue=[]),$.ajaxq("genuisWorker")}}),cordova.require("cordova/plugin/powermanagement").acquire(function(){MediaBrowser.loadGeniusResults(function(e){e.refreshQueue=[],e.TitlesQueue=[],$.ajaxq("genuisWorker"),util.setStatusBarMessage("Searching for new titles");var t=util.getRandomMBServer()+"library?lightData=1";console.log(t),$.ajax({url:t,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(t){t.Data&&(console.log(t),$.each(t.Data.Children,function(i){var a=t.Data.Children[i];"Folder"==a.Type&&e.refreshQueue.push({Id:a.Id,title:a.Name})}),util.setStatusBarMessage("Searching "+e.refreshQueue.length+" folders for new titles"),cache.saveJson("genius",e),MediaBrowser.processGeniusQueue(e))},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})})},function(){})),2==e&&util.setItem("lastRefresh",(new Date).toISOString())},"gesturePad","Refresh,Maybe Later")}},processGeniusQueue:function(e){if(e.loaded=!0,e.refreshQueue.length>0){var t=e.refreshQueue[e.refreshQueue.length-1];util.setStatusBarMessage("Processing "+t.title);var i=util.getRandomMBServer()+"library?lightData=1&Id="+t.Id;$.ajax({url:i,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(i){var a=!1;i.Data?$.each(i.Data.Children,function(t){var o=i.Data.Children[t],n=o.Id;"Movie"==o.Type&&(e.Titles[n]||e.TitlesQueue[n]||(a=!0,e.TitlesQueue[n]={},$.ajaxq("genuisWorker",{url:util.getRandomMBServer()+"library/?Id="+n+"&lightData=0",dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(t){MediaBrowser.saveGeniusResult(t,e)},error:function(){console.log("error"),delete e.TitlesQueue[n]}})))}):console.log("no data in response."),a===!1&&(util.setStatusBarMessage(t.title+" Completed"),e.refreshQueue.pop(),MediaBrowser.processGeniusQueue(e))},error:function(){console.log("process error")}})}else cordova.require("cordova/plugin/powermanagement").release(function(){},function(){}),util.doHud({show:!1}),util.setStatusBarMessage("All Titles Indexed."),setTimeout(function(){util.setItem("lastRefresh",(new Date).toISOString()),util.setStatusBarForceClear(),MediaBrowserNowPlaying.allItemsPopulated=!1},1500)},saveGeniusResult:function(e,t){var i=e.Data,a=i.Id;t.Titles[a]=i,delete t.TitlesQueue[a];var o=Object.keys(t.TitlesQueue).length;if(0===o%10){cache.saveJson("genius",t);var n="";$.each(t.refreshQueue,function(e){t.refreshQueue[e].Id==i.parentId&&(n=t.refreshQueue[e].title)}),util.setStatusBarMessage("Indexing "+o+" "+n+" Titles"),util.doHud({show:!1}),util.doHud({show:!0,labelText:"Indexing "+o+" "+n+" Titles",detailsLabelText:"Tap to cancel",tappedEvent:function(){util.doHud({show:!1}),t&&(t.refreshQueue=[],t.TitlesQueue=[]),$.ajaxq("genuisWorker")}})}0===o%50&&util.setStatusBarForceClear(),0===o&&(t.refreshQueue.pop(),cache.saveJson("genius",t),MediaBrowser.processGeniusQueue(t))}},NowPlayingChannels=[],geniusResults={},MediaBrowserNowPlaying={xmlChannels:null,allItemsPopulated:!1,seekAttempts:0,generateAllItems:function(){if(MediaBrowserNowPlaying.allItemsPopulated!==!0){util.doHud({show:!1}),util.doHud({show:!0,labelText:"Generating Channels",detailsLabelText:"For first use..."});var e=MediaBrowserNowPlaying.xmlChannels,t=[];NowPlayingChannels.length=0,$(e).find("nowplaying > channel").each(function(e){for(var i=$(this),a=parseInt($(i).attr("items"),10),o=0;a>o;o++){var n={};n.Title=$(i).attr("title"),n.node=$(this),n.idx=e,n.UpNext=[],NowPlayingChannels.push(n)}t.push({AllItems:[]})});var i=MediaBrowserNowPlaying.buildJSRuleSet();MediaBrowser.loadGeniusResults(function(e){$.each(e.Titles,function(e,a){$.each(i,function(e){i[e].match=!1,$.each(i[e].rules,function(t){i[e].rules[t].match=!1,$.each(i[e].rules[t].criteria,function(a){i[e].rules[t].criteria[a].match=!1})})}),$.each(NowPlayingChannels,function(e){var o=NowPlayingChannels[e];if($.each(i[e].rules,function(t){$.each(i[e].rules[t].criteria,function(o){i[e].rules[t].criteria[o].match=MediaBrowserNowPlaying.doesItemMeetRule(a,i[e].rules[t].criteria[o].field,i[e].rules[t].criteria[o].operator,i[e].rules[t].criteria[o].val)})}),$.each(i[e].rules,function(t){var a=!0;$.each(i[e].rules[t].criteria,function(o){i[e].rules[t].criteria[o].match===!1&&(a=!1)}),i[e].rules[t].match=a}),$.each(i[e].rules,function(t){$.each(i[e].rules[t].criteria,function(){i[e].rules[t].match===!0&&(i[e].match=!0)})}),i[e].match===!0){var n="";a.MediaInfo&&a.MediaInfo.Height&&a.MediaInfo.Height>=550&&(n=" [HD]"),a.MediaType&&"Mkv"==a.MediaType&&(n=" [HD]"),t[o.idx].AllItems.push({Id:a.Id,title:a.Name+(a.ProductionYear?" ("+a.ProductionYear+")":"")+n,runtime:MediaBrowserNowPlaying.getRuntime(a)})}})})}),$.each(t,function(e){t[e].AllItems=util.shuffle(t[e].AllItems),t[e].position=-1}),cache.saveJson("NowPlayingMatchingItemsForChannel",t),MediaBrowserNowPlaying.allItemsPopulated=!0}},generateChannels:function(){cache.getJson("NowPlayingMatchingItemsForChannel",function(e){$.each(NowPlayingChannels,function(t){var i=NowPlayingChannels[t];if(i.UpNext=$.grep(i.UpNext,function(e,t){var a=i.UpNext[t];return new Date>a.ends?!1:!0}),0===i.UpNext.length){var a=i.idx,o=e[a].position;o+=1,o+1>e[a].AllItems.length&&(e[a].AllItems=util.shuffle(e[a].AllItems),o=0),e[a].position=o;
var n=e[a].AllItems[o].runtime,r=0;0===i.UpNext.length&&(r=util.randomFromInterval(0,n-10));var s={};s.starts=util.addMinutes(new Date,-1*r),s.ends=util.addMinutes(s.starts,n),s.title=e[a].AllItems[o].title,s.Id=e[a].AllItems[o].Id,i.UpNext.push(s)}}),$.each(NowPlayingChannels,function(t){var i=3,a=NowPlayingChannels[t];if(i>a.UpNext.length)for(var o=a.UpNext.length;i>=o;o++){var n=a.idx,r=e[n].position;r+=1,r+1>e[n].AllItems.length&&(e[n].AllItems=util.shuffle(e[n].AllItems),r=0),e[n].position=r;var s=e[n].AllItems[r].runtime,l=0;0===a.UpNext.length&&(l=util.randomFromInterval(0,s-10));var u={};u.starts=util.addMinutes(new Date,-1*l),u.ends=util.addMinutes(u.starts,s),u.title=e[n].AllItems[r].title,u.Id=e[n].AllItems[r].Id,a.UpNext.push(u)}}),cache.saveJson("NowPlayingMatchingItemsForChannel",e)})},buildListView:function(){if(null===MediaBrowserNowPlaying.xmlChannels)return MediaBrowserNowPlaying.loadChannels(function(){MediaBrowserNowPlaying.buildListView()}),void 0;MediaBrowserNowPlaying.generateAllItems(),MediaBrowserNowPlaying.generateChannels();var e=[];cache.getJson("NowPlayingMatchingItemsForChannel",function(t){$.each(NowPlayingChannels,function(i){var a=NowPlayingChannels[i];if(1>=t[a.idx].AllItems.length||1>=a.UpNext.length)return!0;var o=a.UpNext[0],n=a.UpNext[1],r=""+Math.floor(Math.abs(o.ends-new Date)/1e3/60);e.push({textLabel:o.title,detailTextLabel:"Time Left: "+r+" minutes \nUp Next: "+n.title,icon:"none",image:util.getRandomMBServer()+"image/?Id="+o.Id+"&maxwidth=120&maxheight=120",sectionHeader:a.Title,guid:o.Id,imdb:"",sortName:"",ends:o.ends})});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"Now Playing",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){MediaBrowser.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.onBackButtonTap(function(){i.hideTable(function(){MediaBrowser.createInitialListView()})}),i.setRowSelectCallBackFunction(function(t){var i=Date.parse(e[t].ends);util.doHud({show:!0,labelText:"Playing Title...",detailsLabelText:"Tap to cancel",tappedEvent:function(){MediaBrowserNowPlaying.seekAttempts=99,util.doHud({show:!1})}});var a=util.getMBUrl();a+="ui?command=play&id="+e[t].guid,$.getJSON(a,function(){setTimeout(function(){MediaBrowserNowPlaying.seekAttempts=0,MediaBrowserNowPlaying.doSeek(i)},1500)})}),i.setTableData(e),util.doHud({show:!1}),i.showTable(function(){})})},getRuntime:function(e){var t=0;try{e.MediaInfo&&e.MediaInfo.RunTime&&util.isNumeric(e.MediaInfo.RunTime)&&e.MediaInfo.RunTime>10&&(t=e.MediaInfo.RunTime)}catch(i){t=0}return t},compareArrayOfString:function(e,t,a){var o=!1;switch(t){case"equals":for(i=0;e.length>i;i++)e[i]===a&&(o=!0);break;case"first":e.length>=1&&e[0]===a&&(o=!0);break;case"contains":for(i=0;e.length>i;i++)e[i].indexOf(a)>-1&&(o=!0);break;case"not":var n=!1;for(i=0;e.length>i;i++)e[i]==a&&(n=!0);n===!1&&(o=!0);break;default:o=!1}return o},compareIntegers:function(e,t,i){var a=!1;switch(i=parseFloat(i,10),e=parseFloat(e,10),t){case"equals":e===i&&(a=!0);break;case"greaterthan":e>=i&&(a=!0);break;case"lessthan":i>=e&&(a=!0);break;default:a=!1}return a},compareStrings:function(e,t,i){var a=!1;switch(i=i.toLowerCase(),e=e.toLowerCase(),t){case"equals":i===e&&(a=!0);break;case"not":i!==e&&(a=!0);break;case"contains":e.indexOf(i)>-1&&(a=!0);break;case"notcontains":-1===e.indexOf(i)&&(a=!0);break;default:a=!1}return a},doesItemMeetRule:function(e,t,a,o){var n=!1;if(0===MediaBrowserNowPlaying.getRuntime(e))return!1;switch(t){case"Genre":e.Genres&&(n=MediaBrowserNowPlaying.compareArrayOfString(e.Genres,a,o));break;case"Actor":if(e.Actors){var r=[];for(i=0;e.Actors.length>i;i++)r.push(e.Actors[i].Name);n=MediaBrowserNowPlaying.compareArrayOfString(r,a,o)}break;case"Director":e.Directors&&(n=MediaBrowserNowPlaying.compareArrayOfString(e.Directors,a,o));break;case"Studios":e.Studios&&(n=MediaBrowserNowPlaying.compareArrayOfString(e.Studios,a,o));break;case"Rating":e.ImdbRating&&(n=MediaBrowserNowPlaying.compareIntegers(e.ImdbRating,a,o));break;case"ProductionYearAge":if(e.ProductionYear&&4===(""+e.ProductionYear).length){var s=(new Date).getFullYear()-e.ProductionYear;n=MediaBrowserNowPlaying.compareIntegers(s,a,o)}break;case"ProductionYear":e.ProductionYear&&(n=MediaBrowserNowPlaying.compareIntegers(e.ProductionYear,a,o));break;case"FileDateAge":if(e.DateCreated){var l=Date.parse(e.DateCreated);if(!isNaN(l)){var u=(new Date-l)/864e5;n=MediaBrowserNowPlaying.compareIntegers(u,a,o)}}break;case"Folder":e.Path&&(e.Path.lastIndexOf("\\")>0?n=MediaBrowserNowPlaying.compareStrings(e.Path.substring(0,e.Path.lastIndexOf("\\")),a,o):e.Path.lastIndexOf("/")>0&&(n=MediaBrowserNowPlaying.compareStrings(e.Path.substring(0,e.Path.lastIndexOf("/")),a,o)));break;default:n=!1}return n},buildJSRuleSet:function(){var e=[];return $.each(NowPlayingChannels,function(t){var i=NowPlayingChannels[t];e.push({match:!1,rules:[]}),$(i.node).find("ruleSet").each(function(){var i={criteria:[],match:!1};$(this).find("rule").each(function(){var e={};e.field=$(this).attr("field"),e.val=$(this).find("value:first").text(),e.operator=$(this).find("compare:first").text(),e.match=!1,i.criteria.push(e)}),e[t].rules.push(i)})}),e},loadChannels:function(e){var t="xml/nowplaying.xml?r="+Math.random();$.ajax({type:"GET",url:t,dataType:"xml",success:function(t){MediaBrowserNowPlaying.xmlChannels=t,e()},error:function(){}})},doSeek:function(e){$.ajax({url:util.getMBUrl()+"ui",dataType:"json",timeout:1e4,success:function(t){if(t.Data.PlayingControllers.length>=1){$("#timespanright").attr("data-duration",t.Data.PlayingControllers[0].CurrentFileDuration.Ticks),$("#timespanright").attr("data-controller",t.Data.PlayingControllers[0].ControllerName),$("#NowPlayingTitle").text(t.Data.PlayingControllers[0].PlayableItems[0].DisplayName);var i=t.Data.PlayingControllers[0].CurrentFileDuration.TotalSeconds,a=t.Data.PlayingControllers[0].CurrentFileDuration.Ticks,o=i-Math.abs(e-new Date)/1e3,n=o/i,r=Math.floor(n*a),s=t.Data.PlayingControllers[0].CurrentFilePosition.Ticks/a;if(isNaN(n))return setTimeout(function(){MediaBrowserNowPlaying.doSeek(e)},1500),void 0;.03>Math.abs(n-s)?(ui.queryNowPlaying(),util.doHud({show:!1}),MediaBrowserNowPlaying.seekAttempts=0):(sliders.sendSeekEvent(r),setTimeout(function(){3>MediaBrowserNowPlaying.seekAttempts&&MediaBrowserNowPlaying.doSeek(e),MediaBrowserNowPlaying.seekAttempts+=1},1500))}}})}},bottomDraw={bind:function(){var e=null;$("#boxCoverContainer").bind("scroll",function(){clearTimeout(e),e=setTimeout(function(){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=$(this).width();$("#covers > div.pendingImg").each(function(){var e=$(this).offset().left,i=$(this).width(),a=!1;if(a=0>e+i?!1:e>t?!1:!0,a===!0){$(this).removeClass("pendingImg");var o=$(this).find("img"),n=$(o).attr("data-guid"),r=$(o).attr("data-prefix"),s="MB_Small_"+n;$(o).onerror=function(){$(this).attr("src","img/nobox.png")},cache.getImage({id:s,url:r+n+"&maxwidth=120&maxheight=120"},function(e){var t=new Image;t.onerror=function(){$(o).attr("src","img/nobox.png")},e.cached===!1?(t.onload=function(){cache.saveImage({id:s,img:t}),$(o).attr("src",e.url)},t.src=e.url):$(o).attr("src",e.url)})}})}},200)}),$("#boxCoverContainer").bind("touchmove touchend",function(){window.scrollTo(0,0)}),$("#boxCoverBack").fastClick(function(){if(""!==$("#covers").data("back"))if("ChannelHome"==$("#covers").data("back"))bottomDraw.showBottomItems();else{var e=$("<a data-guid='"+$("#covers").data("back")+"' data-type='Folder' data-backwards='1' />");bottomDraw.showBottomItems(e)}}),$("#bottomGrabberKILL").bind("touchstart",function(e){var t=window.plugins.volumeSlider;t.hideVolumeSlider(1),e.originalEvent.touches[0].screenY,$(this).data("lastY",e.originalEvent.touches[0].screenY)}),$("#bottomGrabberKILL").bind("touchmove",function(e){e.stopImmediatePropagation(),e.preventDefault();var t=e.originalEvent.targetTouches[0],i=parseInt($(this).data("lastY"),10),a=parseInt($("#bottom").css("bottom"),10),o=140,n=0,r=-140;$(this).data("lastY",t.pageY),t.screenY>i?(n=a-(t.pageY-i),o>=n&&n>=0&&($("#bottom").css("bottom",n+"px"),$("#browser").css("bottom",r+n+"px"))):(n=a+(i-t.pageY),o>=n&&n>=0&&($("#bottom").css("bottom",n+"px"),$("#browser").css("bottom",r+n+"px")))}),$("#bottomGrabberKILL").bind("touchend",function(){sliders.resize(),setTimeout(function(){bottomDraw.refreshBottomDrawer()},100),setTimeout(function(){var e=window.plugins.volumeSlider;e.showVolumeSlider(1)},250)})},showBottomItems:function(e,t){var i="click";t&&(i=t);var a=util.getCurrentDevice(),o=70,n=!1,r={startCoverOpacity:.25,startCoverTop:"140px",endCoverOpacity:1,endCoverTop:"24px"};if("MCE"==a.shortname){var s=util.getMBUrl();if(e){if("Movie"==$(e).attr("data-type")||"Episode"==$(e).attr("data-type"))return"taphold"==i?MediaBrowser.playTitle($(e),$(e).parent().find("p").text(),!1):MediaBrowser.playTitle($(e),$(e).parent().find("p").text(),!0),void 0;$(e).hasAttr("data-backwards")&&(n=!0)}n&&(r={startCoverOpacity:.25,startCoverTop:"-164px",endCoverOpacity:1,endCoverTop:"24px"}),$("#covers").animate({opacity:r.startCoverOpacity,"margin-top":r.startCoverTop},250,function(){$("#covers").css("margin-top","24px").width($(window).width()),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>Loading Data...</p></div>").css("opacity","1").hide().fadeIn();var t=function(e){var t='<div style="width: 40px; height: 100%; float:left"> </div>';$("#covers").width(e.Data.Children.length*o+50),settings.moviesByDate&&"Folder"==e.Data.Type&&e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),!settings.userSettings.tvByDate||"Season"!=e.Data.Type&&"Series"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),$.each(e.Data.Children,function(i){t+='<div class="smallboxContainer pendingImg" >',e.Data.Children[i].IsFolder===!0&&e.Data.Children[i].RecentlyAddedUnplayedItemCount>0&&(t+='<div class="badge" >'+e.Data.Children[i].RecentlyAddedUnplayedItemCount+"</div>"),t+='<img data-prefix="'+util.getMBUrl()+"image/?Id="+'" data-guid="'+e.Data.Children[i].Id+'" data-type="'+e.Data.Children[i].Type+'" class="smallBox" src="img/nobox.png"  data-imdb="'+(e.Data.Children[i].ImdbRating>0?"1":"0")+'" />',t+="<p>"+e.Data.Children[i].Name+"</p>",t+="</div>"});var i=$("<div>"+t+"</div>");$(i).find("div.pendingImg").each(function(e){if(e>100)return!1;var t=$(this).find("img"),i=$(t).attr("data-guid"),a=$(t).attr("data-prefix"),o="MB_Small_"+i;$(t).onerror=function(){$(this).attr("src","img/nobox.png")},cache.getImage({id:o,url:a+i+"&maxwidth=120&maxheight=120"},function(e){var i=new Image;i.onerror=function(){$(t).attr("src","img/nobox.png")},e.cached&&($(t).attr("src",e.url),$(this).removeClass("pendingImg"))})}),$("#covers").css("margin-top","-130px").css("opacity","0.25"),$("#covers").empty().append($(i).children()),$("#covers img").each(function(){var e=$(this).attr("data-type");"Movie"==e||"Episode"==e?($(this).longclick(function(e){bottomDraw.showBottomItems(e.currentTarget,"taphold")},750),$(this).bind("click",function(){bottomDraw.showBottomItems($(this))})):$(this).bind("click",function(){$("#boxCoverBack").data("scrollPosition",$("#boxCoverContainer").scrollLeft()),bottomDraw.showBottomItems($(this))})}),$("#covers").animate({opacity:r.endCoverOpacity,"margin-top":r.endCoverTop},250,function(){$("#boxCoverBack").data("scrollPosition")&&n&&$("#boxCoverContainer").animate({scrollLeft:parseInt($("#boxCoverBack").data("scrollPosition"),10)},500),$("#boxCoverContainer").trigger("scroll");var t=e.Data.Name;"StartupFolder"==t?(t="Startup Folder",$("#covers").data("back","")):$("#covers").data("back",e.Data.parentId),$("#covers").data("loaded",!0),$("#bottomText > span:first").animate({opacity:0,"margin-left":"-100px"},250,function(){$("#bottomText > span:first").text(t),$("#bottomText > span:first").animate({opacity:1,"margin-left":"0px"},250)})})},i=function(e,i){return util.isWifi()===!1&&i?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>No data found.</p></div>"),void 0):($.ajax({url:e,dataType:"json",timeout:settings.MBServiceTimeout,success:function(a){cache.saveJson(e,a),i&&t(a)},error:function(){i&&(util.doAlert("The server is not responding in time, and no cached version exists. Try again later"),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>No data found.</p></div>"))}}),void 0)};s+=e?"library/?lightData=1&Id="+$(e).attr("data-guid"):"library/",cache.getJson(s,function(e){null===e?i(s,!0):(t(e),i(s,!1))})})}if("DTV"==a.shortname){if(e){if("Movie"==$(e).attr("data-type")||"Episode"==$(e).attr("data-type"))return MediaBrowser.playTitle($(e),$(e).parent().find("p").text()),void 0;$(e).hasAttr("data-backwards")&&(n=!0)}r={startCoverOpacity:.25,startCoverTop:"140px",endCoverOpacity:1,endCoverTop:"24px"},n&&(r={startCoverOpacity:.25,startCoverTop:"-164px",endCoverOpacity:1,endCoverTop:"24px"}),$("#covers").animate({opacity:r.startCoverOpacity,"margin-top":r.startCoverTop},250,function(){$("#covers").css("margin-top","24px").width($(window).width()),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>Loading Data...</p></div>").css("opacity","1").hide().fadeIn();var t='<div style="width: 40px; height: 100%; float:left"> </div>';if(e){var i=$(e).attr("data-category"),a=0;$.each(guide.channels,function(e,o){o.category==i&&(t+='<div class="smallboxContainer" >',t+='<div class="channelContainer"><div data-minor="'+o.number+'" class="smallChannel" style="background-image: url('+o.logo+')" ></div></div>',t+="<p>"+o.fullname+"</p>",t+="</div>",a++)}),$("#covers").width(a*o+50)}else{var s=[];$.each(guide.channels,function(e,t){var i={category:t.category,logo:t.logo,name:t.fullname},a=!1;$.each(s,function(e,i){return i.category==t.category?(a=!0,!1):void 0}),a===!1&&s.push(i)}),$.each(s,function(e,i){t+='<div class="smallboxContainer" >',t+='<div class="channelContainer"><div data-category="'+i.category+'" class="smallChannel" style="background-image: url('+i.logo+')" ></div></div>',t+="<p>"+i.category+"</p>",t+="</div>"}),$("#covers").width(s.length*o+50)}var l=$("<div>"+t+"</div>");$("#covers").css("margin-top","-130px").css("opacity","0.25"),$("#covers").empty().append($(l).children()),$("#covers div.smallChannel").fastClick(function(){$(this).hasAttr("data-category")?($("#boxCoverBack").data("scrollPosition",$("#boxCoverContainer").scrollLeft()),bottomDraw.showBottomItems($(this))):DirecTV.changeChannel($(this).attr("data-minor"))}),$("#covers").animate({opacity:r.endCoverOpacity,"margin-top":r.endCoverTop},250,function(){$("#boxCoverBack").data("scrollPosition")&&n&&$("#boxCoverContainer").animate({scrollLeft:parseInt($("#boxCoverBack").data("scrollPosition"),10)},500);var t="Categories";e?($("#covers").data("back","ChannelHome"),t=$(e).attr("data-category")):$("#covers").data("back",""),$("#covers").data("loaded",!0),$("#bottomText > span:first").animate({opacity:0,"margin-left":"-100px"},250,function(){$("#bottomText > span:first").text(t),$("#bottomText > span:first").animate({opacity:1,"margin-left":"0px"},250)})})})}},refreshBottomDrawer:function(){var e=140,t=parseInt($("#bottom").css("bottom"),10);t>e/3?($("#bottom").animate({bottom:"140px"},{duration:200,queue:!1}),$("#browser").animate({bottom:"-1px"},{duration:200,queue:!1,complete:function(){""!==$("#covers").data("back")&&void 0!==$("#covers").data("back")||$("#covers").data("loaded")!==!1&&void 0!==$("#covers").data("loaded")||bottomDraw.showBottomItems()}})):($("#bottom").animate({bottom:"0px"},{duration:200,queue:!1}),$("#browser").animate({bottom:"-140px"},{duration:200,queue:!1,complete:function(){(""===$("#covers").data("back")||void 0===$("#covers").data("back"))&&($("#covers").data("loaded",!1),$("#bottomText span").html("&nbsp;"),$("#covers").html("&nbsp;"))}}))},updateBottomContents:function(){$("#covers").data("back",""),$("#covers").data("loaded",!1),$("#bottomText span").html("&nbsp;"),$("#covers").html("&nbsp;"),bottomDraw.refreshBottomDrawer()}},cache={clear:function(e){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(t){var a=t.root.createReader();a.readEntries(function(t){for(i=0;t.length>i;i++){var a=t[i].name.split(".").pop();a===e&&"NowPlayingMatchingItemsForChannel.json"!==t[i].name&&t[i].remove(null,null)}},function(){})},function(){console.log("Pull cache Error, no access to file system"),callback({cached:!1,url:request.url})})},getImage:function(e,t){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(i){i.root.getFile(e.id+".cache",{create:!1,exclusive:!1},function(i){i.file(function(e){var i=new FileReader;i.onloadend=function(e){t({cached:!0,url:""+e.target.result})},i.readAsText(e)},function(){console.log("Error reading Cached File"),t({cached:!1,url:e.url})})},function(){t({cached:!1,url:e.url})})},function(){console.log("Pull cache Error, no access to file system"),t({cached:!1,url:e.url})})},saveImage:function(e){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(t){t.root.getFile(e.id+".cache",{create:!0,exclusive:!1},function(t){t.createWriter(function(t){t.onwriteend=function(){},t.write(cache.getBase64Image(e.img))},function(){console.log("Write to Cache Error")})},function(){console.log("Error initiating cached file")})},function(){console.log("Save cache Error, no access to file system")})},getBase64Image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");i.drawImage(e,0,0);var a=t.toDataURL("image/png");return a},getJson:function(e,t){var i=e.replace("http://","");i=i.substring(i.indexOf("/")+1),i=i.replace(/\//g,"-"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getFile(i+".json",{create:!1,exclusive:!1},function(e){e.file(function(e){var i=new FileReader;i.onloadend=function(e){t(jQuery.parseJSON(""+e.target.result))},i.readAsText(e)},function(){console.log("Error reading Cached File"),t(null)})},function(){t(null)})},function(){console.log("Pull cache Error, no access to file system"),t(null)})},saveJson:function(e,t){if(null!==t){var i=e.replace("http://","");i=i.substring(i.indexOf("/")+1),i=i.replace(/\//g,"-"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getFile(i+".json",{create:!0,exclusive:!1,append:!1},function(e){e.createWriter(function(e){e.onwriteend=function(){},e.write(JSON.stringify(t))},function(){console.log("Write to Cache Error")})},function(){console.log("Error initiating cached json file")})},function(){console.log("Save cache Error, no access to file system")})}}},gestures={executeGestureByCommandName:function(e){var t=util.getCurrentRoom(),i=util.getCurrentDevice(),a=$(xml).find("gesturePad > rooms > room[index='"+t.index+"'] ~ roomgestures > gesture > device > command > name:contains('"+e+"'):first");if($(a).size()>0){var o=$(a).parent().parent().attr("shortname");$(xml).find("gesturePad > devices > device[shortname='"+o+"'] > commands > category > command > name:contains('"+e+"'):first").each(function(){actionNodes=$(this).parent().find("action"),i=util.getDeviceByShortName(o),gestures.doEvent("manual",actionNodes,i)})}else{var n=$(xml).find("gesturePad > devices > device[shortname='"+i.shortname+"'] > commands > category > command > name:contains('"+e+"'):first");1==$(n).size()&&(actionNodes=$(n).next(),gestures.doEvent("manual",actionNodes,i))}},doEvent:function(e,t,i){if(window.scrollTo(0,0),util.isWifi()===!1)return util.doAlert("You are not on Wifi. Connect to Wifi and try again"),void 0;util.clearCallers(!1);var a=util.getCurrentRoom(),o=util.getCurrentDevice();i!==void 0&&(o=i);var n=!0,r=!1,s=null;if("manual"!=e?($(xml).find("gesturePad > rooms > room[index='"+a.index+"'] ~ roomgestures > gesture[definition='"+e+"'] > device:first").each(function(){var e=$(this).attr("shortname"),t=$(this).find("command > name").text();$(xml).find("gesturePad > devices > device[shortname='"+e+"'] > commands > category > command > name:contains('"+t+"'):first").each(function(){r=!0,n=!0,s=$(this).parent().find("action"),o=util.getDeviceByShortName(e)})}),r===!1&&$(xml).find("gesturePad > devices > device[shortname='"+o.shortname+"'] > commands > category > command > gesture[definition='"+e+"']:first").each(function(){n=!0,s=$(this).parent().find("action")})):s=$(t),null===s&&(n=!1),n){util.playBeep();var l=$(s).parent().find("name:first").text();util.showNotification(l,e);var u=$(s).size()-1;$(s).each(function(e){var t=$(s),i="http://"+o.IPAddress+":"+o.Port+"/";$(this).find("addtobaseurl:first").each(function(){i+=$(this).text()}),$(this).find("replacebaseurl:first").each(function(){i=$(this).text()}),-1===i.indexOf(":8080")&&(appendOncetoQueryString+="&room="+a.name),$.ajax({type:$(this).find("method:first").text(),url:i,data:$(this).find("data:first").text()+appendOncetoQueryString,timeout:15e3,dataType:$(this).find("dataType:first").text(),success:function(){appendOncetoQueryString="",e==u&&$(t).find("onCompleteSetDevice").size()>0&&(util.setDeviceByShortName($(t).find("onCompleteSetDevice").attr("shortname")),util.updateStatus()),("Stop"==l||l.indexOf("channel")>-1)&&ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},1500)},error:function(){appendOncetoQueryString="",e==u&&(util.showNotification(l,"âŒ No response from server"),$(t).find("onCompleteSetDevice").size()>0&&(util.setDeviceByShortName($(t).find("onCompleteSetDevice").attr("shortname")),util.updateStatus()))}})})}else util.showNotification("Unassigned","Gesture doesnt exist")}},xml,appSettings,appendOncetoQueryString="",npTimer,inputTimer,clickEventType,guide={},workerTimer=null,scrollstop=null,init={PhoneGapReady:function(){document.addEventListener("deviceready",init.onDeviceReady,!1),document.addEventListener("resume",init.onResume,!1),document.addEventListener("pause",init.onBackground,!1),window.onorientationchange=util.detectOrientation,window.onresize=util.detectOrientation,window.onerror=function(e,t,i){console.log("\n\n"+e+"\n"+t+"\nline "+i+"\n\n\n")}},onDeviceReady:function(){util.splash("show"),$.gestures.init(),$.gestures.retGesture(function(e){gestures.doEvent(e)}),ui.initiateBindings(),util.doResize(),notify.init(),notify.clearAllBadges(),settings.loadSettings(),settings.userSettings.isSetup!==!1&&(DirecTV.hasDirecTV()&&DirecTV.loadChannelList(),util.splash("hide"),npTimer=setInterval(function(){ui.queryNowPlaying(),util.getRoomStatus()},3e4),mb3.authenticateUser("treason","urchin"),window.scrollTo(0,0),util.checkForYouTubeLink())},onResume:function(){settings.checkSettingsForUpdate(),settings.userSettings.isSetup!==!1&&(util.getRoomStatus(),DirecTV.startWorker(),ui.queryNowPlaying(),util.checkForYouTubeLink())},onBackground:function(){},loadXML:function(){var e=settings.userSettings.configURL+"?r="+Math.random();$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){xml=e,util.setItem("configURL",settings.userSettings.configURL)},error:function(){util.doAlert("Fatal error loading xml settings: "+e)}})}},notify={init:function(){var e=window.plugins.pushNotification;e.registerDevice({alert:!0,badge:!0,sound:!1},function(e){console.log("registerDevice: "+e.deviceToken)})},clearAllBadges:function(){var e=window.plugins.pushNotification;e.setApplicationIconBadgeNumber(0,function(){}),e.cancelAllLocalNotifications(function(){})}},settings={userSettings:{},loadSettings:function(){return settings.userSettings=settings.getSettingsObject(),settings.userSettings.isSetup===!1?!1:(settings.userSettings.deviceIndex=util.getItem("deviceIndex",0),settings.userSettings.roomIndex=util.getItem("roomIndex",0),(util.isNumeric(settings.userSettings.roomIndex)===!1||util.isNumeric(settings.userSettings.deviceIndex)===!1)&&(util.setItem("roomIndex",0),util.setItem("deviceIndex",0),settings.userSettings.roomIndex=0,settings.userSettings.deviceIndex=0),util.setItem("configURL",""),util.getItem("configURL","")!=settings.userSettings.configURL&&init.loadXML(),util.updateStatus(),util.getRoomStatus(),void 0)},getSettingsObject:function(){var e={sounds:!1,vibrate:!1,wifi:!0,SleepThreshold:6e4,MBServiceTimeout:12e4,moviesByDate:!1,tvByDate:!1,configURL:"mbeg.xml",roomIndex:0,deviceIndex:0,isSetup:!0,rooms:[]};return window.plugins.applicationPreferences.get("All",function(t){var i=!1;appSettings=t;var a=jQuery.parseJSON(t);1==a.sounds&&(e.sounds=!0),1==a.vibrate&&(e.vibrate=!0),e.wifi=1==a.wifi?!0:!1,1==a.dateMovies&&(e.moviesByDate=!0),1==a.dateTV&&(e.tvByDate=!0),1==a.config_source?e.configURL="mbeg.xml":2==a.config_source?e.configURL="mbegdt.xml":3==a.config_source&&(e.configURL=a.custom_config);for(var o=1;5>=o;o++)if(a["S"+o+"_enabled"]&&1==a["S"+o+"_enabled"]){i=!0;var n={name:"Room "+o,index:o-1,DTV:null,IR:!1,devices:[]};n.name=a["S"+o+"_RoomName"],n.devices.push({name:"Movies",shortname:"MCE",IPAddress:a["S"+o+"_IP"],Port:a["S"+o+"_EGPort"],ServicePort:a["S"+o+"_MBPort"],timeshift:!0,index:0}),1==a["S"+o+"_DTV"]&&(n.DTV=a["S"+o+"_DTVIP"],n.devices.push({name:"Television",shortname:"DTV",IPAddress:a["S"+o+"_DTVIP"],Port:8080,timeshift:!1,index:1})),1==a["S"+o+"_EG"]&&(n.IR=!0),e.rooms.push(n)}i===!1&&(e.isSetup=!1,util.doAlert("No Servers are defined. Go to settings to add a server."),util.splash("hide")),e.roomIndex=util.getItem("roomIndex",0),e.deviceIndex=util.getItem("deviceIndex",0)}),e},checkSettingsForUpdate:function(){window.plugins.applicationPreferences.get("All",function(e){e!=appSettings&&(util.doAlert("Your settings have changed. Quit the app from the app switcher to reload."),util.reloadPage())})}},sliders={sendVolumeChange:function(e,t){appendOncetoQueryString="&"+e,gestures.executeGestureByCommandName(t)},sendSeekEvent:function(e){var t=util.getCurrentDevice();if("MCE"==t.shortname){var i=util.getMBUrl()+"ui?command=seek&value="+e+"&controllerName="+ui.nowPlaying.controller;$.getJSON(i,function(){setTimeout(function(){ui.queryNowPlaying()},1500)})}}},ui={screenShotMode:!1,nowPlaying:{url:"",navTitle:"gesturePad",navSubTitle:"",duration:0},initiateBindings:function(){ui.view=window.plugins.GestureView,ui.view.create(),$("body").bind("touchmove",function(e){e.preventDefault()}),ui.bindButtons()},bindButtons:function(){ui.view.bind("rightNavButtonTap",function(){window.scrollTo(0,0),util.getCurrentRoom();var e=util.getCurrentDevice();if("DTV"==e.shortname){var t=[],i=0;$.each(guide.channels,function(e,a){var o="";a.ending>0&&(o=new Date(1e3*a.ending).timeNow());var n={textLabel:""===a.nowplaying?a.fullname:a.nowplaying,detailTextLabel:a.number+" "+a.fullname+(""===o?"":", ends at "+o),icon:"none",sectionHeader:a.category,major:a.number};""!==a.logo&&(n.image="www/"+a.logo),DirecTV.recentChannels.length>0&&a.number==DirecTV.recentChannels[0]&&(i=e),t.push(n)});var a=window.plugins.NativeTable;a.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"TV",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1,showToolBar:!0}),a.onToolbarButtonClick(function(e){if(1==e){var t=DirecTV.recentChannels.slice(1,5),i=[];if($.each(t,function(e,t){i.push(DirecTV.getTitleForChannel(t))}),i.length>=1){var o=window.plugins.actionSheet;i.push("Cancel"),o.create({title:"Recent Channels",items:i,destructiveButtonIndex:i.length-1},function(e,a){-1!=a&&a!=i.length-1&&DirecTV.changeChannel(t[a])})}}2==e&&gestures.executeGestureByCommandName("VolumeDown"),3==e&&gestures.executeGestureByCommandName("VolumeUp"),4==e&&a.hideTable(function(){util.setDeviceByShortName("MCE"),ui.view.trigger("rightNavButtonTap")}),5==e&&a.hideTable(function(){ui.view.trigger("rightNavButtonTap")})}),a.onRightButtonTap(function(){a.hideTable(function(){})}),a.setRowSelectCallBackFunction(function(e){var i=t[e];DirecTV.changeChannel(i.major)}),a.setTableData(t),a.showTable(function(){a.scrollTo({index:i})})}"MCE"==e.shortname&&(util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."}),setTimeout(function(){mb3.lastOpenedCallBack()},200))}),ui.view.bind("leftNavButtonTap",function(){var e=[],t=util.getCurrentRoom(),i=util.getCurrentDevice(),a="",o=$(xml).find('gesturePad > rooms > room[index="'+t.index+'"] ~ roomgestures > gesture > device');if($(o).size()>0){a="Global Commands";var n=[];$(o).each(function(){var i=$(this);$(this).children("name:first").text(),t.name,$(i).find("command").each(function(){var t=$(this).children("name:first").text(),o="";o=$(i).parent().attr("definition"),"nothing"==o&&(o=""),-1==jQuery.inArray(t,n)&&(n.push(t),e.push({textLabel:t,detailTextLabel:""===o?"No Gesture Defined":"ðŸ‘† "+o,icon:"greyarrow",sectionHeader:a}))})})}$(xml).find('gesturePad > devices > device[shortname="'+i.shortname+'"]').each(function(){var i=$(this);$(this).children("name:first").text(),t.name,$(i).find("command").each(function(){$(this).find("action");var t="",i=$(this).children("name:first").text();$(this).find("gesture").each(function(e){0===e&&(t="",t=$(this).attr("definition"))}),a!=$(this).parent().children("name:first").text()&&(a=$(this).parent().children("name:first").text()),e.push({textLabel:i,detailTextLabel:""===t?"No Gesture Defined":"ðŸ‘† "+t,icon:"greyarrow",sectionHeader:a})})});var r=window.plugins.NativeTable;r.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:t.name,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1}),r.onRightButtonTap(function(){r.hideTable(function(){})}),r.onBackButtonTap(function(){r.hideTable(function(){})}),r.setRowSelectCallBackFunction(function(t){gestures.executeGestureByCommandName(e[t].textLabel)}),r.setTableData(e),r.showTable(function(){})}),ui.view.bind("configButtonTap",function(){var e=window.plugins.actionSheet,t=[];t.push("Clear Item Cache"),t.push("Clear Image Cache"),t.push("Refresh All Items"),t.push("Refresh Custom TV"),t.push("Play URL"),t.push("Cancel"),e.create({title:"Actions",items:t,destructiveButtonIndex:t.length-1},function(e,i){if(-1!=i&&i!=t.length-1)switch(i){case 0:cache.clear("json"),util.setItem("lastRefresh","2010-01-01T23:44:52.790Z"),util.doAlert("All Items Cleared");break;case 1:cache.clear("cache"),util.doAlert("All Images Cleared");break;case 2:util.setItem("lastRefresh","2010-01-01T23:44:52.790Z"),MediaBrowser.startWorker(!0,!0);break;case 3:MediaBrowserNowPlaying.allItemsPopulated=!1,util.doAlert("Custom TV Cleared");break;case 4:util.lastYouTubeURL="",util.setItem("lastYouTubeURL",""),util.checkForYouTubeLink()}})}),ui.view.bind("roomButtonTap",function(){for(var e=function(e){MediaBrowser.resetCallback(),settings.userSettings.roomIndex=e,settings.userSettings.deviceIndex=0,util.updateStatus(),util.getRoomStatus()},t=window.plugins.actionSheet,i=[],a=settings.userSettings.rooms,o=0;a.length>o;o++)i.push(a[o].name);i.push("Cancel"),t.create({title:"Change Room",items:i,destructiveButtonIndex:i.length-1},function(t,a){-1!=a&&a!=i.length-1&&e(a)})}),ui.view.bind("inputButtonTap",function(){for(var e=function(e){var t=util.getCurrentRoom();settings.userSettings.deviceIndex=e;var i=util.getCurrentDevice(),a=i.shortname;if(t.IR){util.setDeviceByShortName("MCE");var o=$(xml).find('gesturePad > devices > device[shortname="MCE"] > commands > category > command > action > onCompleteSetDevice[shortname="'+a+'"]:first');$(o).size()>0&&gestures.doEvent("manual",$(o).parent())}},t=window.plugins.actionSheet,i=[],a=util.getCurrentRoom().devices,o=0;a.length>o;o++)i.push(a[o].name);i.push("Cancel"),t.create({title:"Switch Input",items:i,destructiveButtonIndex:i.length-1},function(t,a){if(-1!=a&&a!=i.length-1){for(var o=util.getCurrentRoom().devices,n=0;o.length>n;n++)o[n].name===t&&(util.setDeviceByShortName(o[n].shortname),ui.clearNowPlaying(),util.updateStatus());e(a)}})}),ui.view.bind("powerButtonTap",function(){gestures.executeGestureByCommandName("Power")
}),ui.view.bind("playButtonTap",function(e){e?gestures.executeGestureByCommandName("Pause"):gestures.executeGestureByCommandName("Play")}),ui.view.bind("rewindButtonTap",function(){gestures.executeGestureByCommandName("Skip Back")}),ui.view.bind("forwardButtonTap",function(){gestures.executeGestureByCommandName("Skip Forward")}),ui.view.bind("muteButtonTap",function(){gestures.executeGestureByCommandName("Mute")}),ui.view.bind("volumeChange",function(e){console.log(e);var t=20,i=Math.round(t-t*(e/100)),a=0;i>=t/2?(a=i-t/2,a>0&&(sliders.sendVolumeChange(a,"VolumeDown"),ui.view.setVolumeSlider({value:50}))):(a=t/2-i,a>0&&(sliders.sendVolumeChange(a,"VolumeUp"),ui.view.setVolumeSlider({value:50})))}),ui.view.bind("seekChange",function(e){if("MCE"==util.getCurrentDevice().shortname&&ui.nowPlaying.duration>0){e/=100;var t=Math.floor(ui.nowPlaying.duration*e);sliders.sendSeekEvent(t)}})},clearNowPlaying:function(){ui.view.setOptionsForView({durationStartText:"",durationEndText:"",durationSliderValue:0,duration:0,title:"",subTitle:"",url:""})},queryNowPlaying:function(){if(!ui.screenShotMode){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=util.getMBUrl();$.ajax({url:t+"ui",dataType:"json",timeout:1e4,success:function(e){var i=0;try{i=e.Data.PlayingControllers[0].CurrentFileDuration.TotalSeconds}catch(a){return}if(e.Data.PlayingControllers.length>=1){i=e.Data.PlayingControllers[0].CurrentFileDuration.TotalSeconds;var o=e.Data.PlayingControllers[0].CurrentFilePosition.TotalSeconds,n=o/i,r=e.Data.PlayingControllers[0].PlayableItems[0].CurrentMediaIndex,s=e.Data.PlayingControllers[0].PlayableItems[0].MediaItemIds[0];ui.view.setOptionsForView({durationStartText:util.hms2(o),durationEndText:"-"+util.hms2(i-o),durationSliderValue:util.isNumeric(n)?Math.floor(100*n):0,guid:s,currentID:r,title:e.Data.PlayingControllers[0].PlayableItems[0].DisplayName,subTitle:"â˜…â˜…â˜…â˜…â˜…",duration:e.Data.PlayingControllers[0].CurrentFileDuration.Ticks,controller:e.Data.PlayingControllers[0].ControllerName,url:t+"image/?Id="+s,isPlaying:e.Data.PlayingControllers[0].IsPaused===!0?!1:!0})}else ui.clearNowPlaying()},error:function(){ui.clearNowPlaying()}})}"DTV"==e.shortname&&$.ajax({type:"GET",url:"http://"+e.IPAddress+":"+e.Port+"/tv/getTuned",dataType:"json",timeout:1e4,success:function(e){if(!e.startTime||"0"==e.startTime)return ui.view.setOptionsForView({durationStartText:"",durationEndText:"",durationSliderValue:0,duration:0,url:""}),void 0;var t=e.offset/e.duration;DirecTV.addToRecentChannels(e.major),ui.view.setOptionsForView({durationStartText:util.hms2(e.offset),durationEndText:"-"+util.hms2(e.duration-e.offset),durationSliderValue:Math.floor(100*t),guid:null,currentID:null,title:e.title,item:e.callsign+e.major,subTitle:e.major+" "+e.callsign,duration:0,isPlaying:!1,url:""}),$.ajax({type:"GET",url:"http://www.thetvdb.com/api/GetSeries.php?seriesname="+e.title,dataType:"xml",success:function(t){var i="";$(t).find("Data > Series > SeriesName").each(function(){return $(this).text().toLowerCase().replace(/\W/g,"").replace("the","")==e.title.toLowerCase().replace(/\W/g,"").replace("the","")?(i=$(this).parent().find("seriesid").text(),!1):void 0}),""!==i&&$.ajax({type:"GET",url:"http://thetvdb.com/api/77658293DB487350/series/"+i+"/",dataType:"xml",success:function(e){var t=$(e).find("poster:first");$(t).size()>0&&ui.view.setOptionsForView({url:"http://thetvdb.com/banners/_cache/"+$(t).text()})}})}})}})}}},util={showingHud:!1,doHud:function(e){if(!util.showingHud||!e.show){var t=window.plugins.progressHud;e.show?(util.showingHud=!0,t.show({mode:"indeterminate",labelText:e.labelText,detailsLabelText:e.detailsLabelText},function(){},e.tappedEvent?e.tappedEvent:function(){})):(util.showingHud=!1,t.hide())}},lastYouTubeURL:"",checkForYouTubeLink:function(){var e=util.getCurrentDevice();"MCE"==e.shortname&&window.plugins.clipboardPlugin.getText(function(e){if(/^http/.test(e)||/^smb/.test(e)||/^\\/.test(e)){if(util.lastYouTubeURL=util.getItem("lastYouTubeURL"),util.lastYouTubeURL==e)return;navigator.notification.confirm(e,function(t){if(util.lastYouTubeURL=e,util.setItem("lastYouTubeURL",e),1===t){var i=util.getEGBaseUrl()+"?YouTube&"+e;$.ajax({type:"GET",url:i})}},"Play Video","Yes,No")}})},compare:function(e,t){return e.catIndex<t.catIndex?-1:e.catIndex>t.catIndex?1:0},iOSVersion:function(){var e=window.device.version;return parseInt(e.split(".")[0],10)},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},ticksToMilliseconds:function(e){return 1*e/1e4},millisecondsToTicks:function(e){return 1e4*e},addMinutes:function(e,t){return new Date(e.getTime()+6e4*t)},parseDate:function(e){var t=e.split("/");return new Date(t[2],t[0]-1,t[1])},daydiff:function(e,t){return(t-e)/864e5},randomFromInterval:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},detectOrientation:function(){window.onorientationchange!==void 0&&util.doResize()},setSwipeThresholds:function(){"tablet"==deviceType&&(HorzLongSwipeThreshold=.5*$("#gestures_canvas").width(),VertLongSwipeThreshold=.5*$("#gestures_canvas").height()),"phone"==deviceType&&(HorzLongSwipeThreshold=.8*$("#gestures_canvas").width(),VertLongSwipeThreshold=.7*$("#gestures_canvas").height())},doResize:function(){var e=$(document).height(),t=$(document).width();$("#gestures_canvas").attr("height",e),$("#gestures_canvas").attr("width",t),$("#gestures_canvas").height(e),$("#gestures_canvas").width(t),setTimeout(function(){util.setSwipeThresholds()},1500)},executeObjC:function(e){var t=document.createElement("IFRAME");t.setAttribute("src",e),document.documentElement.appendChild(t),t.parentNode.removeChild(t),t=null},htmlEscape:function(e){return(e+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},splash:function(e){try{"hide"==e?navigator.splashscreen.hide():navigator.splashscreen.show()}catch(t){}},setStatusBarMessage:function(e){console.log(e),util.showNotification(e,"")},setStatusBarForceClear:function(){return},getEGBaseUrl:function(){for(var e=util.getCurrentRoom(),t=e.devices,i=0;t.length>i;i++)if("MCE"==t[i].shortname)return"http://"+t[i].IPAddress+":"+t[i].Port+"/";return""},getRandomMBServer:function(){for(var e=[],t=0;settings.userSettings.rooms.length>t;t++){devices=settings.userSettings.rooms[t].devices;for(var i=0;devices.length>i;i++)"MCE"==devices[i].shortname&&e.push("http://"+devices[i].IPAddress+":"+devices[i].ServicePort+"/mbwebapi/service/")}return e[Math.floor(Math.random()*e.length)]},getFirstMBServer:function(){for(var e="",t=0;settings.userSettings.rooms.length>t;t++){devices=settings.userSettings.rooms[t].devices;for(var i=0;devices.length>i;i++)if("MCE"==devices[i].shortname){e="http://"+devices[i].IPAddress+":"+devices[i].ServicePort+"/mbwebapi/service/";break}if(""!==e)break}return e},getMBUrl:function(){for(var e=util.getCurrentRoom(),t=e.devices,i=0;t.length>i;i++)if("MCE"==t[i].shortname)return"http://"+t[i].IPAddress+":"+t[i].ServicePort+"/mbwebapi/service/";return""},getCurrentDevice:function(){return settings.userSettings.rooms?settings.userSettings.rooms.length>0?settings.userSettings.rooms[settings.userSettings.roomIndex].devices.length>0?settings.userSettings.rooms[settings.userSettings.roomIndex].devices[settings.userSettings.deviceIndex]:null:null:void 0},getCurrentRoom:function(){return settings.userSettings.rooms[settings.userSettings.roomIndex]},getDeviceByShortName:function(e){for(var t=util.getCurrentRoom(),i=0;t.devices.length>i;i++)if(t.devices[i].shortname==e)return t.devices[i];return null},setDeviceByShortName:function(e){for(var t=util.getCurrentRoom(),i=0;t.devices.length>i;i++)if(t.devices[i].shortname==e)return settings.userSettings.deviceIndex=i,!0;return!1},getEpochTime:function(){var e=new Date;return Math.round(e.getTime())},epochToDateObject:function(e){return new Date(1e3*e)},getRoomStatus:function(){var e=util.getEGBaseUrl();$.ajax({type:"GET",dataType:"text",url:e,success:function(e){settings.userSettings.deviceIndex=0;try{var t=jQuery.parseJSON(e);if(""!==t.device){var i=util.getDeviceByShortName(t.device);settings.userSettings.deviceIndex=i.index}}catch(a){}util.updateStatus()}})},updateStatus:function(){if(ui.screenShotMode)return ui.view.setStatusBar({show:!1}),ui.view.setOptionsForView({navTitle:"",navSubTitle:""}),void 0;var e=util.getCurrentDevice(),t=util.getCurrentRoom();ui.view.setOptionsForView({navTitle:t.name,navSubTitle:e.name}),(util.getItem("deviceIndex")!=settings.userSettings.deviceIndex||util.getItem("roomIndex")!=settings.userSettings.roomIndex)&&ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},1500),util.setItem("deviceIndex",settings.userSettings.deviceIndex),util.setItem("roomIndex",settings.userSettings.roomIndex)},hms2:function(e){if(0>=e)return"0:00";try{return hours=parseInt(e/3600,10)%24,minutes=parseInt(e/60,10)%60,seconds=e%60,hours+":"+(10>minutes?"0"+minutes:minutes)}catch(t){return"0:00"}},clearCallers:function(e){if(e===!1){var t=$("#gestureCallback div.dofadeout-final");$(t).remove()}else $("#gestureCallback div").remove()},showNotification:function(e,t){ui.view.showNotification({title:e,subtitle:t})},doAlert:function(e){util.doHud({show:!1});try{navigator.notification.alert(e,null,"gesturePad")}catch(t){alert(e)}},isWifi:function(){if(settings.userSettings.wifi===!1)return!0;try{return"WiFi connection"==util.netState()?!0:!1}catch(e){return!0}},netState:function(){try{var e=navigator.connection.type,t={};return t[Connection.UNKNOWN]="Unknown connection",t[Connection.ETHERNET]="Ethernet connection",t[Connection.WIFI]="WiFi connection",t[Connection.CELL_2G]="Cell 2G connection",t[Connection.CELL_3G]="Cell 3G connection",t[Connection.CELL_4G]="Cell 4G connection",t[Connection.NONE]="No network connection",t[e]}catch(i){return"WiFi connection"}},setItem:function(e,t){localStorage.setItem(e,t)},getItem:function(e,t){try{return localStorage.getItem(e)}catch(i){return 2==arguments.length?t:""}},reloadPage:function(){console.log("reloading"),util.splash("show"),window.location.reload()},playBeep:function(){if(settings.userSettings.sounds)try{navigator.notification.beep()}catch(e){}if(settings.userSettings.vibrate)try{navigator.notification.vibrate(1e3)}catch(e){}},dynamicSort:function(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1,e.length-1)),function(i,a){var o=i[e]<a[e]?-1:i[e]>a[e]?1:0;return o*t}},shuffle:function(e){for(var t,i,a=e.length;a>0;)i=0|Math.random()*a--,t=e[a],e[a]=e[i],e[i]=t;return e}};$.fn.hasAttr=function(e){return void 0!==this.attr(e)},Date.prototype.timeNow=function(){var e="AM",t=this.getHours();return this.getHours()>12&&(e="PM",t-=12),0===t&&(t=12),e=t+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+" "+e,"0:00 AM"==e?"":e};