/*!  gesturePad 2014-03-16 */
var DirecTV={recentChannels:[],changeChannel:function(e){var t=util.getCurrentDevice();DirecTV.addToRecentChannels(e),$.getJSON("http://"+t.IPAddress+":"+t.Port+"/tv/tune?major="+e,function(){ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},3e3)})},getTitleForChannel:function(e){var t=e;return $.each(guide.channels,function(i){var n=guide.channels[i];return n.number==e?(t=""===n.nowplaying?n.fullname:n.nowplaying,!1):void 0}),t},addToRecentChannels:function(e){var t=DirecTV.recentChannels;t=jQuery.grep(t,function(t){return t!=e}),t.unshift(e),t=t.slice(0,4),DirecTV.recentChannels=t},startWorker:function(){try{clearTimeout(workerTimer)}catch(e){}for(var t=[],i=0,n=0;settings.userSettings.rooms.length>n;n++)for(var a=0;settings.userSettings.rooms[n].devices.length>a;a++)"DTV"==settings.userSettings.rooms[n].devices[a].shortname&&(t[i]="http://"+settings.userSettings.rooms[n].devices[a].IPAddress+":"+settings.userSettings.rooms[n].devices[a].Port+"/",$.ajaxq("DTVWorker"+i),i+=1);i=0;var o=!1;$.each(guide.channels,function(e){var n=guide.channels[e],a="0:00";if(n.startTime>0&&n.duration>0&&(a=util.hms2(n.startTime+n.duration-Math.floor((new Date).getTime()/1e3))),""===n.nowplaying||"0:00"==a){n.nowplaying="";for(var r=!1;r===!1;)i>t.length-1&&(i=0),t[i].room!=util.getCurrentDevice().shortname&&(DirecTV.refreshChannel(t[i],"DTVWorker"+i,e),o=!0,r=!0),i+=1}}),o===!1&&(workerTimer=setTimeout(function(){DirecTV.startWorker()},3e4))},setupWorker:function(e){if(DirecTV.hasDirecTV()!==!1){guide.channels=[];var t="";$(e).find("channels > channel").each(function(){if(t!=$(this).find("number").text()){var i={};i.number=$(this).find("number").text(),i.logo=$(this).find("logo").text(),i.callsign=$(this).find("callsign").text(),i.nowplaying="",i.ending=0,i.timeleft="",i.fullname=$(this).find("fullname").text(),i.startTime=0,i.duration=0;var n=$(e).find("channels > favorites > category > number").filter(function(){return $(this).text()==i.number});$(n).size()>0?(i.category=$(n).parent().attr("name"),i.catIndex=parseInt($(n).parent().attr("idx"),10)):(i.category="Unsorted",i.catIndex=999),guide.channels.push(i),t=i.number}}),guide.channels.sort(util.compare),DirecTV.startWorker()}},hasDirecTV:function(){for(var e=!1,t=0;settings.userSettings.rooms.length>t;t++)if(null!==settings.userSettings.rooms[t].DTV){e=!0;break}return e},loadChannelList:function(){var e="xml/channellist.xml?r="+Math.random();$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){DirecTV.setupWorker(e)},error:function(){util.doAlert("Error loading channel list: "+e)}})},refreshChannel:function(e,t,i){var n=guide.channels[i];$.ajaxq(t,{url:e+"tv/getProgInfo",dataType:"json",type:"GET",timeout:1e4,data:"major="+n.number,success:function(e){try{n.nowplaying=e.title,n.startTime=e.startTime,n.duration=e.duration,n.timeleft=util.hms2(e.startTime+e.duration-Math.floor((new Date).getTime()/1e3)),n.ending=e.startTime+e.duration}catch(i){document.ajaxq.q[t].shift()}DirecTV.checkIfWorkerIsComplete()},error:function(){document.ajaxq.q[t].shift(),DirecTV.checkIfWorkerIsComplete()}})},checkIfWorkerIsComplete:function(){var e=!0;$.each(document.ajaxq.q,function(t){document.ajaxq.q[t].length>1&&t.indexOf("DTVWorker")>-1&&(e=!1)}),e===!0&&(workerTimer=setTimeout(function(){DirecTV.startWorker()},3e4))}},mb3={config:{server:"192.168.1.146",port:"8096",userName:"treason",password:"urchin",userID:"",clientId:""},getServiceUrl:function(){return"http://"+mb3.config.server+":"+mb3.config.port},getUserId:function(){return mb3.config.userID},hashPassword:function(e){function t(e,t){var i=e<<t|e>>>32-t;return i}function i(e){var t,i,n="";for(t=7;t>=0;t--)i=15&e>>>4*t,n+=i.toString(16);return n}function n(e){e=e.replace(/\r\n/g,"\n");for(var t="",i=0;e.length>i;i++){var n=e.charCodeAt(i);128>n?t+=String.fromCharCode(n):n>127&&2048>n?(t+=String.fromCharCode(192|n>>6),t+=String.fromCharCode(128|63&n)):(t+=String.fromCharCode(224|n>>12),t+=String.fromCharCode(128|63&n>>6),t+=String.fromCharCode(128|63&n))}return t}var a,o,r,s,l,c,u,d,m,g=Array(80),h=1732584193,f=4023233417,v=2562383102,p=271733878,b=3285377520;e=n(e);var w=e.length,y=[];for(o=0;w-3>o;o+=4)r=e.charCodeAt(o)<<24|e.charCodeAt(o+1)<<16|e.charCodeAt(o+2)<<8|e.charCodeAt(o+3),y.push(r);switch(w%4){case 0:o=2147483648;break;case 1:o=8388608|e.charCodeAt(w-1)<<24;break;case 2:o=32768|(e.charCodeAt(w-2)<<24|e.charCodeAt(w-1)<<16);break;case 3:o=128|(e.charCodeAt(w-3)<<24|e.charCodeAt(w-2)<<16|e.charCodeAt(w-1)<<8)}for(y.push(o);14!=y.length%16;)y.push(0);for(y.push(w>>>29),y.push(4294967295&w<<3),a=0;y.length>a;a+=16){for(o=0;16>o;o++)g[o]=y[a+o];for(o=16;79>=o;o++)g[o]=t(g[o-3]^g[o-8]^g[o-14]^g[o-16],1);for(s=h,l=f,c=v,u=p,d=b,o=0;19>=o;o++)m=4294967295&t(s,5)+(l&c|~l&u)+d+g[o]+1518500249,d=u,u=c,c=t(l,30),l=s,s=m;for(o=20;39>=o;o++)m=4294967295&t(s,5)+(l^c^u)+d+g[o]+1859775393,d=u,u=c,c=t(l,30),l=s,s=m;for(o=40;59>=o;o++)m=4294967295&t(s,5)+(l&c|l&u|c&u)+d+g[o]+2400959708,d=u,u=c,c=t(l,30),l=s,s=m;for(o=60;79>=o;o++)m=4294967295&t(s,5)+(l^c^u)+d+g[o]+3395469782,d=u,u=c,c=t(l,30),l=s,s=m;h=4294967295&h+s,f=4294967295&f+l,v=4294967295&v+c,p=4294967295&p+u,b=4294967295&b+d}var T=i(h)+i(f)+i(v)+i(p)+i(b);return T.toLowerCase()},authenticateUser:function(e,t){var i=mb3.getServiceUrl()+"/mediabrowser/Users/AuthenticateByName?format=json";$.ajax({url:i,data:"Username="+e+"&Password="+mb3.hashPassword(t),type:"POST",success:function(e){mb3.config.userID=e.User.Id},error:function(e,t,i){console.log("Auth Error"),console.log(e),console.log(t),console.log(i)}})},lastOpenedCallBack:function(){mb3.createInitialListView()},navigationStack:[],goBack:function(){var e=mb3.navigationStack.pop();0===mb3.navigationStack.length?mb3.createInitialListView():(e=mb3.navigationStack.pop(),mb3.ShowItems(e))},resetCallback:function(){mb3.lastOpenedCallBack=function(){mb3.createInitialListView()}},playByID:function(e,t){var i=mb3.getServiceUrl();i+="/mediabrowser/Sessions/"+mb3.config.clientId+"/Playing",t||(t=0),$.ajax({url:i,data:"ItemIds="+e+"&PlayCommand=PlayNow&StartPositionTicks="+t,type:"POST",success:function(){setTimeout(function(){ui.queryNowPlaying()},1500)},error:function(e,t,i){console.log("Auth Error"),console.log(e),console.log(t),console.log(i)}})},playTitle:function(e,t,i){if(util.isWifi()===!1)return util.doAlert("You are not on Wifi. To play this title, connect to Wifi and try again"),void 0;var n=mb3.getServiceUrl(),a=$(e).attr("data-guid");if(i)mb3.playByID(a);else{var o=window.plugins.actionSheet,r=["Play","Resume","View on Screen"];"1"===$(e).attr("data-imdb")&&r.push("View Imdb Page"),r.push("Cancel"),a=$(e).attr("data-guid");var s="Actions";void 0!==s&&(s=t),o.create({title:s,items:r,destructiveButtonIndex:r.length-1},function(i,o){if(-1!=o&&o!=r.length-1)switch(r[o]){case"Play":mb3.playByID(a);break;case"Resume":n+="/mediabrowser/Users/"+mb3.config.userID+"/Items/"+a+"/?format=json&Fields=Overview,Genres",$.ajax({url:n,dataType:"json",success:function(e){mb3.playByID(a,e.UserData.PlaybackPositionTicks)}});break;case"View on Screen":n+="/mediabrowser/Sessions/"+mb3.config.clientId+"/Viewing",$.ajax({url:n,data:"ItemId="+$(e).attr("data-guid")+"&ItemName="+t,type:"POST",success:function(){setTimeout(function(){ui.queryNowPlaying()},1500)},error:function(){}});break;case"View Imdb Page":n+="/mediabrowser/Users/"+mb3.config.userID+"/Items/"+a+"/?format=json&Fields=Overview,Genres",$.ajax({url:n,dataType:"json",success:function(e){if(e.ProviderIds){if(e.ProviderIds.Imdb){var t=window.plugins.NativeTable;t.hideTable(function(){cb=window.plugins.childBrowser,null!==cb&&(cb.onClose=function(){setTimeout(function(){ui.view.trigger("rightNavButtonTap")},1e3)},cb.showWebPage("http://m.imdb.com/title/"+e.ProviderIds.Imdb))})}}else util.doAlert("Sorry, This title does not have an IMBD id")}})}})}},ShowItems:function(e,t){var i="click";t&&(i=t),mb3.getServiceUrl(),util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var n=function(e){if("StartupFolder"==e.back)return mb3.createInitialListView(),void 0;var t=[];$.each(e.Items,function(e,i){if("Folder"==i.Type||"Season"==i.Type||"Series"==i.Type||"FavoriteFolder"==i.Type)t.push({textLabel:i.Name,detailTextLabel:""+i.RecursiveItemCount+" total, "+i.RecursiveUnplayedItemCount+" not watched, "+i.RecentlyAddedItemCount+" new",icon:"greyarrow",sectionHeader:i.Type,image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:i.Id,type:i.Type,imdb:"0",ParentId:i.ParentId});else{var n="0";i.ProviderIds&&i.ProviderIds.Imdb&&(n="1"),t.push({textLabel:i.Name+(i.ProductionYear?" ("+i.ProductionYear+")":""),detailTextLabel:(i.CommunityRating?i.CommunityRating+"/10 ":"")+(i.Overview?i.Overview:""),icon:"none",sectionHeader:i.Type,image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:i.Id,type:i.Type,imdb:n,ParentId:i.ParentId})}});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:e.Title,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){mb3.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.setRowSelectCallBackFunction(function(e){var n=t[e];if("none"==n.icon){var a=$("<tr data-guid='"+n.guid+"' data-imdb='"+n.imdb+"'></tr>");mb3.playTitle($(a),n.textLabel,!1)}else i.hideTable(function(){mb3.ShowItems(n)})}),i.onBackButtonTap(function(){i.hideTable(function(){mb3.goBack()})}),i.setTableData(t),util.doHud({show:!1}),i.showTable(function(){})},a=function(e,t,i){return util.isWifi()===!1&&t?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),void 0):($.ajax({url:e,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(a){null!==a&&(a.Title=i,cache.saveJson(e,a)),t&&n(a)},error:function(){t&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)};if("CustomFolder"==e.type){switch(e.folderType){case"Genres":mb3.lastOpenedCallBack=function(){mb3.showListOfGenres()};break;case"Years":mb3.lastOpenedCallBack=function(){mb3.showListOfYears()};break;case"Actors":mb3.lastOpenedCallBack=function(){mb3.showListOfActors()};break;case"Directors":mb3.lastOpenedCallBack=function(){mb3.showListOfDirectors()};break;case"OfficialRating":mb3.lastOpenedCallBack=function(){mb3.showListOfRating()};break;case"IMDBRating":mb3.lastOpenedCallBack=function(){mb3.showListOfIMDBRating()};break;case"Unwatched":mb3.lastOpenedCallBack=function(){mb3.showListOfUnwatched()};break;case"Custom TV":mb3.lastOpenedCallBack=function(){MediaBrowserNowPlaying.buildListView()}}mb3.lastOpenedCallBack()}else mb3.navigationStack.push(e),mb3.lastOpenedCallBack=function(){var t=mb3.getServiceUrl()+"/mediabrowser/Users/"+mb3.getUserId()+"/Items?format=json&Fields=Overview,ProviderId,ParentId&ParentId="+e.guid;settings.userSettings.moviesByDate&&(t+="&SortBy=DateCreated&SortOrder=Descending"),cache.getJson(t,function(i){null===i?a(t,!0,e.Name):(n(i),a(t,!1,e.Name))})},mb3.lastOpenedCallBack()},createInitialListView:function(){var e=function(e){var t=[];$.each(e.Items,function(e,i){t.push({textLabel:i.Name,detailTextLabel:""+i.RecursiveItemCount+" total, "+i.RecursiveUnplayedItemCount+" not watched, "+i.RecentlyAddedItemCount+" new",icon:"greyarrow",sectionHeader:"Folders",image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",nomask:!1,guid:i.Id,type:i.Type})}),t.unshift({textLabel:"Custom TV",detailTextLabel:"TV Channels based off your library",icon:"greyarrow",sectionHeader:"Now Playing",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Custom TV"}),t.push({textLabel:"Genres",detailTextLabel:"Movies Separated By Genre",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Genres"}),t.push({textLabel:"Rating",detailTextLabel:"Movies sorted by Community Rating",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"IMDBRating"}),t.push({textLabel:"Release Year",detailTextLabel:"Movies Separated By Production Year",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Years"}),t.push({textLabel:"Unwatched",detailTextLabel:"Movies that have not been watched",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"Unwatched"}),t.push({textLabel:"MPAA Rating",detailTextLabel:"Official rating by the MPAA",icon:"greyarrow",sectionHeader:"Categories",image:"www/img/mb.png",nomask:!1,type:"CustomFolder",folderType:"OfficialRating"});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"Movies",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){mb3.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.setRowSelectCallBackFunction(function(e){var n=t[e];i.hideTable(function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."}),setTimeout(function(){mb3.ShowItems(n)},250)})}),i.setTableData(t),util.doHud({show:!1}),i.showTable(function(){})},t=function(t,i){return util.isWifi()===!1&&i?(util.doAlert("You are not on Wifi and no cached version exists. To do this, connect to Wifi and try again"),mb3.createInitialListView(),void 0):($.ajax({url:t,dataType:"json",timeout:settings.MBServiceTimeout,success:function(n){cache.saveJson(t,n),i&&e(n)},error:function(){i&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)},i=mb3.getServiceUrl()+"/mediabrowser/Users/"+mb3.getUserId()+"/Items?format=json";mb3.lastOpenedCallBack=function(){mb3.createInitialListView()},cache.getJson(i,function(n){null===n?t(i,!0):(e(n),t(i,!1))})},loadGeniusResults:function(e){cache.getJson("genius",function(t){null===t&&(t={refreshQueue:[],Titles:{},TitlesQueue:{},allItems:[],loaded:!1}),e(t)})},toolbarButtonClickEvent:function(e,t){1==e&&(MediaBrowserNowPlaying.allItemsPopulated=!1,t.hideTable(function(){ui.view.trigger("rightNavButtonTap")})),2==e&&gestures.executeGestureByCommandName("VolumeDown"),3==e&&gestures.executeGestureByCommandName("VolumeUp"),4==e&&t.hideTable(function(){util.setDeviceByShortName("DTV"),ui.view.trigger("rightNavButtonTap")}),5==e&&t.hideTable(function(){ui.view.trigger("rightNavButtonTap")})},createCustomTable:function(e,t,i,n){var a=window.plugins.NativeTable;a.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:t,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),a.onToolbarButtonClick(function(e){mb3.toolbarButtonClickEvent(e,a)}),a.onRightButtonTap(function(){a.hideTable(function(){})}),a.setRowSelectCallBackFunction(function(e){n(e,a)}),a.onBackButtonTap(function(){a.hideTable(function(){i()})}),a.setTableData(e),util.doHud({show:!1}),a.showTable(function(){})},showListOfYears:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){""!==n.ProductionYear&&n.ProductionYear&&-1==jQuery.inArray(n.ProductionYear,t)&&(t.push(n.ProductionYear),e.push({textLabel:""+n.ProductionYear,detailTextLabel:"Movies Released in "+n.ProductionYear,icon:"greyarrow",sectionHeader:"Movies By Year",type:"CustomFolder",folderType:"Years"}))}),t=null,0===e.length?(util.doAlert("No Years found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("-textLabel")),mb3.createCustomTable(e,"Years",function(){mb3.createInitialListView()},function(t,i){var n=e[t];i.hideTable(function(){mb3.showListOfMoviesByYear(n.textLabel)}),mb3.lastOpenedCallBack=function(){mb3.showListOfMoviesByYear(n.textLabel)}}),void 0)})},showListOfMoviesByYear:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.ProductionYear==e){var a="0";n.ProviderIds&&n.ProviderIds.Imdb&&(a="1"),t.push({textLabel:(0===n.WatchedPercentage?" ":"")+n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),detailTextLabel:(n.CommunityRating?n.CommunityRating+"/10 ":"")+(n.Overview?n.Overview:""),icon:"none",image:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.Id+"/Images/Primary?maxheight=120&maxwidth=120",sectionHeader:n.SortName.substring(0,1).toUpperCase(),guid:n.Id,type:n.Type,imdb:a,sortName:n.SortName})}}),0===t.length?(util.doAlert("No movies found for this year."),void 0):(t.sort(util.dynamicSort("sortName")),mb3.createCustomTable(t,e,function(){mb3.showListOfYears()},function(e){var i=t[e],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},showListOfGenres:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.Genres)for(var a=0;n.Genres.length>a;a++)""!==n.Genres[a]&&null!==n.Genres[a]&&-1==jQuery.inArray(n.Genres[a],t)&&(t.push(n.Genres[a]),e.push({textLabel:n.Genres[a],detailTextLabel:""+n.Genres[a]+" movies",icon:"greyarrow",sectionHeader:"Movies By Genre",type:"CustomFolder",folderType:"Genres"}))}),t=null,0===e.length?(util.doAlert("No Genres found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("textLabel")),mb3.createCustomTable(e,"Genres",function(){mb3.createInitialListView()},function(t,i){var n=e[t];i.hideTable(function(){mb3.showListOfMoviesByGenre(n.textLabel)}),mb3.lastOpenedCallBack=function(){mb3.showListOfMoviesByGenre(n.textLabel)}}),void 0)})},showListOfMoviesByGenre:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.Genres)for(var a=0;n.Genres.length>a;a++)if(n.Genres[a]==e){var o="0";n.ProviderIds&&n.ProviderIds.Imdb&&(o="1"),t.push({textLabel:n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),detailTextLabel:(n.CommunityRating?n.CommunityRating+"/10 ":"")+(n.Overview?n.Overview:""),image:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.Id+"/Images/Primary?maxheight=120&maxwidth=120",icon:"none",sectionHeader:n.SortName.substring(0,1).toUpperCase(),guid:n.Id,type:n.Type,imdb:o,sortName:n.SortName})}}),0===t.length?(util.doAlert("No movies found for this genre."),void 0):(t.sort(util.dynamicSort("sortName")),mb3.createCustomTable(t,e,function(){mb3.showListOfGenres()},function(e){var i=t[e],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},showListOfActors:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.Actors)for(var a=0;n.Actors.length>a;a++)if(""!==$.trim(n.Actors[a].Name)&&null!==n.Actors[a].Name&&-1==jQuery.inArray(n.Actors[a].Name,t)){t.push(n.Actors[a].Name);var o=n.Actors[a].Name.split(" ").pop().replace(/[^a-zA-Z 0-9]+/g,"");if(o+=", "+n.Actors[a].Name.split(" ")[0].replace(/[^a-zA-Z 0-9]+/g,""),o.length>4){var r={textLabel:o,detailTextLabel:"",icon:"greyarrow",image:util.getRandomMBServer()+"image/?Id="+n.Actors[a].Person.Id+"&maxwidth=120&maxheight=120",sectionHeader:o.substring(0,1).toUpperCase(),type:"CustomFolder",folderType:"Actors",customSort:o,ActualName:n.Actors[a].Name};n.Actors[a].Person&&""!==n.Actors[a].Person.PrimaryImagePath&&null!==n.Actors[a].Person.PrimaryImagePath&&(r.image=util.getRandomMBServer()+"image/?Path="+encodeURIComponent(n.Actors[a].Person.PrimaryImagePath)+"&maxwidth=120&maxheight=120",r.guid=n.Actors[a].Person.Id),e.push(r)}}}),t=null,0===e.length?(util.doAlert("No Actors found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("customSort")),mb3.createCustomTable(e,"Actors",function(){mb3.createInitialListView()},function(t,i){var n=e[t];i.hideTable(function(){mb3.showListOfMoviesByActor(n.ActualName)}),mb3.lastOpenedCallBack=function(){mb3.showListOfMoviesByActor(n.ActualName)}}),void 0)})},showListOfMoviesByActor:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.Actors)for(var a=0;n.Actors.length>a;a++)if(n.Actors[a].Name==e){var o="0";n.ProviderIds&&n.ProviderIds.Imdb&&(o="1"),t.push({textLabel:n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),detailTextLabel:(n.CommunityRating?n.CommunityRating+"/10 ":"")+(n.Overview?n.Overview:""),icon:"none",sectionHeader:n.SortName.substring(0,1).toUpperCase(),image:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:n.Id,type:n.Type,imdb:o,sortName:n.SortName})}}),0===t.length?(util.doAlert("No movies found for this actor."),void 0):(t.sort(util.dynamicSort("sortName")),mb3.createCustomTable(t,e,function(){mb3.showListOfActors()},function(e){var i=t[e],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},showListOfDirectors:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.Directors)for(var a=0;n.Directors.length>a;a++)if(""!==$.trim(n.Directors[a])&&null!==n.Directors[a]&&-1==jQuery.inArray(n.Directors[a],t)){t.push(n.Directors[a]);var o=n.Directors[a].split(" ").pop().replace(/[^a-zA-Z 0-9]+/g,"");o+=", "+n.Directors[a].split(" ")[0].replace(/[^a-zA-Z 0-9]+/g,""),o.length>4&&e.push({textLabel:o,detailTextLabel:"",icon:"greyarrow",sectionHeader:o.substring(0,1).toUpperCase(),type:"CustomFolder",folderType:"Directors",customSort:o,ActualName:n.Directors[a]})}}),t=null,0===e.length?(util.doAlert("No Directors found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("customSort")),mb3.createCustomTable(e,"Directors",function(){mb3.createInitialListView()},function(t,i){var n=e[t];i.hideTable(function(){mb3.showListOfMoviesByDirector(n.ActualName)}),mb3.lastOpenedCallBack=function(){mb3.showListOfMoviesByDirector(n.ActualName)}}),void 0)})},showListOfMoviesByDirector:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.Directors)for(var a=0;n.Directors.length>a;a++)if(n.Directors[a]==e){var o="0";n.ProviderIds&&n.ProviderIds.Imdb&&(o="1"),t.push({textLabel:n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),detailTextLabel:(n.CommunityRating?n.CommunityRating+"/10 ":"")+(n.Overview?n.Overview:""),icon:"none",sectionHeader:n.SortName.substring(0,1).toUpperCase(),image:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:n.Id,type:n.Type,imdb:o,sortName:n.SortName})}}),0===t.length?(util.doAlert("No movies found for this Director."),void 0):(t.sort(util.dynamicSort("sortName")),mb3.createCustomTable(t,e,function(){mb3.showListOfDirectors()},function(e){var i=t[e],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},showListOfRating:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){""!==n.OfficialRating&&n.OfficialRating&&-1==jQuery.inArray(n.OfficialRating,t)&&(t.push(n.OfficialRating),e.push({textLabel:""+n.OfficialRating,detailTextLabel:"Movies Rated: "+n.OfficialRating,icon:"greyarrow",sectionHeader:"Movies By MPAA Rating",type:"CustomFolder",folderType:"Rating"}))}),t=null,0===e.length?(util.doAlert("No Ratings found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("textLabel")),mb3.createCustomTable(e,"Rating",function(){mb3.createInitialListView()},function(t,i){var n=e[t];i.hideTable(function(){mb3.showListOfMoviesByRating(n.textLabel)}),mb3.lastOpenedCallBack=function(){mb3.showListOfMoviesByRating(n.textLabel)}}),void 0)})},showListOfMoviesByRating:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(n.OfficialRating==e){var a="0";n.ProviderIds&&n.ProviderIds.Imdb&&(a="1"),t.push({textLabel:n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),detailTextLabel:(n.CommunityRating?n.CommunityRating+"/10 ":"")+(n.Overview?n.Overview:""),icon:"none",sectionHeader:n.SortName.substring(0,1).toUpperCase(),image:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:n.Id,type:n.Type,imdb:a,sortName:n.SortName})}}),0===t.length?(util.doAlert("No movies found for this rating."),void 0):(t.sort(util.dynamicSort("sortName")),mb3.createCustomTable(t,e,function(){mb3.showListOfRating()},function(e){var i=t[e],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},showListOfIMDBRating:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[],t=[];mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(util.isNumeric(n.CommunityRating)&&n.CommunityRating>0){var a=Math.floor(n.CommunityRating);-1==jQuery.inArray(a,t)&&(t.push(a),e.push({textLabel:a+" stars",detailTextLabel:"Movies with greater or equal to "+a+" stars",icon:"greyarrow",sectionHeader:"Movies By Rank",type:"CustomFolder",folderType:"imdbRating",imdbRating:""+a,sortOn:(10>a?"0":"")+a}))}}),t=null,0===e.length?(util.doAlert("No imdb ratings found, this can happen if the app does not know enough about your library. You can try to leave the app open for a bit, while indexing occurs."),void 0):(e.sort(util.dynamicSort("-sortOn")),mb3.createCustomTable(e,"Rating",function(){mb3.createInitialListView()},function(t,i){var n=e[t];i.hideTable(function(){mb3.showListOfMoviesByIMDBRating(n.imdbRating)}),mb3.lastOpenedCallBack=function(){mb3.showListOfMoviesByIMDBRating(n.imdbRating)}}),void 0)})},showListOfMoviesByIMDBRating:function(e){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var t=[];e=parseInt(e,10),mb3.loadGeniusResults(function(i){return $.each(i.Titles,function(i,n){if(util.isNumeric(n.CommunityRating)&&n.CommunityRating>0){var a=Math.floor(n.CommunityRating);if(a==e){var o="0";n.ProviderIds&&n.ProviderIds.Imdb&&(o="1"),t.push({textLabel:(0===n.WatchedPercentage?" ":"")+n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),detailTextLabel:(n.CommunityRating?n.CommunityRating+"/10 ":"")+(n.Overview?n.Overview:""),icon:"none",sectionHeader:n.SortName.substring(0,1).toUpperCase(),image:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:n.Id,type:n.Type,imdb:o,sortName:n.SortName})}}}),0===t.length?(util.doAlert("No movies found for this rating."),void 0):(t.sort(util.dynamicSort("sortName")),mb3.createCustomTable(t,e.toString,function(){mb3.showListOfIMDBRating()},function(e){var i=t[e],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},showListOfUnwatched:function(){util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."});var e=[];mb3.loadGeniusResults(function(t){return $.each(t.Titles,function(t,i){if(0===i.UserData.PlayCount){var n="0";i.ProviderIds&&i.ProviderIds.Imdb&&(n="1"),e.push({textLabel:i.Name+(i.ProductionYear?" ("+i.ProductionYear+")":""),detailTextLabel:(i.CommunityRating?i.CommunityRating+"/10 ":"")+(i.Overview?i.Overview:""),icon:"none",sectionHeader:i.SortName.substring(0,1).toUpperCase(),image:mb3.getServiceUrl()+"/mediabrowser/Items/"+i.Id+"/Images/Primary?maxheight=120&maxwidth=120",guid:i.Id,type:i.Type,imdb:n,sortName:i.SortName})}}),0===e.length?(util.doAlert("No unwatched movies found."),void 0):(e.sort(util.dynamicSort("sortName")),mb3.createCustomTable(e,"Unwatched",function(){mb3.createInitialListView()},function(t){var i=e[t],n=$("<tr data-guid='"+i.guid+"' data-imdb='"+i.imdb+"'></tr>");mb3.playTitle($(n),i.textLabel,!1)}),void 0)})},startWorker:function(e,t){var i=2880,n=new Date,a=util.getItem("lastRefresh");a=null===a?new Date("2010-01-01T23:44:52.790Z"):new Date(a);var o=(n.getTime()-a.getTime())/6e4,r=!1;if(o>i&&(r=!0),!(e===!0&&r===!1||e===!1&&r===!1)){var s="It's been a while since you last refreshed, \nWould you like to refresh now?";t&&(s="Refresh Now?"),navigator.notification.confirm(s,function(e){1==e&&(util.doHud({show:!0,labelText:"Refreshing all Titles..."}),cordova.require("cordova/plugin/powermanagement").acquire(function(){mb3.loadGeniusResults(function(e){util.setStatusBarMessage("Searching for new titles");var t=mb3.getServiceUrl()+"/mediabrowser/Users/"+mb3.getUserId()+"/Items?format=json&recursive=true&IncludeItemTypes=Movie&Fields=Overview,ProviderId,Genres,SortName,Studios,People,Path,DateCreated";$.ajax({url:t,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(t){e.Titles={},$.each(t.Items,function(i){var n=t.Items[i],a=""+n.Id;e.Titles[a]=n}),cache.saveJson("genius",e),util.doHud({show:!1})},error:function(e,t,i){console.log(e),console.log(t),console.log(i)}})})},function(){})),2==e&&util.setItem("lastRefresh",(new Date).toISOString())},"gesturePad","Refresh,Maybe Later")}}},NowPlayingChannels=[],geniusResults={},MediaBrowserNowPlaying={xmlChannels:null,maxFutureItems:10,allItemsPopulated:!1,generateAllItems:function(){if(MediaBrowserNowPlaying.allItemsPopulated!==!0){util.doHud({show:!1}),util.doHud({show:!0,labelText:"Generating Channels",detailsLabelText:"For first use..."});var e=MediaBrowserNowPlaying.xmlChannels,t=[];NowPlayingChannels.length=0,$(e).find("nowplaying > channel").each(function(e){for(var i=$(this),n=parseInt($(i).attr("items"),10),a=0;n>a;a++){var o={};o.Title=$(i).attr("title"),o.node=$(this),o.idx=e,o.UpNext=[],NowPlayingChannels.push(o)}t.push({AllItems:[]})});var i=MediaBrowserNowPlaying.buildJSRuleSet();mb3.loadGeniusResults(function(e){$.each(e.Titles,function(e,n){$.each(i,function(e){i[e].match=!1,$.each(i[e].rules,function(t){i[e].rules[t].match=!1,$.each(i[e].rules[t].criteria,function(n){i[e].rules[t].criteria[n].match=!1})})}),$.each(NowPlayingChannels,function(e){var a=NowPlayingChannels[e];$.each(i[e].rules,function(t){$.each(i[e].rules[t].criteria,function(a){i[e].rules[t].criteria[a].match=MediaBrowserNowPlaying.doesItemMeetRule(n,i[e].rules[t].criteria[a].field,i[e].rules[t].criteria[a].operator,i[e].rules[t].criteria[a].val)})}),$.each(i[e].rules,function(t){var n=!0;$.each(i[e].rules[t].criteria,function(a){i[e].rules[t].criteria[a].match===!1&&(n=!1)}),i[e].rules[t].match=n}),$.each(i[e].rules,function(t){$.each(i[e].rules[t].criteria,function(){i[e].rules[t].match===!0&&(i[e].match=!0)})}),i[e].match===!0&&t[a.idx].AllItems.push({Id:n.Id,title:n.Name+(n.ProductionYear?" ("+n.ProductionYear+")":""),runtime:MediaBrowserNowPlaying.getRuntime(n),totalTicks:n.RunTimeTicks})
})})}),$.each(t,function(e){t[e].AllItems=util.shuffle(t[e].AllItems),t[e].position=-1}),cache.saveJson("NowPlayingMatchingItemsForChannel",t),MediaBrowserNowPlaying.allItemsPopulated=!0}},generateChannels:function(){cache.getJson("NowPlayingMatchingItemsForChannel",function(e){$.each(NowPlayingChannels,function(t){var i=NowPlayingChannels[t];if(i.UpNext=$.grep(i.UpNext,function(e,t){var n=i.UpNext[t];return new Date>n.ends?!1:!0}),0===i.UpNext.length){var n=i.idx,a=e[n].position;if(a+=1,a+1>e[n].AllItems.length&&(e[n].AllItems=util.shuffle(e[n].AllItems),a=0),e[n].position=a,e[n].AllItems.length>0){var o=e[n].AllItems[a].runtime,r=0;0===i.UpNext.length&&(r=util.randomFromInterval(0,o-10));var s={};s.starts=util.addMinutes(new Date,-1*r),s.ends=util.addMinutes(s.starts,o),s.title=e[n].AllItems[a].title,s.Id=e[n].AllItems[a].Id,s.totalTicks=e[n].AllItems[a].totalTicks,i.UpNext.push(s)}}}),$.each(NowPlayingChannels,function(t){var i=NowPlayingChannels[t];if(i.UpNext.length<MediaBrowserNowPlaying.maxFutureItems)for(var n=i.UpNext.length;MediaBrowserNowPlaying.maxFutureItems>=n;n++){var a=i.idx,o=e[a].position;if(o+=1,o+1>e[a].AllItems.length&&(e[a].AllItems=util.shuffle(e[a].AllItems),o=0),e[a].position=o,e[a].AllItems.length>0){var r=e[a].AllItems[o].runtime,s=0;0===i.UpNext.length&&(s=util.randomFromInterval(0,r-10));var l={};l.starts=util.addMinutes(new Date,-1*s),l.ends=util.addMinutes(l.starts,r),l.title=e[a].AllItems[o].title,l.Id=e[a].AllItems[o].Id,l.totalTicks=e[a].AllItems[o].totalTicks,i.UpNext.push(l)}}}),cache.saveJson("NowPlayingMatchingItemsForChannel",e)})},buildListView:function(){if(null===MediaBrowserNowPlaying.xmlChannels)return MediaBrowserNowPlaying.loadChannels(function(){MediaBrowserNowPlaying.buildListView()}),void 0;MediaBrowserNowPlaying.generateAllItems(),MediaBrowserNowPlaying.generateChannels();var e=[];cache.getJson("NowPlayingMatchingItemsForChannel",function(t){$.each(NowPlayingChannels,function(i){var n=NowPlayingChannels[i];if(1>=t[n.idx].AllItems.length||1>=n.UpNext.length)return!0;var a=n.UpNext[0],o=n.UpNext[1],r=[];$.each(n.UpNext,function(e,t){r.push(t.Id)});var s=(a.ends-new Date)/1e3,l=""+Math.floor(Math.abs(s/60));e.push({textLabel:a.title,detailTextLabel:"Time Left: "+l+" minutes \nUp Next: "+o.title,icon:"none",image:mb3.getServiceUrl()+"/mediabrowser/Items/"+a.Id+"/Images/Primary?maxheight=120&maxwidth=120",sectionHeader:n.Title,guid:a.Id,imdb:"",sortName:"",ends:a.ends,secondsLeft:s,totalTicks:a.totalTicks,playlist:r.join(",")})});var i=window.plugins.NativeTable;i.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"Now Playing",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!0,showToolBar:!0,MediaBrowserToolBar:!0}),i.onToolbarButtonClick(function(e){mb3.toolbarButtonClickEvent(e,i)}),i.onRightButtonTap(function(){i.hideTable(function(){})}),i.onBackButtonTap(function(){i.hideTable(function(){mb3.createInitialListView()})}),i.setRowSelectCallBackFunction(function(t){var i=e[t],n=i.secondsLeft,a=util.secondsToTicks(n),o=i.totalTicks;mb3.playByID(i.playlist,o-a)}),i.setTableData(e),util.doHud({show:!1}),i.showTable(function(){})})},getRuntime:function(e){var t=0;return e.RunTimeTicks&&(t=util.ticksToSeconds(e.RunTimeTicks)/60),t},compareArrayOfString:function(e,t,n){var a=!1;switch(t){case"equals":for(i=0;e.length>i;i++)e[i]===n&&(a=!0);break;case"first":e.length>=1&&e[0]===n&&(a=!0);break;case"contains":for(i=0;e.length>i;i++)e[i].indexOf(n)>-1&&(a=!0);break;case"not":var o=!1;for(i=0;e.length>i;i++)e[i]==n&&(o=!0);o===!1&&(a=!0);break;default:a=!1}return a},compareIntegers:function(e,t,i){var n=!1;switch(i=parseFloat(i,10),e=parseFloat(e,10),t){case"equals":e===i&&(n=!0);break;case"greaterthan":e>=i&&(n=!0);break;case"lessthan":i>=e&&(n=!0);break;default:n=!1}return n},compareStrings:function(e,t,i){var n=!1;switch(i=i.toLowerCase(),e=e.toLowerCase(),t){case"equals":i===e&&(n=!0);break;case"not":i!==e&&(n=!0);break;case"contains":e.indexOf(i)>-1&&(n=!0);break;case"notcontains":-1===e.indexOf(i)&&(n=!0);break;default:n=!1}return n},doesItemMeetRule:function(e,t,n,a){var o=!1;if(0===MediaBrowserNowPlaying.getRuntime(e))return!1;var r=[];switch(t){case"Genre":e.Genres&&(o=MediaBrowserNowPlaying.compareArrayOfString(e.Genres,n,a));break;case"Actor":if(e.People){for(i=0;e.People.length>i;i++)"Actor"===e.People[i].Type&&r.push(e.People[i].Name);o=MediaBrowserNowPlaying.compareArrayOfString(r,n,a)}break;case"Director":if(e.People){for(i=0;e.People.length>i;i++)"Director"===e.People[i].Type&&r.push(e.People[i].Name);o=MediaBrowserNowPlaying.compareArrayOfString(r,n,a)}break;case"Studios":if(e.Studios){for(i=0;e.Studios.length>i;i++)r.push(e.Studios[i].Name);o=MediaBrowserNowPlaying.compareArrayOfString(r,n,a)}break;case"Rating":e.CommunityRating&&(o=MediaBrowserNowPlaying.compareIntegers(e.CommunityRating,n,a));break;case"ProductionYearAge":if(e.ProductionYear&&4===(""+e.ProductionYear).length){var s=(new Date).getFullYear()-e.ProductionYear;o=MediaBrowserNowPlaying.compareIntegers(s,n,a)}break;case"ProductionYear":e.ProductionYear&&(o=MediaBrowserNowPlaying.compareIntegers(e.ProductionYear,n,a));break;case"FileDateAge":if(e.DateCreated){var l=Date.parse(e.DateCreated);if(!isNaN(l)){var c=(new Date-l)/864e5;o=MediaBrowserNowPlaying.compareIntegers(c,n,a)}}break;case"Folder":e.Path&&(e.Path.lastIndexOf("\\")>0?o=MediaBrowserNowPlaying.compareStrings(e.Path.substring(0,e.Path.lastIndexOf("\\")),n,a):e.Path.lastIndexOf("/")>0&&(o=MediaBrowserNowPlaying.compareStrings(e.Path.substring(0,e.Path.lastIndexOf("/")),n,a)));break;default:o=!1}return o},buildJSRuleSet:function(){var e=[];return $.each(NowPlayingChannels,function(t){var i=NowPlayingChannels[t];e.push({match:!1,rules:[]}),$(i.node).find("ruleSet").each(function(){var i={criteria:[],match:!1};$(this).find("rule").each(function(){var e={};e.field=$(this).attr("field"),e.val=$(this).find("value:first").text(),e.operator=$(this).find("compare:first").text(),e.match=!1,i.criteria.push(e)}),e[t].rules.push(i)})}),e},loadChannels:function(e){var t="xml/nowplaying.xml?r="+Math.random();$.ajax({type:"GET",url:t,dataType:"xml",success:function(t){MediaBrowserNowPlaying.xmlChannels=t,e()},error:function(){}})}},bottomDraw={bind:function(){var e=null;$("#boxCoverContainer").bind("scroll",function(){clearTimeout(e),e=setTimeout(function(){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=$(this).width();$("#covers > div.pendingImg").each(function(){var e=$(this).offset().left,i=$(this).width(),n=!1;if(n=0>e+i?!1:e>t?!1:!0,n===!0){$(this).removeClass("pendingImg");var a=$(this).find("img"),o=$(a).attr("data-guid"),r=$(a).attr("data-prefix"),s="MB_Small_"+o;$(a).onerror=function(){$(this).attr("src","img/nobox.png")},cache.getImage({id:s,url:r+o+"&maxwidth=120&maxheight=120"},function(e){var t=new Image;t.onerror=function(){$(a).attr("src","img/nobox.png")},e.cached===!1?(t.onload=function(){cache.saveImage({id:s,img:t}),$(a).attr("src",e.url)},t.src=e.url):$(a).attr("src",e.url)})}})}},200)}),$("#boxCoverContainer").bind("touchmove touchend",function(){window.scrollTo(0,0)}),$("#boxCoverBack").fastClick(function(){if(""!==$("#covers").data("back"))if("ChannelHome"==$("#covers").data("back"))bottomDraw.showBottomItems();else{var e=$("<a data-guid='"+$("#covers").data("back")+"' data-type='Folder' data-backwards='1' />");bottomDraw.showBottomItems(e)}}),$("#bottomGrabberKILL").bind("touchstart",function(e){var t=window.plugins.volumeSlider;t.hideVolumeSlider(1),e.originalEvent.touches[0].screenY,$(this).data("lastY",e.originalEvent.touches[0].screenY)}),$("#bottomGrabberKILL").bind("touchmove",function(e){e.stopImmediatePropagation(),e.preventDefault();var t=e.originalEvent.targetTouches[0],i=parseInt($(this).data("lastY"),10),n=parseInt($("#bottom").css("bottom"),10),a=140,o=0,r=-140;$(this).data("lastY",t.pageY),t.screenY>i?(o=n-(t.pageY-i),a>=o&&o>=0&&($("#bottom").css("bottom",o+"px"),$("#browser").css("bottom",r+o+"px"))):(o=n+(i-t.pageY),a>=o&&o>=0&&($("#bottom").css("bottom",o+"px"),$("#browser").css("bottom",r+o+"px")))}),$("#bottomGrabberKILL").bind("touchend",function(){sliders.resize(),setTimeout(function(){bottomDraw.refreshBottomDrawer()},100),setTimeout(function(){var e=window.plugins.volumeSlider;e.showVolumeSlider(1)},250)})},showBottomItems:function(e,t){var i="click";t&&(i=t);var n=util.getCurrentDevice(),a=70,o=!1,r={startCoverOpacity:.25,startCoverTop:"140px",endCoverOpacity:1,endCoverTop:"24px"};if("MCE"==n.shortname){var s=util.getMBUrl();if(e){if("Movie"==$(e).attr("data-type")||"Episode"==$(e).attr("data-type"))return"taphold"==i?MediaBrowser.playTitle($(e),$(e).parent().find("p").text(),!1):MediaBrowser.playTitle($(e),$(e).parent().find("p").text(),!0),void 0;$(e).hasAttr("data-backwards")&&(o=!0)}o&&(r={startCoverOpacity:.25,startCoverTop:"-164px",endCoverOpacity:1,endCoverTop:"24px"}),$("#covers").animate({opacity:r.startCoverOpacity,"margin-top":r.startCoverTop},250,function(){$("#covers").css("margin-top","24px").width($(window).width()),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>Loading Data...</p></div>").css("opacity","1").hide().fadeIn();var t=function(e){var t='<div style="width: 40px; height: 100%; float:left"> </div>';$("#covers").width(e.Data.Children.length*a+50),settings.moviesByDate&&"Folder"==e.Data.Type&&e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),!settings.userSettings.tvByDate||"Season"!=e.Data.Type&&"Series"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),$.each(e.Data.Children,function(i){t+='<div class="smallboxContainer pendingImg" >',e.Data.Children[i].IsFolder===!0&&e.Data.Children[i].RecentlyAddedUnplayedItemCount>0&&(t+='<div class="badge" >'+e.Data.Children[i].RecentlyAddedUnplayedItemCount+"</div>"),t+='<img data-prefix="'+util.getMBUrl()+"image/?Id="+'" data-guid="'+e.Data.Children[i].Id+'" data-type="'+e.Data.Children[i].Type+'" class="smallBox" src="img/nobox.png"  data-imdb="'+(e.Data.Children[i].ImdbRating>0?"1":"0")+'" />',t+="<p>"+e.Data.Children[i].Name+"</p>",t+="</div>"});var i=$("<div>"+t+"</div>");$(i).find("div.pendingImg").each(function(e){if(e>100)return!1;var t=$(this).find("img"),i=$(t).attr("data-guid"),n=$(t).attr("data-prefix"),a="MB_Small_"+i;$(t).onerror=function(){$(this).attr("src","img/nobox.png")},cache.getImage({id:a,url:n+i+"&maxwidth=120&maxheight=120"},function(e){var i=new Image;i.onerror=function(){$(t).attr("src","img/nobox.png")},e.cached&&($(t).attr("src",e.url),$(this).removeClass("pendingImg"))})}),$("#covers").css("margin-top","-130px").css("opacity","0.25"),$("#covers").empty().append($(i).children()),$("#covers img").each(function(){var e=$(this).attr("data-type");"Movie"==e||"Episode"==e?($(this).longclick(function(e){bottomDraw.showBottomItems(e.currentTarget,"taphold")},750),$(this).bind("click",function(){bottomDraw.showBottomItems($(this))})):$(this).bind("click",function(){$("#boxCoverBack").data("scrollPosition",$("#boxCoverContainer").scrollLeft()),bottomDraw.showBottomItems($(this))})}),$("#covers").animate({opacity:r.endCoverOpacity,"margin-top":r.endCoverTop},250,function(){$("#boxCoverBack").data("scrollPosition")&&o&&$("#boxCoverContainer").animate({scrollLeft:parseInt($("#boxCoverBack").data("scrollPosition"),10)},500),$("#boxCoverContainer").trigger("scroll");var t=e.Data.Name;"StartupFolder"==t?(t="Startup Folder",$("#covers").data("back","")):$("#covers").data("back",e.Data.parentId),$("#covers").data("loaded",!0),$("#bottomText > span:first").animate({opacity:0,"margin-left":"-100px"},250,function(){$("#bottomText > span:first").text(t),$("#bottomText > span:first").animate({opacity:1,"margin-left":"0px"},250)})})},i=function(e,i){return util.isWifi()===!1&&i?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>No data found.</p></div>"),void 0):($.ajax({url:e,dataType:"json",timeout:settings.MBServiceTimeout,success:function(n){cache.saveJson(e,n),i&&t(n)},error:function(){i&&(util.doAlert("The server is not responding in time, and no cached version exists. Try again later"),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>No data found.</p></div>"))}}),void 0)};s+=e?"library/?lightData=1&Id="+$(e).attr("data-guid"):"library/",cache.getJson(s,function(e){null===e?i(s,!0):(t(e),i(s,!1))})})}if("DTV"==n.shortname){if(e){if("Movie"==$(e).attr("data-type")||"Episode"==$(e).attr("data-type"))return MediaBrowser.playTitle($(e),$(e).parent().find("p").text()),void 0;$(e).hasAttr("data-backwards")&&(o=!0)}r={startCoverOpacity:.25,startCoverTop:"140px",endCoverOpacity:1,endCoverTop:"24px"},o&&(r={startCoverOpacity:.25,startCoverTop:"-164px",endCoverOpacity:1,endCoverTop:"24px"}),$("#covers").animate({opacity:r.startCoverOpacity,"margin-top":r.startCoverTop},250,function(){$("#covers").css("margin-top","24px").width($(window).width()),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>Loading Data...</p></div>").css("opacity","1").hide().fadeIn();var t='<div style="width: 40px; height: 100%; float:left"> </div>';if(e){var i=$(e).attr("data-category"),n=0;$.each(guide.channels,function(e,a){a.category==i&&(t+='<div class="smallboxContainer" >',t+='<div class="channelContainer"><div data-minor="'+a.number+'" class="smallChannel" style="background-image: url('+a.logo+')" ></div></div>',t+="<p>"+a.fullname+"</p>",t+="</div>",n++)}),$("#covers").width(n*a+50)}else{var s=[];$.each(guide.channels,function(e,t){var i={category:t.category,logo:t.logo,name:t.fullname},n=!1;$.each(s,function(e,i){return i.category==t.category?(n=!0,!1):void 0}),n===!1&&s.push(i)}),$.each(s,function(e,i){t+='<div class="smallboxContainer" >',t+='<div class="channelContainer"><div data-category="'+i.category+'" class="smallChannel" style="background-image: url('+i.logo+')" ></div></div>',t+="<p>"+i.category+"</p>",t+="</div>"}),$("#covers").width(s.length*a+50)}var l=$("<div>"+t+"</div>");$("#covers").css("margin-top","-130px").css("opacity","0.25"),$("#covers").empty().append($(l).children()),$("#covers div.smallChannel").fastClick(function(){$(this).hasAttr("data-category")?($("#boxCoverBack").data("scrollPosition",$("#boxCoverContainer").scrollLeft()),bottomDraw.showBottomItems($(this))):DirecTV.changeChannel($(this).attr("data-minor"))}),$("#covers").animate({opacity:r.endCoverOpacity,"margin-top":r.endCoverTop},250,function(){$("#boxCoverBack").data("scrollPosition")&&o&&$("#boxCoverContainer").animate({scrollLeft:parseInt($("#boxCoverBack").data("scrollPosition"),10)},500);var t="Categories";e?($("#covers").data("back","ChannelHome"),t=$(e).attr("data-category")):$("#covers").data("back",""),$("#covers").data("loaded",!0),$("#bottomText > span:first").animate({opacity:0,"margin-left":"-100px"},250,function(){$("#bottomText > span:first").text(t),$("#bottomText > span:first").animate({opacity:1,"margin-left":"0px"},250)})})})}},refreshBottomDrawer:function(){var e=140,t=parseInt($("#bottom").css("bottom"),10);t>e/3?($("#bottom").animate({bottom:"140px"},{duration:200,queue:!1}),$("#browser").animate({bottom:"-1px"},{duration:200,queue:!1,complete:function(){""!==$("#covers").data("back")&&void 0!==$("#covers").data("back")||$("#covers").data("loaded")!==!1&&void 0!==$("#covers").data("loaded")||bottomDraw.showBottomItems()}})):($("#bottom").animate({bottom:"0px"},{duration:200,queue:!1}),$("#browser").animate({bottom:"-140px"},{duration:200,queue:!1,complete:function(){(""===$("#covers").data("back")||void 0===$("#covers").data("back"))&&($("#covers").data("loaded",!1),$("#bottomText span").html("&nbsp;"),$("#covers").html("&nbsp;"))}}))},updateBottomContents:function(){$("#covers").data("back",""),$("#covers").data("loaded",!1),$("#bottomText span").html("&nbsp;"),$("#covers").html("&nbsp;"),bottomDraw.refreshBottomDrawer()}},cache={clear:function(e){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(t){var n=t.root.createReader();n.readEntries(function(t){for(i=0;t.length>i;i++){var n=t[i].name.split(".").pop();n===e&&"NowPlayingMatchingItemsForChannel.json"!==t[i].name&&t[i].remove(null,null)}},function(){})},function(){console.log("Pull cache Error, no access to file system"),callback({cached:!1,url:request.url})})},getImage:function(e,t){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(i){i.root.getFile(e.id+".cache",{create:!1,exclusive:!1},function(i){i.file(function(e){var i=new FileReader;i.onloadend=function(e){t({cached:!0,url:""+e.target.result})},i.readAsText(e)},function(){console.log("Error reading Cached File"),t({cached:!1,url:e.url})})},function(){t({cached:!1,url:e.url})})},function(){console.log("Pull cache Error, no access to file system"),t({cached:!1,url:e.url})})},saveImage:function(e){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(t){t.root.getFile(e.id+".cache",{create:!0,exclusive:!1},function(t){t.createWriter(function(t){t.onwriteend=function(){},t.write(cache.getBase64Image(e.img))},function(){console.log("Write to Cache Error")})},function(){console.log("Error initiating cached file")})},function(){console.log("Save cache Error, no access to file system")})},getBase64Image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");i.drawImage(e,0,0);var n=t.toDataURL("image/png");return n},getJson:function(e,t){var i=e.replace("http://","");i=i.substring(i.indexOf("/")+1),i=i.replace(/\//g,"-"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getFile(i+".json",{create:!1,exclusive:!1},function(e){e.file(function(e){var i=new FileReader;i.onloadend=function(e){t(jQuery.parseJSON(""+e.target.result))},i.readAsText(e)},function(){console.log("Error reading Cached File"),t(null)})},function(){t(null)})},function(){console.log("Pull cache Error, no access to file system"),t(null)})},saveJson:function(e,t){if(null!==t){var i=e.replace("http://","");i=i.substring(i.indexOf("/")+1),i=i.replace(/\//g,"-"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getFile(i+".json",{create:!0,exclusive:!1,append:!1},function(e){e.createWriter(function(e){e.onwriteend=function(){},e.write(JSON.stringify(t))},function(){console.log("Write to Cache Error")})},function(){console.log("Error initiating cached json file")})},function(){console.log("Save cache Error, no access to file system")})}}},gestures={executeGestureByCommandName:function(e){var t=util.getCurrentRoom(),i=util.getCurrentDevice(),n=$(xml).find("gesturePad > rooms > room[index='"+t.index+"'] ~ roomgestures > gesture > device > command > name:contains('"+e+"'):first");if($(n).size()>0){var a=$(n).parent().parent().attr("shortname");$(xml).find("gesturePad > devices > device[shortname='"+a+"'] > commands > category > command > name:contains('"+e+"'):first").each(function(){actionNodes=$(this).parent().find("action"),i=util.getDeviceByShortName(a),gestures.doEvent("manual",actionNodes,i)})}else{var o=$(xml).find("gesturePad > devices > device[shortname='"+i.shortname+"'] > commands > category > command > name:contains('"+e+"'):first");1==$(o).size()&&(actionNodes=$(o).next(),gestures.doEvent("manual",actionNodes,i))}},doEvent:function(e,t,i){if(window.scrollTo(0,0),util.isWifi()===!1)return util.doAlert("You are not on Wifi. Connect to Wifi and try again"),void 0;util.clearCallers(!1);var n=util.getCurrentRoom(),a=util.getCurrentDevice();i!==void 0&&(a=i);var o=!0,r=!1,s=null;if("manual"!=e?($(xml).find("gesturePad > rooms > room[index='"+n.index+"'] ~ roomgestures > gesture[definition='"+e+"'] > device:first").each(function(){var e=$(this).attr("shortname"),t=$(this).find("command > name").text();$(xml).find("gesturePad > devices > device[shortname='"+e+"'] > commands > category > command > name:contains('"+t+"'):first").each(function(){r=!0,o=!0,s=$(this).parent().find("action"),a=util.getDeviceByShortName(e)})}),r===!1&&$(xml).find("gesturePad > devices > device[shortname='"+a.shortname+"'] > commands > category > command > gesture[definition='"+e+"']:first").each(function(){o=!0,s=$(this).parent().find("action")})):s=$(t),null===s&&(o=!1),o){util.playBeep();var l=$(s).parent().find("name:first").text();util.showNotification(l,e);var c=$(s).size()-1;$(s).each(function(e){var t=$(s),i="http://"+a.IPAddress+":"+a.Port+"/";$(this).find("addtobaseurl:first").each(function(){i+=$(this).text()}),$(this).find("replacebaseurl:first").each(function(){i=$(this).text()}),-1===i.indexOf(":8080")&&(appendOncetoQueryString+="&room="+n.name),$.ajax({type:$(this).find("method:first").text(),url:i,data:$(this).find("data:first").text()+appendOncetoQueryString,timeout:15e3,dataType:$(this).find("dataType:first").text(),success:function(){appendOncetoQueryString="",e==c&&$(t).find("onCompleteSetDevice").size()>0&&(util.setDeviceByShortName($(t).find("onCompleteSetDevice").attr("shortname")),util.updateStatus()),("Stop"==l||l.indexOf("channel")>-1)&&ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},1500)},error:function(){appendOncetoQueryString="",e==c&&(util.showNotification(l,"❌ No response from server"),$(t).find("onCompleteSetDevice").size()>0&&(util.setDeviceByShortName($(t).find("onCompleteSetDevice").attr("shortname")),util.updateStatus()))}})})}else util.showNotification("Unassigned","Gesture doesnt exist")}},xml,appSettings,appendOncetoQueryString="",npTimer,inputTimer,clickEventType,guide={},workerTimer=null,scrollstop=null,init={PhoneGapReady:function(){document.addEventListener("deviceready",init.onDeviceReady,!1),document.addEventListener("resume",init.onResume,!1),document.addEventListener("pause",init.onBackground,!1),window.onorientationchange=util.detectOrientation,window.onresize=util.detectOrientation,window.onerror=function(e,t,i){console.log("\n\n"+e+"\n"+t+"\nline "+i+"\n\n\n"),util.doHud({show:!1})}},onDeviceReady:function(){util.splash("show"),$.gestures.init(),$.gestures.retGesture(function(e){gestures.doEvent(e)}),ui.initiateBindings(),util.doResize(),notify.init(),notify.clearAllBadges(),settings.loadSettings(),settings.userSettings.isSetup!==!1&&(DirecTV.hasDirecTV()&&DirecTV.loadChannelList(),util.splash("hide"),npTimer=setInterval(function(){ui.queryNowPlaying(),util.getRoomStatus()},3e4),mb3.authenticateUser("treason","urchin"),window.scrollTo(0,0),util.checkForYouTubeLink())},onResume:function(){settings.checkSettingsForUpdate(),settings.userSettings.isSetup!==!1&&(util.getRoomStatus(),DirecTV.startWorker(),ui.queryNowPlaying(),util.checkForYouTubeLink())},onBackground:function(){},loadXML:function(){var e=settings.userSettings.configURL+"?r="+Math.random();$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){xml=e,util.setItem("configURL",settings.userSettings.configURL)},error:function(){util.doAlert("Fatal error loading xml settings: "+e)}})}},notify={init:function(){var e=window.plugins.pushNotification;e.registerDevice({alert:!0,badge:!0,sound:!1},function(e){console.log("registerDevice: "+e.deviceToken)})},clearAllBadges:function(){var e=window.plugins.pushNotification;e.setApplicationIconBadgeNumber(0,function(){}),e.cancelAllLocalNotifications(function(){})}},settings={userSettings:{},loadSettings:function(){return settings.userSettings=settings.getSettingsObject(),settings.userSettings.isSetup===!1?!1:(settings.userSettings.deviceIndex=util.getItem("deviceIndex",0),settings.userSettings.roomIndex=util.getItem("roomIndex",0),(util.isNumeric(settings.userSettings.roomIndex)===!1||util.isNumeric(settings.userSettings.deviceIndex)===!1)&&(util.setItem("roomIndex",0),util.setItem("deviceIndex",0),settings.userSettings.roomIndex=0,settings.userSettings.deviceIndex=0),util.setItem("configURL",""),util.getItem("configURL","")!=settings.userSettings.configURL&&init.loadXML(),util.updateStatus(),util.getRoomStatus(),void 0)},getSettingsObject:function(){var e={sounds:!1,vibrate:!1,wifi:!0,SleepThreshold:6e4,MBServiceTimeout:12e4,moviesByDate:!1,tvByDate:!1,configURL:"xml/Custom.xml",roomIndex:0,deviceIndex:0,isSetup:!0,rooms:[]};return window.plugins.applicationPreferences.get("All",function(t){var i=!1;appSettings=t;var n=jQuery.parseJSON(t);1==n.sounds&&(e.sounds=!0),1==n.vibrate&&(e.vibrate=!0),e.wifi=1==n.wifi?!0:!1,1==n.dateMovies&&(e.moviesByDate=!0),1==n.dateTV&&(e.tvByDate=!0),1==n.config_source?e.configURL="mbeg.xml":2==n.config_source?e.configURL="mbegdt.xml":3==n.config_source&&(e.configURL=n.custom_config);for(var a=1;5>=a;a++)if(n["S"+a+"_enabled"]&&1==n["S"+a+"_enabled"]){i=!0;var o={name:"Room "+a,index:a-1,DTV:null,IR:!1,devices:[]};o.name=n["S"+a+"_RoomName"],o.devices.push({name:"Movies",shortname:"MCE",IPAddress:n["S"+a+"_IP"],Port:n["S"+a+"_EGPort"],ServicePort:n["S"+a+"_MBPort"],clientName:n["S"+a+"_Client"],timeshift:!0,index:0}),1==n["S"+a+"_DTV"]&&(o.DTV=n["S"+a+"_DTVIP"],o.devices.push({name:"Television",shortname:"DTV",IPAddress:n["S"+a+"_DTVIP"],Port:8080,timeshift:!1,index:1})),1==n["S"+a+"_EG"]&&(o.IR=!0),e.rooms.push(o)}i===!1&&(e.isSetup=!1,util.doAlert("No Servers are defined. Go to settings to add a server."),util.splash("hide")),e.roomIndex=util.getItem("roomIndex",0),e.deviceIndex=util.getItem("deviceIndex",0)}),e},checkSettingsForUpdate:function(){window.plugins.applicationPreferences.get("All",function(e){e!=appSettings&&(util.doAlert("Your settings have changed. Quit the app from the app switcher to reload."),util.reloadPage())})}},sliders={sendVolumeChange:function(e,t){appendOncetoQueryString="&"+e,gestures.executeGestureByCommandName(t)},sendSeekEvent:function(e){var t=util.getCurrentDevice();if("MCE"==t.shortname){var i=mb3.getServiceUrl();i+="/mediabrowser/Sessions/"+mb3.config.clientId+"/Playing/seek?SeekPositionTicks="+e,console.log(i),$.ajax({url:i,type:"POST",success:function(e){console.log(e),setTimeout(function(){ui.queryNowPlaying()},1500)}})}}},ui={screenShotMode:!1,nowPlaying:{url:"",navTitle:"gesturePad",navSubTitle:"",duration:0},initiateBindings:function(){ui.view=window.plugins.GestureView,ui.view.create(),$("body").bind("touchmove",function(e){e.preventDefault()}),ui.bindButtons()},bindButtons:function(){ui.view.bind("rightNavButtonTap",function(){window.scrollTo(0,0),util.getCurrentRoom();var e=util.getCurrentDevice();if("DTV"==e.shortname){var t=[],i=0;$.each(guide.channels,function(e,n){var a="";n.ending>0&&(a=new Date(1e3*n.ending).timeNow());var o={textLabel:""===n.nowplaying?n.fullname:n.nowplaying,detailTextLabel:n.number+" "+n.fullname+(""===a?"":", ends at "+a),icon:"none",sectionHeader:n.category,major:n.number};""!==n.logo&&(o.image="www/"+n.logo),DirecTV.recentChannels.length>0&&n.number==DirecTV.recentChannels[0]&&(i=e),t.push(o)});var n=window.plugins.NativeTable;n.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"TV",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1,showToolBar:!0}),n.onToolbarButtonClick(function(e){if(1==e){var t=DirecTV.recentChannels.slice(1,5),i=[];if($.each(t,function(e,t){i.push(DirecTV.getTitleForChannel(t))}),i.length>=1){var a=window.plugins.actionSheet;i.push("Cancel"),a.create({title:"Recent Channels",items:i,destructiveButtonIndex:i.length-1},function(e,n){-1!=n&&n!=i.length-1&&DirecTV.changeChannel(t[n])})}}2==e&&gestures.executeGestureByCommandName("VolumeDown"),3==e&&gestures.executeGestureByCommandName("VolumeUp"),4==e&&n.hideTable(function(){util.setDeviceByShortName("MCE"),ui.view.trigger("rightNavButtonTap")}),5==e&&n.hideTable(function(){ui.view.trigger("rightNavButtonTap")})}),n.onRightButtonTap(function(){n.hideTable(function(){})}),n.setRowSelectCallBackFunction(function(e){var i=t[e];DirecTV.changeChannel(i.major)}),n.setTableData(t),n.showTable(function(){n.scrollTo({index:i})})}"MCE"==e.shortname&&(util.doHud({show:!0,labelText:"Loading Data...",detailsLabelText:"Please Wait..."}),setTimeout(function(){mb3.lastOpenedCallBack()},200))}),ui.view.bind("leftNavButtonTap",function(){var e=[],t=util.getCurrentRoom(),i=util.getCurrentDevice(),n="",a=$(xml).find('gesturePad > rooms > room[index="'+t.index+'"] ~ roomgestures > gesture > device');if($(a).size()>0){n="Global Commands";var o=[];$(a).each(function(){var i=$(this);$(this).children("name:first").text(),t.name,$(i).find("command").each(function(){var t=$(this).children("name:first").text(),a="";a=$(i).parent().attr("definition"),"nothing"==a&&(a=""),-1==jQuery.inArray(t,o)&&(o.push(t),e.push({textLabel:t,detailTextLabel:""===a?"No Gesture Defined":"👆 "+a,icon:"greyarrow",sectionHeader:n}))})})}$(xml).find('gesturePad > devices > device[shortname="'+i.shortname+'"]').each(function(){var i=$(this);$(this).children("name:first").text(),t.name,$(i).find("command").each(function(){$(this).find("action");var t="",i=$(this).children("name:first").text();$(this).find("gesture").each(function(e){0===e&&(t="",t=$(this).attr("definition"))}),n!=$(this).parent().children("name:first").text()&&(n=$(this).parent().children("name:first").text()),e.push({textLabel:i,detailTextLabel:""===t?"No Gesture Defined":"👆 "+t,icon:"greyarrow",sectionHeader:n})})});var r=window.plugins.NativeTable;r.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:t.name,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1}),r.onRightButtonTap(function(){r.hideTable(function(){})}),r.onBackButtonTap(function(){r.hideTable(function(){})}),r.setRowSelectCallBackFunction(function(t){gestures.executeGestureByCommandName(e[t].textLabel)}),r.setTableData(e),r.showTable(function(){})}),ui.view.bind("configButtonTap",function(){var e=window.plugins.actionSheet,t=[];t.push("Clear Item Cache"),t.push("Clear Image Cache"),t.push("Refresh All Items"),t.push("Refresh Custom TV"),t.push("Play URL"),t.push("Cancel"),e.create({title:"Actions",items:t,destructiveButtonIndex:t.length-1},function(e,i){if(-1!=i&&i!=t.length-1)switch(i){case 0:cache.clear("json"),util.setItem("lastRefresh","2010-01-01T23:44:52.790Z"),util.doAlert("All Items Cleared");break;case 1:cache.clear("cache"),util.doAlert("All Images Cleared");break;case 2:util.setItem("lastRefresh","2010-01-01T23:44:52.790Z"),mb3.startWorker(!0,!0);break;case 3:mb3.allItemsPopulated=!1,util.doAlert("Custom TV Cleared");break;case 4:util.lastYouTubeURL="",util.setItem("lastYouTubeURL",""),util.checkForYouTubeLink()}})}),ui.view.bind("roomButtonTap",function(){for(var e=function(e){mb3.resetCallback(),settings.userSettings.roomIndex=e,settings.userSettings.deviceIndex=0,util.updateStatus(),util.getRoomStatus()},t=window.plugins.actionSheet,i=[],n=settings.userSettings.rooms,a=0;n.length>a;a++)i.push(n[a].name);i.push("Cancel"),t.create({title:"Change Room",items:i,destructiveButtonIndex:i.length-1},function(t,n){-1!=n&&n!=i.length-1&&e(n)})}),ui.view.bind("inputButtonTap",function(){for(var e=function(e){var t=util.getCurrentRoom();settings.userSettings.deviceIndex=e;var i=util.getCurrentDevice(),n=i.shortname;if(t.IR){util.setDeviceByShortName("MCE");var a=$(xml).find('gesturePad > devices > device[shortname="MCE"] > commands > category > command > action > onCompleteSetDevice[shortname="'+n+'"]:first');$(a).size()>0&&gestures.doEvent("manual",$(a).parent())}},t=window.plugins.actionSheet,i=[],n=util.getCurrentRoom().devices,a=0;n.length>a;a++)i.push(n[a].name);i.push("Cancel"),t.create({title:"Switch Input",items:i,destructiveButtonIndex:i.length-1},function(t,n){if(-1!=n&&n!=i.length-1){for(var a=util.getCurrentRoom().devices,o=0;a.length>o;o++)a[o].name===t&&(util.setDeviceByShortName(a[o].shortname),ui.clearNowPlaying(),util.updateStatus());e(n)}})}),ui.view.bind("powerButtonTap",function(){gestures.executeGestureByCommandName("Power")}),ui.view.bind("playButtonTap",function(e){e?gestures.executeGestureByCommandName("Pause"):gestures.executeGestureByCommandName("Play")}),ui.view.bind("rewindButtonTap",function(){gestures.executeGestureByCommandName("Skip Back")
}),ui.view.bind("forwardButtonTap",function(){gestures.executeGestureByCommandName("Skip Forward")}),ui.view.bind("muteButtonTap",function(){gestures.executeGestureByCommandName("Mute")}),ui.view.bind("volumeChange",function(e){console.log(e);var t=20,i=Math.round(t-t*(e/100)),n=0;i>=t/2?(n=i-t/2,n>0&&(sliders.sendVolumeChange(n,"VolumeDown"),ui.view.setVolumeSlider({value:50}))):(n=t/2-i,n>0&&(sliders.sendVolumeChange(n,"VolumeUp"),ui.view.setVolumeSlider({value:50})))}),ui.view.bind("seekChange",function(e){if("MCE"==util.getCurrentDevice().shortname&&ui.nowPlaying.duration>0){e/=100;var t=Math.floor(ui.nowPlaying.duration*e);sliders.sendSeekEvent(t)}})},clearNowPlaying:function(){ui.view.setOptionsForView({durationStartText:"",durationEndText:"",durationSliderValue:0,duration:0,title:"",subTitle:"",url:""})},queryNowPlaying:function(){if(!ui.screenShotMode){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=mb3.getServiceUrl()+"/mediabrowser/Sessions?format=json";$.ajax({url:t,dataType:"json",timeout:1e4,success:function(t){var i=!1;$.each(t,function(t,n){if(n.DeviceId===e.clientName&&(mb3.config.clientId=n.Id,n.NowPlayingPositionTicks)){var a=n.NowPlayingItem.RunTimeTicks,o=n.NowPlayingPositionTicks,r=o/a,s=n.NowPlayingItem.Id,l=n.NowPlayingItem.Id;return ui.view.setOptionsForView({durationStartText:util.hms2(util.ticksToSeconds(o)),durationEndText:"-"+util.hms2(util.ticksToSeconds(a-o)),durationSliderValue:util.isNumeric(r)?Math.floor(100*r):0,guid:l,currentID:s,title:n.NowPlayingItem.Name,subTitle:n.Client+" "+n.NowPlayingItem.Type,duration:a,controller:e.clientName,url:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.NowPlayingItem.Id+"/Images/Primary",backdrop:mb3.getServiceUrl()+"/mediabrowser/Items/"+n.NowPlayingItem.Id+"/Images/Backdrop",isPlaying:n.IsPaused===!0?!1:!0}),i=!0,!1}}),i===!1&&ui.clearNowPlaying()},error:function(){ui.clearNowPlaying()}})}"DTV"==e.shortname&&$.ajax({type:"GET",url:"http://"+e.IPAddress+":"+e.Port+"/tv/getTuned",dataType:"json",timeout:1e4,success:function(e){if(!e.startTime||"0"==e.startTime)return ui.view.setOptionsForView({durationStartText:"",durationEndText:"",durationSliderValue:0,duration:0,url:""}),void 0;var t=e.offset/e.duration;DirecTV.addToRecentChannels(e.major),ui.view.setOptionsForView({durationStartText:util.hms2(e.offset),durationEndText:"-"+util.hms2(e.duration-e.offset),durationSliderValue:Math.floor(100*t),guid:null,currentID:null,title:e.title,item:e.callsign+e.major,subTitle:e.major+" "+e.callsign,duration:0,isPlaying:!1,url:"",backdrop:""}),$.ajax({type:"GET",url:"http://www.thetvdb.com/api/GetSeries.php?seriesname="+e.title,dataType:"xml",success:function(t){var i="";$(t).find("Data > Series > SeriesName").each(function(){return $(this).text().toLowerCase().replace(/\W/g,"").replace("the","")==e.title.toLowerCase().replace(/\W/g,"").replace("the","")?(i=$(this).parent().find("seriesid").text(),!1):void 0}),""!==i&&$.ajax({type:"GET",url:"http://thetvdb.com/api/77658293DB487350/series/"+i+"/",dataType:"xml",success:function(e){var t=$(e).find("poster:first");$(t).size()>0&&ui.view.setOptionsForView({url:"http://thetvdb.com/banners/_cache/"+$(t).text(),backdrop:"http://thetvdb.com/banners/_cache/"+$(t).text()})}})}})}})}}},util={showingHud:!1,doHud:function(e){if(!util.showingHud||!e.show){var t=window.plugins.progressHud;e.show?(util.showingHud=!0,t.show({mode:"indeterminate",labelText:e.labelText,detailsLabelText:e.detailsLabelText},function(){},e.tappedEvent?e.tappedEvent:function(){})):(util.showingHud=!1,t.hide())}},lastYouTubeURL:"",checkForYouTubeLink:function(){var e=util.getCurrentDevice();"MCE"==e.shortname&&window.plugins.clipboardPlugin.getText(function(e){if(/^http/.test(e)||/^smb/.test(e)||/^\\/.test(e)){if(util.lastYouTubeURL=util.getItem("lastYouTubeURL"),util.lastYouTubeURL==e)return;navigator.notification.confirm(e,function(t){if(util.lastYouTubeURL=e,util.setItem("lastYouTubeURL",e),1===t){var i=util.getEGBaseUrl()+"?YouTube&"+e;$.ajax({type:"GET",url:i})}},"Play Video","Yes,No")}})},compare:function(e,t){return e.catIndex<t.catIndex?-1:e.catIndex>t.catIndex?1:0},iOSVersion:function(){var e=window.device.version;return parseInt(e.split(".")[0],10)},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},ticksToMilliseconds:function(e){return 1*e/1e4},millisecondsToTicks:function(e){return 1e4*e},addMinutes:function(e,t){return new Date(e.getTime()+6e4*t)},parseDate:function(e){var t=e.split("/");return new Date(t[2],t[0]-1,t[1])},daydiff:function(e,t){return(t-e)/864e5},randomFromInterval:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},detectOrientation:function(){window.onorientationchange!==void 0&&util.doResize()},setSwipeThresholds:function(){"tablet"==deviceType&&(HorzLongSwipeThreshold=.5*$("#gestures_canvas").width(),VertLongSwipeThreshold=.5*$("#gestures_canvas").height()),"phone"==deviceType&&(HorzLongSwipeThreshold=.8*$("#gestures_canvas").width(),VertLongSwipeThreshold=.7*$("#gestures_canvas").height())},doResize:function(){var e=$(document).height(),t=$(document).width();$("#gestures_canvas").attr("height",e),$("#gestures_canvas").attr("width",t),$("#gestures_canvas").height(e),$("#gestures_canvas").width(t),setTimeout(function(){util.setSwipeThresholds()},1500)},executeObjC:function(e){var t=document.createElement("IFRAME");t.setAttribute("src",e),document.documentElement.appendChild(t),t.parentNode.removeChild(t),t=null},htmlEscape:function(e){return(e+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},splash:function(e){try{"hide"==e?navigator.splashscreen.hide():navigator.splashscreen.show()}catch(t){}},setStatusBarMessage:function(e){console.log(e),util.showNotification(e,"")},setStatusBarForceClear:function(){return},getEGBaseUrl:function(){for(var e=util.getCurrentRoom(),t=e.devices,i=0;t.length>i;i++)if("MCE"==t[i].shortname)return"http://"+t[i].IPAddress+":"+t[i].Port+"/";return""},getRandomMBServer:function(){for(var e=[],t=0;settings.userSettings.rooms.length>t;t++){devices=settings.userSettings.rooms[t].devices;for(var i=0;devices.length>i;i++)"MCE"==devices[i].shortname&&e.push("http://"+devices[i].IPAddress+":"+devices[i].ServicePort+"/mbwebapi/service/")}return e[Math.floor(Math.random()*e.length)]},getFirstMBServer:function(){for(var e="",t=0;settings.userSettings.rooms.length>t;t++){devices=settings.userSettings.rooms[t].devices;for(var i=0;devices.length>i;i++)if("MCE"==devices[i].shortname){e="http://"+devices[i].IPAddress+":"+devices[i].ServicePort+"/mbwebapi/service/";break}if(""!==e)break}return e},getMBUrl:function(){for(var e=util.getCurrentRoom(),t=e.devices,i=0;t.length>i;i++)if("MCE"==t[i].shortname)return"http://"+t[i].IPAddress+":"+t[i].ServicePort+"/mbwebapi/service/";return""},ticksToSeconds:function(e){return e/1e7},secondsToTicks:function(e){return 1e7*e},getCurrentDevice:function(){return settings.userSettings.rooms?settings.userSettings.rooms.length>0?settings.userSettings.rooms[settings.userSettings.roomIndex].devices.length>0?settings.userSettings.rooms[settings.userSettings.roomIndex].devices[settings.userSettings.deviceIndex]:null:null:void 0},getCurrentRoom:function(){return settings.userSettings.rooms[settings.userSettings.roomIndex]},getDeviceByShortName:function(e){for(var t=util.getCurrentRoom(),i=0;t.devices.length>i;i++)if(t.devices[i].shortname==e)return t.devices[i];return null},setDeviceByShortName:function(e){for(var t=util.getCurrentRoom(),i=0;t.devices.length>i;i++)if(t.devices[i].shortname==e)return settings.userSettings.deviceIndex=i,!0;return!1},getEpochTime:function(){var e=new Date;return Math.round(e.getTime())},epochToDateObject:function(e){return new Date(1e3*e)},getRoomStatus:function(){var e=util.getEGBaseUrl();$.ajax({type:"GET",dataType:"text",url:e,success:function(e){settings.userSettings.deviceIndex=0;try{var t=jQuery.parseJSON(e);if(""!==t.device){var i=util.getDeviceByShortName(t.device);settings.userSettings.deviceIndex=i.index}}catch(n){}util.updateStatus()}})},updateStatus:function(){if(ui.screenShotMode)return ui.view.setStatusBar({show:!1}),ui.view.setOptionsForView({navTitle:"",navSubTitle:""}),void 0;var e=util.getCurrentDevice(),t=util.getCurrentRoom();ui.view.setOptionsForView({navTitle:t.name,navSubTitle:e.name}),(util.getItem("deviceIndex")!=settings.userSettings.deviceIndex||util.getItem("roomIndex")!=settings.userSettings.roomIndex)&&ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},1500),util.setItem("deviceIndex",settings.userSettings.deviceIndex),util.setItem("roomIndex",settings.userSettings.roomIndex)},hms2:function(e){if(0>=e)return"0:00";try{return hours=parseInt(e/3600,10)%24,minutes=parseInt(e/60,10)%60,seconds=e%60,hours+":"+(10>minutes?"0"+minutes:minutes)}catch(t){return"0:00"}},clearCallers:function(e){if(e===!1){var t=$("#gestureCallback div.dofadeout-final");$(t).remove()}else $("#gestureCallback div").remove()},showNotification:function(e,t){ui.view.showNotification({title:e,subtitle:t})},doAlert:function(e){util.doHud({show:!1});try{navigator.notification.alert(e,null,"gesturePad")}catch(t){alert(e)}},isWifi:function(){if(settings.userSettings.wifi===!1)return!0;try{return"WiFi connection"==util.netState()?!0:!1}catch(e){return!0}},netState:function(){try{var e=navigator.connection.type,t={};return t[Connection.UNKNOWN]="Unknown connection",t[Connection.ETHERNET]="Ethernet connection",t[Connection.WIFI]="WiFi connection",t[Connection.CELL_2G]="Cell 2G connection",t[Connection.CELL_3G]="Cell 3G connection",t[Connection.CELL_4G]="Cell 4G connection",t[Connection.NONE]="No network connection",t[e]}catch(i){return"WiFi connection"}},setItem:function(e,t){localStorage.setItem(e,t)},getItem:function(e,t){try{return localStorage.getItem(e)}catch(i){return 2==arguments.length?t:""}},reloadPage:function(){console.log("reloading"),util.splash("show"),window.location.reload()},playBeep:function(){if(settings.userSettings.sounds)try{navigator.notification.beep()}catch(e){}if(settings.userSettings.vibrate)try{navigator.notification.vibrate(1e3)}catch(e){}},dynamicSort:function(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1,e.length-1)),function(i,n){var a=i[e]<n[e]?-1:i[e]>n[e]?1:0;return a*t}},shuffle:function(e){for(var t,i,n=e.length;n>0;)i=0|Math.random()*n--,t=e[n],e[n]=e[i],e[i]=t;return e}};$.fn.hasAttr=function(e){return void 0!==this.attr(e)},Date.prototype.timeNow=function(){var e="AM",t=this.getHours();return this.getHours()>12&&(e="PM",t-=12),0===t&&(t=12),e=t+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+" "+e,"0:00 AM"==e?"":e};