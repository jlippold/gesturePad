/*!  gesturePad 2013-05-25 */
var DirecTV={changeChannel:function(e){var t=util.getCurrentDevice();$.getJSON("http://"+t.IPAddress+":"+t.Port+"/tv/tune?major="+e,function(){ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},3e3)})},startWorker:function(){try{clearTimeout(workerTimer)}catch(e){}for(var t=[],n=0,a=0;settings.userSettings.rooms.length>a;a++)for(var i=0;settings.userSettings.rooms[a].devices.length>i;i++)"DTV"==settings.userSettings.rooms[a].devices[i].shortname&&(t[n]="http://"+settings.userSettings.rooms[a].devices[i].IPAddress+":"+settings.userSettings.rooms[a].devices[i].Port+"/",$.ajaxq("DTVWorker"+n),n+=1);n=0;var o=!1;$.each(guide.channels,function(e){var a=guide.channels[e],i="0:00";if(a.startTime>0&&a.duration>0&&(i=util.hms2(a.startTime+a.duration-Math.floor((new Date).getTime()/1e3))),""===a.nowplaying||"0:00"==i){a.nowplaying="";for(var r=!1;r===!1;)n>t.length-1&&(n=0),t[n].room!=util.getCurrentDevice().shortname&&(DirecTV.refreshChannel(t[n],"DTVWorker"+n,e),o=!0,r=!0),n+=1}}),o===!1&&(workerTimer=setTimeout(function(){DirecTV.startWorker()},3e4))},setupWorker:function(e){if(DirecTV.hasDirecTV()!==!1){guide.channels=[];var t="";$(e).find("channels > channel").each(function(){if(t!=$(this).find("number").text()){var n={};n.number=$(this).find("number").text(),n.logo=$(this).find("logo").text(),n.callsign=$(this).find("callsign").text(),n.nowplaying="",n.ending=0,n.timeleft="",n.fullname=$(this).find("fullname").text(),n.startTime=0,n.duration=0;var a=$(e).find("channels > favorites > category > number").filter(function(){return $(this).text()==n.number});$(a).size()>0?(n.category=$(a).parent().attr("name"),n.catIndex=parseInt($(a).parent().attr("idx"),10)):(n.category="Unsorted",n.catIndex=999),guide.channels.push(n),t=n.number}}),guide.channels.sort(util.compare),DirecTV.startWorker()}},hasDirecTV:function(){for(var e=!1,t=0;settings.userSettings.rooms.length>t;t++)if(null!==settings.userSettings.rooms[t].DTV){e=!0;break}return e},loadChannelList:function(){var e="xml/channellist.xml?r="+Math.random();$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){DirecTV.setupWorker(e)},error:function(){util.doAlert("Error loading channel list: "+e)}})},refreshChannel:function(e,t,n){var a=guide.channels[n];$.ajaxq(t,{url:e+"tv/getProgInfo",dataType:"json",type:"GET",timeout:1e4,data:"major="+a.number,success:function(e){a.nowplaying=e.title,a.startTime=e.startTime,a.duration=e.duration,a.timeleft=util.hms2(e.startTime+e.duration-Math.floor((new Date).getTime()/1e3)),a.ending=e.startTime+e.duration,DirecTV.checkIfWorkerIsComplete()},error:function(){console.log("Refresh Channel "+a.number+" Error "+e),document.ajaxq.q[t].shift(),DirecTV.checkIfWorkerIsComplete()}})},checkIfWorkerIsComplete:function(){var e=!0;$.each(document.ajaxq.q,function(t){document.ajaxq.q[t].length>1&&t.indexOf("DTVWorker")>-1&&(e=!1)}),e===!0&&(workerTimer=setTimeout(function(){DirecTV.startWorker()},3e4))}},MediaBrowser={playByID:function(e,t){if(2==e&&DoShuffle(),1==e){var n=util.getMBUrl();n+="ui?command=play&id="+t,$.getJSON(n,function(){setTimeout(function(){ui.queryNowPlaying()},1500)})}},playTitle:function(e,t,n){if(util.isWifi()===!1)return util.doAlert("You are not on Wifi. To play this title, connect to Wifi and try again"),void 0;var a=util.getMBUrl(),i="";if(n)i=$(e).attr("data-guid"),a+="ui?command=play&id="+i,$.getJSON(a,function(){setTimeout(function(){ui.queryNowPlaying()},1500)}),util.doAlert("Now Playing\n"+t);else{var o=window.plugins.actionSheet,r=["Play","Resume","View on Screen"];"1"==$(e).attr("data-imdb")&&r.push("View Imdb Page"),r.push("Cancel"),i=$(e).attr("data-guid");var s="Actions";void 0!==s&&(s=t),o.create({title:s,items:r,destructiveButtonIndex:r.length-1},function(e,t){if(-1!=t&&t!=r.length-1){switch(r[t]){case"Play":a+="ui?command=play&id="+i;break;case"Resume":a+="ui?command=resume&id="+i;break;case"View on Screen":a+="ui?command=navigatetoitem&id="+i;break;case"View Imdb Page":a=""}""!==a?$.getJSON(a,function(){setTimeout(function(){ui.queryNowPlaying()},1500)}):$.ajax({url:util.getMBUrl()+"library/?Id="+i+"&lightData=1",dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(e){e.Data.ImdbID?(cb=window.plugins.childBrowser,null!==cb&&cb.showWebPage("http://m.imdb.com/title/"+e.Data.ImdbID)):util.doAlert("Sorry, This title does not have an IMBD id")},error:function(){parse&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}})}})}},ShowItems:function(e,t){var n="click";t&&(n=t);var a=util.getMBUrl(),i=function(e){var t=[];!settings.userSettings.moviesByDate||"Folder"!=e.Data.Type&&"FavoriteFolder"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),!settings.userSettings.tvByDate||"Season"!=e.Data.Type&&"Series"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),$.each(e.Data.Children,function(n){"Folder"==e.Data.Children[n].Type||"Season"==e.Data.Children[n].Type||"Series"==e.Data.Children[n].Type||"FavoriteFolder"==e.Data.Children[n].Type?t.push({textLabel:e.Data.Children[n].Name,detailTextLabel:""+e.Data.Children[n].ChildCount+" total, "+(e.Data.Children[n].UnwatchedCount?e.Data.Children[n].UnwatchedCount+" not watched, ":"")+e.Data.Children[n].RecentlyAddedUnplayedItemCount+" new",icon:"greyarrow",sectionHeader:"StartupFolder"==e.Data.Name?"Folders":e.Data.Children[0].Type,guid:e.Data.Children[n].Id,type:e.Data.Children[n].Type,imdb:e.Data.Children[n].ImdbRating>0?"1":"0"}):t.push({textLabel:(0===e.Data.Children[n].WatchedPercentage?"🔹 ":"")+e.Data.Children[n].Name+(e.Data.Children[n].ProductionYear?" ("+e.Data.Children[n].ProductionYear+")":""),detailTextLabel:(e.Data.Children[n].ImdbRating?e.Data.Children[n].ImdbRating+"/10 ":"")+(e.Data.Children[n].TagLine?e.Data.Children[n].TagLine:""),icon:"none",sectionHeader:"StartupFolder"==e.Data.Name?"Folders":e.Data.Children[0].Type,guid:e.Data.Children[n].Id,type:e.Data.Children[n].Type,imdb:e.Data.Children[n].ImdbRating>0?"1":"0"})});var n=window.plugins.NativeTable;n.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"StartupFolder"==e.Data.Name?"Folders":e.Data.Name,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:"StartupFolder"!=e.Data.Name?!0:!1}),n.onRightButtonTap(function(){n.hideTable(function(){})}),n.setRowSelectCallBackFunction(function(e){var a=t[e];if("none"==a.icon){var i=$("<tr data-guid='"+a.guid+"' data-imdb='"+a.imdb+"'></tr>");MediaBrowser.playTitle($(i),a.textLabel,!1)}else n.hideTable(function(){MediaBrowser.ShowItems(a)})}),"StartupFolder"==e.Data.Name?n.onBackButtonTap(function(){}):n.onBackButtonTap(function(){n.hideTable(function(){MediaBrowser.ShowItems({type:"Folder",guid:e.Data.parentId})})}),n.setTableData(t),n.showTable(function(){})},o=function(e,t){return util.isWifi()===!1&&t?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),void 0):($.ajax({url:e,dataType:"json",timeout:settings.userSettings.MBServiceTimeout,success:function(n){null!==n.Data&&cache.saveJson(e,n),t&&i(n)},error:function(){t&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)};if("CustomFolder"==e.type){if("Genres"==e.folderType){for(var r=MediaBrowser.getAllGenres(),s=[],c=0;r.length>c;c++)s.push({textLabel:r[c],detailTextLabel:"",icon:"greyarrow",sectionHeader:"Categories",type:"CustomFolder",folderType:"Genres"});var l=window.plugins.NativeTable;l.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"StartupFolder"==x.Data.Name?"Folders":x.Data.Name,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:"StartupFolder"!=x.Data.Name?!0:!1})}}else a+="library/?lightData=1&Id="+e.guid,cache.getJson(a,function(e){null===e?o(a,!0):(i(e),o(a,!1))})},startWorker:function(){cache.getJSON("geniusWorker",function(e){null!==e&&(geniusResults=e);var t=util.getFirstMBServer();t+="library?lightData=0",console.log("making first genius request: "+t),$.ajax({url:t,dataType:"json",timeout:3e6,success:function(e){console.log("first req successful"),MediaBrowser.loopGeniusWorker(e)}})})},loopGeniusWorker:function(e){var t=util.getFirstMBServer(),n=function(e,t){var n=!1;return $.each(e,function(a){return e[a].Id==t?(n=!0,!1):void 0}),n};$.each(e.Data.Children,function(t){var a=e.Data.Children[t];("Movie"==a.Type||"Episode"==a.Type)&&(console.log("Saving: "+a.Id),n(geniusResults.allItems)===!1&&geniusResults.allItems.push(a))}),cache.saveJson("genius",geniusResults),$.each(e.Data.Children,function(n){var a=e.Data.Children[n];"Movie"!=a.Type&&"Episode"!=a.Type&&(console.log("Getting new folder: "+a.Id),$.ajaxq("geniusWorker",{url:t+"library?lightData=0&Id="+a.Id,dataType:"json",timeout:3e6,success:function(e){console.log("Looping new folder: "+a.Id),MediaBrowser.loopGeniusWorker(e)}}))})},getAllGenres:function(){var e=[];return $.each(geniusResults.allItems,function(t){var n=geniusResults.allItems[t];if(n.Genres)for(var a=0;n.Genres.length>a;a++)jQuery.inArray(n.Genre[a],e)===!1&&e.push(n.Genre[a])}),e.sort(),e},getAllYears:function(){var e=[];return $.each(geniusResults.allItems,function(t){var n=geniusResults.allItems[t];n.ProductionYear&&jQuery.inArray(n.ProductionYear,e)===!1&&e.push(n.ProductionYear)}),e.sort(),e}},bottomDraw={bind:function(){var e=null;$("#boxCoverContainer").bind("scroll",function(){clearTimeout(e),e=setTimeout(function(){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=$(this).width();$("#covers > div.pendingImg").each(function(){var e=$(this).offset().left,n=$(this).width(),a=!1;if(a=0>e+n?!1:e>t?!1:!0,a===!0){$(this).removeClass("pendingImg");var i=$(this).find("img"),o=$(i).attr("data-guid"),r=$(i).attr("data-prefix"),s="MB_Small_"+o;$(i).onerror=function(){$(this).attr("src","img/nobox.png")},cache.getImage({id:s,url:r+o+"&maxwidth=120&maxheight=120"},function(e){var t=new Image;t.onerror=function(){$(i).attr("src","img/nobox.png")},e.cached===!1?(t.onload=function(){cache.saveImage({id:s,img:t}),$(i).attr("src",e.url)},t.src=e.url):$(i).attr("src",e.url)})}})}},200)}),$("#boxCoverContainer").bind("touchmove touchend",function(){window.scrollTo(0,0)}),$("#boxCoverBack").fastClick(function(){if(""!==$("#covers").data("back"))if("ChannelHome"==$("#covers").data("back"))bottomDraw.showBottomItems();else{var e=$("<a data-guid='"+$("#covers").data("back")+"' data-type='Folder' data-backwards='1' />");bottomDraw.showBottomItems(e)}}),$("#bottomGrabber").bind("touchstart",function(e){e.originalEvent.touches[0].screenY,$(this).data("lastY",e.originalEvent.touches[0].screenY)}),$("#bottomGrabber").bind("touchmove",function(e){e.stopImmediatePropagation(),e.preventDefault();var t=e.originalEvent.targetTouches[0],n=parseInt($(this).data("lastY"),10),a=parseInt($("#bottom").css("bottom"),10),i=140,o=0,r=-140;$(this).data("lastY",t.pageY),t.screenY>n?(o=a-(t.pageY-n),i>=o&&o>=0&&($("#bottom").css("bottom",o+"px"),$("#browser").css("bottom",r+o+"px"))):(o=a+(n-t.pageY),i>=o&&o>=0&&($("#bottom").css("bottom",o+"px"),$("#browser").css("bottom",r+o+"px")))}),$("#bottomGrabber").bind("touchend",function(){setTimeout(function(){bottomDraw.refreshBottomDrawer()},100)})},showBottomItems:function(e,t){var n="click";t&&(n=t);var a=util.getCurrentDevice(),i=70,o=!1,r={startCoverOpacity:.25,startCoverTop:"140px",endCoverOpacity:1,endCoverTop:"24px"};if("MCE"==a.shortname){var s=util.getMBUrl();if(e){if("Movie"==$(e).attr("data-type")||"Episode"==$(e).attr("data-type"))return"taphold"==n?MediaBrowser.playTitle($(e),$(e).parent().find("p").text(),!1):MediaBrowser.playTitle($(e),$(e).parent().find("p").text(),!0),void 0;$(e).hasAttr("data-backwards")&&(o=!0)}o&&(r={startCoverOpacity:.25,startCoverTop:"-164px",endCoverOpacity:1,endCoverTop:"24px"}),$("#covers").animate({opacity:r.startCoverOpacity,"margin-top":r.startCoverTop},250,function(){$("#covers").css("margin-top","24px").width($(window).width()),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>Loading Data...</p></div>").css("opacity","1").hide().fadeIn();var t=function(e){var t='<div style="width: 40px; height: 100%; float:left"> </div>';$("#covers").width(e.Data.Children.length*i+50),settings.moviesByDate&&"Folder"==e.Data.Type&&e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),!settings.userSettings.tvByDate||"Season"!=e.Data.Type&&"Series"!=e.Data.Type||e.Data.Children.sort(function(e,t){return Date.parse(t.DateCreated)-Date.parse(e.DateCreated)}),$.each(e.Data.Children,function(n){t+='<div class="smallboxContainer pendingImg" >',e.Data.Children[n].IsFolder===!0&&e.Data.Children[n].RecentlyAddedUnplayedItemCount>0&&(t+='<div class="badge" >'+e.Data.Children[n].RecentlyAddedUnplayedItemCount+"</div>"),t+='<img data-prefix="'+util.getMBUrl()+"image/?Id="+'" data-guid="'+e.Data.Children[n].Id+'" data-type="'+e.Data.Children[n].Type+'" class="smallBox" src="img/nobox.png"  data-imdb="'+(e.Data.Children[n].ImdbRating>0?"1":"0")+'" />',t+="<p>"+e.Data.Children[n].Name+"</p>",t+="</div>"});var n=$("<div>"+t+"</div>");$(n).find("div.pendingImg").each(function(e){if(e>100)return!1;var t=$(this).find("img"),n=$(t).attr("data-guid"),a=$(t).attr("data-prefix"),i="MB_Small_"+n;$(t).onerror=function(){$(this).attr("src","img/nobox.png")},cache.getImage({id:i,url:a+n+"&maxwidth=120&maxheight=120"},function(e){var n=new Image;n.onerror=function(){$(t).attr("src","img/nobox.png")},e.cached&&($(t).attr("src",e.url),$(this).removeClass("pendingImg"))})}),$("#covers").css("margin-top","-130px").css("opacity","0.25"),$("#covers").empty().append($(n).children()),$("#covers img").each(function(){var e=$(this).attr("data-type");"Movie"==e||"Episode"==e?($(this).longclick(function(e){bottomDraw.showBottomItems(e.currentTarget,"taphold")},750),$(this).bind("click",function(){bottomDraw.showBottomItems($(this))})):$(this).bind("click",function(){$("#boxCoverBack").data("scrollPosition",$("#boxCoverContainer").scrollLeft()),bottomDraw.showBottomItems($(this))})}),$("#covers").animate({opacity:r.endCoverOpacity,"margin-top":r.endCoverTop},250,function(){$("#boxCoverBack").data("scrollPosition")&&o&&$("#boxCoverContainer").animate({scrollLeft:parseInt($("#boxCoverBack").data("scrollPosition"),10)},500),$("#boxCoverContainer").trigger("scroll");var t=e.Data.Name;"StartupFolder"==t?(t="Startup Folder",$("#covers").data("back","")):$("#covers").data("back",e.Data.parentId),$("#covers").data("loaded",!0),$("#bottomText > span:first").animate({opacity:0,"margin-left":"-100px"},250,function(){$("#bottomText > span:first").text(t),$("#bottomText > span:first").animate({opacity:1,"margin-left":"0px"},250)})})},n=function(e,n){return util.isWifi()===!1&&n?(util.doAlert("Sorry, you are not on Wifi, and this data is yet to be cached."),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>No data found.</p></div>"),void 0):($.ajax({url:e,dataType:"json",timeout:settings.MBServiceTimeout,success:function(a){cache.saveJson(e,a),n&&t(a)},error:function(){n&&(util.doAlert("The server is not responding in time, and no cached version exists. Try again later"),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>No data found.</p></div>"))}}),void 0)};s+=e?"library/?lightData=1&Id="+$(e).attr("data-guid"):"library/",cache.getJson(s,function(e){null===e?n(s,!0):(t(e),n(s,!1))})})}if("DTV"==a.shortname){if(e){if("Movie"==$(e).attr("data-type")||"Episode"==$(e).attr("data-type"))return MediaBrowser.playTitle($(e),$(e).parent().find("p").text()),void 0;$(e).hasAttr("data-backwards")&&(o=!0)}r={startCoverOpacity:.25,startCoverTop:"140px",endCoverOpacity:1,endCoverTop:"24px"},o&&(r={startCoverOpacity:.25,startCoverTop:"-164px",endCoverOpacity:1,endCoverTop:"24px"}),$("#covers").animate({opacity:r.startCoverOpacity,"margin-top":r.startCoverTop},250,function(){$("#covers").css("margin-top","24px").width($(window).width()),$("#covers").html("<div class='boxLoader'><p class='boxLoading'>Loading Data...</p></div>").css("opacity","1").hide().fadeIn();var t='<div style="width: 40px; height: 100%; float:left"> </div>';if(e){var n=$(e).attr("data-category"),a=0;$.each(guide.channels,function(e,i){i.category==n&&(t+='<div class="smallboxContainer" >',t+='<div class="channelContainer"><div data-minor="'+i.number+'" class="smallChannel" style="background-image: url('+i.logo+')" ></div></div>',t+="<p>"+i.fullname+"</p>",t+="</div>",a++)}),$("#covers").width(a*i+50)}else{var s=[];$.each(guide.channels,function(e,t){var n={category:t.category,logo:t.logo,name:t.fullname},a=!1;$.each(s,function(e,n){return n.category==t.category?(a=!0,!1):void 0}),a===!1&&s.push(n)}),$.each(s,function(e,n){t+='<div class="smallboxContainer" >',t+='<div class="channelContainer"><div data-category="'+n.category+'" class="smallChannel" style="background-image: url('+n.logo+')" ></div></div>',t+="<p>"+n.category+"</p>",t+="</div>"}),$("#covers").width(s.length*i+50)}var c=$("<div>"+t+"</div>");$("#covers").css("margin-top","-130px").css("opacity","0.25"),$("#covers").empty().append($(c).children()),$("#covers div.smallChannel").fastClick(function(){$(this).hasAttr("data-category")?($("#boxCoverBack").data("scrollPosition",$("#boxCoverContainer").scrollLeft()),bottomDraw.showBottomItems($(this))):DirecTV.changeChannel($(this).attr("data-minor"))}),$("#covers").animate({opacity:r.endCoverOpacity,"margin-top":r.endCoverTop},250,function(){$("#boxCoverBack").data("scrollPosition")&&o&&$("#boxCoverContainer").animate({scrollLeft:parseInt($("#boxCoverBack").data("scrollPosition"),10)},500);var t="Categories";e?($("#covers").data("back","ChannelHome"),t=$(e).attr("data-category")):$("#covers").data("back",""),$("#covers").data("loaded",!0),$("#bottomText > span:first").animate({opacity:0,"margin-left":"-100px"},250,function(){$("#bottomText > span:first").text(t),$("#bottomText > span:first").animate({opacity:1,"margin-left":"0px"},250)})})})}},refreshBottomDrawer:function(){var e=140,t=parseInt($("#bottom").css("bottom"),10);t>e/3?($("#bottom").animate({bottom:"140px"},{duration:200,queue:!1}),$("#browser").animate({bottom:"-1px"},{duration:200,queue:!1,complete:function(){""!==$("#covers").data("back")&&void 0!==$("#covers").data("back")||$("#covers").data("loaded")!==!1&&void 0!==$("#covers").data("loaded")||bottomDraw.showBottomItems()}})):($("#bottom").animate({bottom:"0px"},{duration:200,queue:!1}),$("#browser").animate({bottom:"-140px"},{duration:200,queue:!1,complete:function(){(""===$("#covers").data("back")||void 0===$("#covers").data("back"))&&($("#covers").data("loaded",!1),$("#bottomText span").html("&nbsp;"),$("#covers").html("&nbsp;"))}}))},updateBottomContents:function(){$("#covers").data("back",""),$("#covers").data("loaded",!1),$("#bottomText span").html("&nbsp;"),$("#covers").html("&nbsp;"),bottomDraw.refreshBottomDrawer()}},cache={clear:function(){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){var t=e.root.createReader();t.readEntries(function(e){for(i=0;e.length>i;i++)e[i].remove(null,null)},function(){})},function(){console.log("Pull cache Error, no access to file system"),callback({cached:!1,url:request.url})})},getImage:function(e,t){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(n){n.root.getFile(e.id+".cache",{create:!1,exclusive:!1},function(n){n.file(function(e){var n=new FileReader;n.onloadend=function(e){t({cached:!0,url:""+e.target.result})},n.readAsText(e)},function(){console.log("Error reading Cached File"),t({cached:!1,url:e.url})})},function(){t({cached:!1,url:e.url})})},function(){console.log("Pull cache Error, no access to file system"),t({cached:!1,url:e.url})})},saveImage:function(e){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(t){t.root.getFile(e.id+".cache",{create:!0,exclusive:!1},function(t){t.createWriter(function(t){t.onwriteend=function(){},t.write(cache.getBase64Image(e.img))},function(){console.log("Write to Cache Error")})},function(){console.log("Error initiating cached file")})},function(){console.log("Save cache Error, no access to file system")})},getBase64Image:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var a=t.toDataURL("image/png");return a},getJson:function(e,t){var n=e.replace("http://","");n=n.substring(n.indexOf("/")+1),n=n.replace(/\//g,"-"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getFile(n+".json",{create:!1,exclusive:!1},function(e){e.file(function(e){var n=new FileReader;n.onloadend=function(e){t(jQuery.parseJSON(""+e.target.result))},n.readAsText(e)},function(){console.log("Error reading Cached File"),t(null)})},function(){t(null)})},function(){console.log("Pull cache Error, no access to file system"),t(null)})},saveJson:function(e,t){if(null!==t){var n=e.replace("http://","");n=n.substring(n.indexOf("/")+1),n=n.replace(/\//g,"-"),window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(e){e.root.getFile(n+".json",{create:!0,exclusive:!1,append:!1},function(e){e.createWriter(function(e){e.onwriteend=function(){},e.write(JSON.stringify(t))},function(){console.log("Write to Cache Error")})},function(){console.log("Error initiating cached json file")})},function(){console.log("Save cache Error, no access to file system")})}}},gestures={executeGestureByCommandName:function(e){var t=util.getCurrentRoom(),n=util.getCurrentDevice(),a=$(xml).find("gesturePad > rooms > room[index='"+t.index+"'] ~ roomgestures > gesture > device > command > name:contains('"+e+"'):first");if($(a).size()>0){var i=$(a).parent().parent().attr("shortname");$(xml).find("gesturePad > devices > device[shortname='"+i+"'] > commands > category > command > name:contains('"+e+"'):first").each(function(){actionNodes=$(this).parent().find("action"),n=util.getDeviceByShortName(i),gestures.doEvent("manual",actionNodes,n)})}else{var o=$(xml).find("gesturePad > devices > device[shortname='"+n.shortname+"'] > commands > category > command > name:contains('"+e+"'):first");1==$(o).size()&&(actionNodes=$(o).next(),gestures.doEvent("manual",actionNodes,n))}},doEvent:function(e,t,n){if(window.scrollTo(0,0),util.isWifi()===!1)return util.doAlert("You are not on Wifi. Connect to Wifi and try again"),void 0;util.clearCallers(!1);var a=!0;0===$("#gestures_canvas:visible").size()&&(a=!1);var i=$("<div class='message' style='display:none' data-gest='"+e+"'><span class='i'></span> <span class='t'>"+e+"</span></div>");a&&$("#gestureCallback").append(i);var o=util.getCurrentRoom(),r=util.getCurrentDevice();n!==void 0&&(r=n);var s=!0,c=!1,l=null;if("manual"!=e?($(xml).find("gesturePad > rooms > room[index='"+o.index+"'] ~ roomgestures > gesture[definition='"+e+"'] > device:first").each(function(){var e=$(this).attr("shortname"),t=$(this).find("command > name").text();$(xml).find("gesturePad > devices > device[shortname='"+e+"'] > commands > category > command > name:contains('"+t+"'):first").each(function(){c=!0,s=!0,l=$(this).parent().find("action"),r=util.getDeviceByShortName(e)})}),c===!1&&$(xml).find("gesturePad > devices > device[shortname='"+r.shortname+"'] > commands > category > command > gesture[definition='"+e+"']:first").each(function(){s=!0,l=$(this).parent().find("action")})):l=$(t),null===l&&(s=!1),s){util.playBeep();var u=$(l).parent().find("name:first").text();$(i).find("span.t").text(u+" - "+$(i).attr("data-gest")),$(i).find("span.i").text("🔄"),$(i).show(),$(i).animate({opacity:1,width:"100%"},250,function(){var e=$(l).size()-1;$(l).each(function(t){var n=$(l),a="http://"+r.IPAddress+":"+r.Port+"/";$(this).find("addtobaseurl:first").each(function(){a+=$(this).text()}),$(this).find("replacebaseurl:first").each(function(){a=$(this).text()}),$.ajax({type:$(this).find("method:first").text(),url:a,data:$(this).find("data:first").text()+appendOncetoQueryString,timeout:6e4,dataType:$(this).find("dataType:first").text(),success:function(){appendOncetoQueryString="",t==e&&($(i).find("span.i").text("✅"),$(i).animate({opacity:0,width:"0%"},250,function(){$(n).find("onCompleteSetDevice").size()>0&&(util.setDeviceByShortName($(n).find("onCompleteSetDevice").attr("shortname")),util.updateStatus()),$(i).hide().remove()})),("Stop"==u||u.indexOf("channel")>-1)&&ui.clearNowPlaying(),setTimeout(function(){ui.queryNowPlaying()},1500)},error:function(){appendOncetoQueryString="",t==e&&($(i).find("span.i").text("❌"),$(i).animate({opacity:0,width:"0%"},250,function(){$(n).find("onCompleteSetDevice").size()>0&&(util.setDeviceByShortName($(n).find("onCompleteSetDevice").attr("shortname")),util.updateStatus()),$(i).hide().remove()}))}})})})}else $(i).find("span.i").text("❌"),$(i).find("span.t").text("Unassigned - "+$(i).attr("data-gest")),$(i).show(),$(i).animate({opacity:1,width:"100%"},250,function(){$(i).delay(500).animate({opacity:0,width:"0%"},500,function(){$(i).remove()})})}},xml,appSettings,appendOncetoQueryString="",npTimer,inputTimer,clickEventType,slideTimer,guide={},workerTimer=null,sleepTimer=null,scrollstop=null,geniusResults={allItems:[]},init={PhoneGapReady:function(){document.addEventListener("deviceready",init.onDeviceReady,!1),document.addEventListener("resume",init.onResume,!1),document.addEventListener("pause",init.onBackground,!1),window.onorientationchange=util.detectOrientation,window.onresize=util.detectOrientation,window.onerror=function(e,t,n){console.log("\n\n"+e+"\n"+t+"\nline "+n+"\n\n\n")}},onDeviceReady:function(){util.splash("show"),$.gestures.init(),$.gestures.retGesture(function(e){gestures.doEvent(e)}),util.doResize(),notify.init(),notify.clearAllBadges(),ui.initiateBindings(),settings.loadSettings(),npTimer=setInterval(function(){ui.queryNowPlaying(),util.getRoomStatus()},3e4),window.scrollTo(0,0)},onResume:function(){settings.checkSettingsForUpdate(),clearAllBadges(),util.getRoomStatus(),SleepDevice(!1),DirecTV.startWorker(),MediaBrowser.startWorker(),ui.queryNowPlaying(),npTimer=setInterval(function(){ui.queryNowPlaying()},3e4)},onBackground:function(){clearInterval(npTimer)},loadXML:function(){var e=settings.userSettings.configURL+"?r="+Math.random();$.ajax({type:"GET",url:e,dataType:"xml",success:function(e){xml=e,util.setItem("configURL",settings.userSettings.configURL)},error:function(){util.splash("hide"),util.doAlert("Error loading xml settings: "+e)}})}},notify={init:function(){var e=window.plugins.pushNotification;e.registerDevice({alert:!0,badge:!0,sound:!1},function(){})},clearAllBadges:function(){var e=window.plugins.pushNotification;e.setApplicationIconBadgeNumber(0,function(){}),e.cancelAllLocalNotifications(function(){})}},settings={userSettings:{},loadSettings:function(){settings.userSettings=settings.getSettingsObject(),settings.userSettings.deviceIndex=util.getItem("deviceIndex",0),settings.userSettings.roomIndex=util.getItem("roomIndex",0),(util.isNumeric(settings.userSettings.roomIndex)===!1||util.isNumeric(settings.userSettings.deviceIndex)===!1)&&(util.setItem("roomIndex",0),util.setItem("deviceIndex",0),settings.userSettings.roomIndex=0,settings.userSettings.deviceIndex=0),DirecTV.hasDirecTV()&&DirecTV.loadChannelList(),util.setItem("configURL",""),util.getItem("configURL","")!=settings.userSettings.configURL&&init.loadXML(),util.updateStatus(),util.getRoomStatus(),setTimeout(function(){util.splash("hide")},500)},getSettingsObject:function(){var e={sounds:!1,vibrate:!1,wifi:!0,SleepThreshold:6e4,MBServiceTimeout:12e4,moviesByDate:!1,tvByDate:!1,configURL:"mbeg.xml",roomIndex:0,deviceIndex:0,rooms:[]};return window.plugins.applicationPreferences.get("All",function(t){var n=!1;appSettings=t;var a=jQuery.parseJSON(t);1==a.sounds&&(e.sounds=!0),1==a.vibrate&&(e.vibrate=!0),0===a.wifi&&(e.wifi=!1),1==a.dateMovies&&(e.moviesByDate=!0),1==a.dateTV&&(e.tvByDate=!0),1==a.config_source?e.configURL="mbeg.xml":2==a.config_source?e.configURL="mbegdt.xml":3==a.config_source&&(e.configURL=a.custom_config);for(var i=1;5>=i;i++)if(a["S"+i+"_enabled"]&&1==a["S"+i+"_enabled"]){n=!0;var o={name:"Room "+i,index:i-1,DTV:null,IR:!1,devices:[]};o.name=a["S"+i+"_RoomName"],o.devices.push({name:"Movies",shortname:"MCE",IPAddress:a["S"+i+"_IP"],Port:a["S"+i+"_EGPort"],ServicePort:a["S"+i+"_MBPort"],timeshift:!0,index:0}),1==a["S"+i+"_DTV"]&&(o.DTV=a["S"+i+"_DTVIP"],o.devices.push({name:"Television",shortname:"DTV",IPAddress:a["S"+i+"_DTVIP"],Port:8080,timeshift:!1,index:1})),1==a["S"+i+"_EG"]&&(o.IR=!0),e.rooms.push(o)}n===!1&&(util.doAlert("No Servers are defined. Go to settings to add a server."),util.splash("hide")),e.roomIndex=util.getItem("roomIndex",0),e.deviceIndex=util.getItem("deviceIndex",0)}),e},checkSettingsForUpdate:function(){window.plugins.applicationPreferences.get("All",function(e){e!=appSettings&&(util.doAlert("Your settings have changed. Quit the app from the app switcher to reload."),util.reloadPage())})}},sliders={bindSliders:function(){$("#VolumeSliderSeek").bind("touchmove",function(e){e.preventDefault(),clearTimeout(slideTimer);var t=e.originalEvent,n=t.touches[0],a=$("#VolumeSlider").width(),i=n.pageX-50;i>a&&(i=a);var o=i/a,r=i-10;0>r&&(r=0),$("#VolumeSliderSeek").attr("style","left: "+r+"px"),$("#VolumeSliderh").attr("style","width: "+Math.floor(100*o)+"%");var s=20,c=Math.round(s-s*o),l=0;c>=s/2?(l=c-s/2,l>0&&($("#VolumeContainer").attr("data-command","VolumeDown"),$("#VolumeContainer").attr("data-sendval",l),3>l?($("#hud").hide(),$("#VolumeContainer").attr("data-sendval","0")):$("#hud").text("-"+l+"x").show())):(l=s/2-c,l>0&&($("#VolumeContainer").attr("data-command","VolumeUp"),$("#VolumeContainer").attr("data-sendval",l),3>l?($("#hud").hide(),$("#VolumeContainer").attr("data-sendval","0")):$("#hud").text("+"+l+"x").show()))}),$("#VolumeSliderSeek").bind("touchend",function(){"0"!=$("#VolumeContainer").attr("data-sendval")?sliders.doSlideEvent():sliders.resetVolumeSlider()}),$("#seekbarContainer").bind("touchmove",function(e){if(clearTimeout(slideTimer),"MCE"==util.getCurrentDevice().shortname){e.preventDefault();var t=e.originalEvent,n=t.touches[0],a=$("#slider").width(),i=n.pageX-50;i>a&&(i=a);var o=$("#timespanright").attr("data-duration");if(util.isNumeric(o)){var r=i/a;$("#timeseek").attr("style","left: "+(i-10)+"px"),$("#timebar").attr("style","width: "+Math.floor(100*r)+"%");var s=Math.floor(o*r);$(this).attr("data-sendval",s)}}}),$("#seekbarContainer").bind("touchend",function(){sliders.doSeekEvent()})},doSeekEvent:function(){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=$("#seekbarContainer").attr("data-sendval"),n=util.getMBUrl()+"ui?command=seek&value="+t+"&controllerName="+$("#timespanright").attr("data-controller");$.getJSON(n,function(){setTimeout(function(){ui.queryNowPlaying()},1500)})}},doSlideEvent:function(){appendOncetoQueryString="&"+$("#VolumeContainer").attr("data-sendval"),gestures.executeGestureByCommandName($("#VolumeContainer").attr("data-command")),sliders.resetVolumeSlider()},resetNPSeek:function(){$("#timeseek").attr("style","left: "+($("#timebar").width()-10)+"px")},resetVolumeSlider:function(){var e=$("#VolumeSlider").width(),t=.5*e;$("#hud").fadeOut(),$("#VolumeSliderSeek").attr("style","left: "+(t-10)+"px"),$("#VolumeSliderh").attr("style","width: "+100*(t/e)+"%")}},ui={initiateBindings:function(){$("#top, #toptrans, #overallVolumeContainer").bind("touchmove",function(e){e.preventDefault()}),ui.bindButtons(),sliders.bindSliders(),bottomDraw.bind()},bindButtons:function(){$("#btnTitles").fastClick(function(){window.scrollTo(0,0),$("#NowPlayingTitle").attr("data-item"),util.getCurrentRoom();var e=util.getCurrentDevice();if("DTV"==e.shortname){var t=[];$.each(guide.channels,function(e,n){var a="";n.ending>0&&(a=new Date(1e3*n.ending).timeNow()),t.push({textLabel:""===n.nowplaying?n.fullname:n.nowplaying,detailTextLabel:n.number+" "+n.fullname+(""===a?"":", ends at "+a),icon:"none",sectionHeader:n.category,major:n.number})
});var n=window.plugins.NativeTable;n.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"TV",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1}),n.onRightButtonTap(function(){n.hideTable(function(){})}),n.setRowSelectCallBackFunction(function(e){var n=t[e];DirecTV.changeChannel(n.major)}),n.setTableData(t),n.showTable(function(){})}if("MCE"==e.shortname){var a=function(e){var t=[];$.each(e.Data.Children,function(n){t.push({textLabel:e.Data.Children[n].Name,detailTextLabel:""+e.Data.Children[n].ChildCount+" total, "+e.Data.Children[n].UnwatchedCount+" not watched, "+e.Data.Children[n].RecentlyAddedUnplayedItemCount+" new",icon:"greyarrow",sectionHeader:"Folders",guid:e.Data.Children[n].Id,type:e.Data.Children[n].Type,imdb:e.Data.Children[n].ImdbRating})}),t.push({textLabel:"Genres",detailTextLabel:"Movies Separated By Genre",icon:"greyarrow",sectionHeader:"Categories",type:"CustomFolder",folderType:"Genres"}),t.push({textLabel:"Release Year",detailTextLabel:"Movies Separated By Production Year",icon:"greyarrow",sectionHeader:"Categories",type:"CustomFolder",folderType:"Years"});var n=window.plugins.NativeTable;n.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:"Movies",navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1}),n.onRightButtonTap(function(){n.hideTable(function(){})}),n.setRowSelectCallBackFunction(function(e){var a=t[e];n.hideTable(function(){MediaBrowser.ShowItems(a)})}),n.setTableData(t),n.showTable(function(){})},i=function(e,t){return util.isWifi()===!1&&t?(util.doAlert("You are not on Wifi and no cached version exists. To do this, connect to Wifi and try again"),$("#btnTitles").trigger("click"),void 0):($.ajax({url:e,dataType:"json",timeout:settings.MBServiceTimeout,success:function(n){cache.saveJson(e,n),t&&a(n)},error:function(){t&&util.doAlert("The server is not responding in time, and no cached version exists. Try again later")}}),void 0)},o=util.getMBUrl();o+="library/",cache.getJson(o,function(e){null===e?i(o,!0):(a(e),i(o,!1))})}}),$("#btnConfig").fastClick(function(){navigator.notification.confirm("Delete cached data?",function(e){1==e&&cache.clear()},"Warning","Yes, No")}),$("#btnCommands").fastClick(function(){var e=[],t=util.getCurrentRoom(),n=util.getCurrentDevice(),a="",i=$(xml).find('gesturePad > rooms > room[index="'+t.index+'"] ~ roomgestures > gesture > device');if($(i).size()>0){a="Global Commands";var o=[];$(i).each(function(){var n=$(this);$(this).children("name:first").text(),t.name,$(n).find("command").each(function(){var t=$(this).children("name:first").text(),i="";i=$(n).parent().attr("definition"),"nothing"==i&&(i=""),-1==jQuery.inArray(t,o)&&(o.push(t),e.push({textLabel:t,detailTextLabel:""===i?"No Gesture Defined":"👆 "+i,icon:"greyarrow",sectionHeader:a}))})})}$(xml).find('gesturePad > devices > device[shortname="'+n.shortname+'"]').each(function(){var n=$(this);$(this).children("name:first").text(),t.name,$(n).find("command").each(function(){$(this).find("action");var t="",n=$(this).children("name:first").text();$(this).find("gesture").each(function(e){0===e&&(t="",t=$(this).attr("definition"))}),a!=$(this).parent().children("name:first").text()&&(a=$(this).parent().children("name:first").text()),e.push({textLabel:n,detailTextLabel:""===t?"No Gesture Defined":"👆 "+t,icon:"greyarrow",sectionHeader:a})})});var r=window.plugins.NativeTable;r.createTable({height:$(window).height(),showSearchBar:!0,showNavBar:!0,navTitle:t.name,navBarColor:"black",showRightButton:!0,RightButtonText:"Close",showBackButton:!1}),r.onRightButtonTap(function(){r.hideTable(function(){})}),r.onBackButtonTap(function(){r.hideTable(function(){})}),r.setRowSelectCallBackFunction(function(t){gestures.executeGestureByCommandName(e[t].textLabel)}),r.setTableData(e),r.showTable(function(){})}),$("#btnRoom").fastClick(function(){for(var e=function(e){settings.userSettings.roomIndex=e,settings.userSettings.deviceIndex=0,util.updateStatus(),util.getRoomStatus()},t=window.plugins.actionSheet,n=[],a=settings.userSettings.rooms,i=0;a.length>i;i++)n.push(a[i].name);n.push("Cancel"),t.create({title:"Change Room",items:n,destructiveButtonIndex:n.length-1},function(t,a){-1!=a&&a!=n.length-1&&e(a)})}),$("#btnTransfer").fastClick(function(){for(var e=function(e){var t=util.getCurrentRoom();settings.userSettings.deviceIndex=e;var n=util.getCurrentDevice(),a=n.shortname;if(t.IR){util.setDeviceByShortName("MCE");var i=$(xml).find('gesturePad > devices > device[shortname="MCE"] > commands > category > command > action > onCompleteSetDevice[shortname="'+a+'"]:first');$(i).size()>0&&(gestures.doEvent("manual",$(i).parent()),util.getRoomStatus())}util.updateStatus()},t=window.plugins.actionSheet,n=[],a=util.getCurrentRoom().devices,i=0;a.length>i;i++)n.push(a[i].name);n.push("Cancel"),t.create({title:"Switch Input",items:n,destructiveButtonIndex:n.length-1},function(t,a){-1!=a&&a!=n.length-1&&e(a)})}),$("#btnPower").fastClick(function(){gestures.executeGestureByCommandName("Power")}),$("#btnPlay").fastClick(function(){$(this).hasClass("playing")?(gestures.executeGestureByCommandName("Pause"),$(this).removeClass("playing")):gestures.executeGestureByCommandName("Play")}),$("#btnMute").fastClick(function(){gestures.executeGestureByCommandName("Mute")})},clearNowPlaying:function(){$("#bgPic").attr("class","noart"),$("#bgPic").attr("style",""),$("#bgPic").attr("data-id",""),$("#timespanleft").text("0:00"),$("#timespanright").text("- 0:00"),$("#NowPlayingTitle").text(""),$("#NowPlayingTitle").removeClass("doMarquee"),$("#timeseek").attr("style","left: 0px"),$("#timebar").attr("style","width: 0%")},queryNowPlaying:function(){var e=util.getCurrentDevice();if("MCE"==e.shortname){var t=util.getMBUrl();$.ajax({url:t+"ui",dataType:"json",timeout:1e4,success:function(e){var n=0;try{n=e.Data.PlayingControllers[0].CurrentFileDuration.TotalSeconds}catch(a){return}if(e.Data.PlayingControllers.length>=1){n=e.Data.PlayingControllers[0].CurrentFileDuration.TotalSeconds;var i=e.Data.PlayingControllers[0].CurrentFilePosition.TotalSeconds,o=i/n;$("#timebar").attr("style","width: "+Math.floor(100*o)+"%"),$("#timeseek").attr("style","left: "+($("#timebar").width()-10)+"px"),$("#timespanleft").text(util.hms2(i)),$("#timespanright").text("- "+util.hms2(n-i)),$("#timespanright").attr("data-duration",e.Data.PlayingControllers[0].CurrentFileDuration.Ticks),$("#timespanright").attr("data-controller",e.Data.PlayingControllers[0].ControllerName),$("#NowPlayingTitle").text(e.Data.PlayingControllers[0].PlayableItems[0].DisplayName),parseInt($("#NowPlayingTitle")[0].scrollWidth,10)>parseInt($("#NowPlayingTitle").width(),10)?$("#NowPlayingTitle").attr("class","doMarquee"):$("#NowPlayingTitle").removeClass("doMarquee");var r=e.Data.PlayingControllers[0].PlayableItems[0].CurrentMediaIndex,s=e.Data.PlayingControllers[0].PlayableItems[0].MediaItemIds[r];if($("#bgPic").attr("data-id")!=s){var c="MB_Big_"+s;cache.getImage({id:c,url:t+"image/?Id="+s},function(e){var t=new Image;t.onerror=function(){$("#bgPic").attr("class","noart"),$("#bgPic").attr("style",""),$("#bgPic").attr("data-id",s)},e.cached===!1?(t.onload=function(){cache.saveImage({id:c,img:t}),$("#bgPic").attr("style","background-image: url("+e.url+");"),$("#bgPic").attr("class",""),$("#bgPic").attr("data-id",s)},t.src=e.url):($("#bgPic").attr("style","background-image: url("+e.url+");"),$("#bgPic").attr("class",""),$("#bgPic").attr("data-id",s))})}e.Data.PlayingControllers[0].IsPaused===!0?$("#btnPlay").removeClass("playing"):$("#btnPlay").addClass("playing")}else ui.clearNowPlaying()},error:function(){ui.clearNowPlaying()}})}"DTV"==e.shortname&&$.ajax({type:"GET",url:"http://"+e.IPAddress+":"+e.Port+"/tv/getTuned",dataType:"json",timeout:1e4,success:function(e){if(e.startTime){if("0"==e.startTime)return;var t=e.offset/e.duration;$("#timebar").attr("style","width: "+Math.floor(100*t)+"%"),$("#timeseek").attr("style","left: "+($("#timebar").width()-10)+"px"),$("#timespanleft").text(util.hms2(e.offset)),$("#timespanright").text("- "+util.hms2(e.duration-e.offset))}var n=e.major+" "+e.callsign+" "+e.title;$("#NowPlayingTitle").text(n),$("#NowPlayingTitle").attr("data-item",e.callsign+e.major),$("#NowPlayingTitle").attr("class",""),$.ajax({type:"GET",url:"http://www.thetvdb.com/api/GetSeries.php?seriesname="+e.title,dataType:"xml",error:function(){$("#bgPic").attr("class","noart"),$("#bgPic").attr("style","")},success:function(t){var n="";if($(t).find("Data > Series > SeriesName").each(function(){return $(this).text().toLowerCase().replace(/\W/g,"").replace("the","")==e.title.toLowerCase().replace(/\W/g,"").replace("the","")?(n=$(this).parent().find("seriesid").text(),!1):void 0}),""===n)$("#bgPic").attr("class","noart"),$("#bgPic").attr("style","");else{var a="TVDB_"+n;cache.getImage({id:a,url:""},function(e){e.cached===!1?$.ajax({type:"GET",url:"http://thetvdb.com/api/77658293DB487350/series/"+n+"/",dataType:"xml",error:function(){$("#bgPic").attr("class","noart"),$("#bgPic").attr("style","")},success:function(e){var t=$(e).find("poster:first");if($(t).size()>0){if($("#bgPic").attr("data-id")!=n&&""!==$(t).text()){$("#bgPic").attr("style","background-image: url('http://thetvdb.com/banners/_cache/"+$(t).text()+"');"),$("#bgPic").attr("class",""),$("#bgPic").attr("data-id",n);var i=new Image;i.onload=function(){cache.saveImage({id:a,img:i}),console.log("cached")},i.src="http://thetvdb.com/banners/_cache/"+$(t).text()}}else $("#bgPic").attr("class","noart"),$("#bgPic").attr("style","")}}):($("#bgPic").attr("style","background-image: url("+e.url+");"),$("#bgPic").attr("class",""),$("#bgPic").attr("data-id",n))})}}}),parseInt($("#NowPlayingTitle")[0].scrollWidth,10)>parseInt($("#NowPlayingTitle").width(),10)?$("#NowPlayingTitle").attr("class","doMarquee"):$("#NowPlayingTitle").removeClass("doMarquee")}})}},util={compare:function(e,t){return e.catIndex<t.catIndex?-1:e.catIndex>t.catIndex?1:0},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},detectOrientation:function(){window.onorientationchange!==void 0&&util.doResize()},setSwipeThresholds:function(){"tablet"==deviceType&&(HorzLongSwipeThreshold=.5*$("#gestures_canvas").width(),VertLongSwipeThreshold=.5*$("#gestures_canvas").height()),"phone"==deviceType&&(HorzLongSwipeThreshold=.8*$("#gestures_canvas").width(),VertLongSwipeThreshold=.7*$("#gestures_canvas").height())},doResize:function(){$("#card").height($("body").height()-($("#top").outerHeight()+$("#bottom").outerHeight()/3.5));var e=$("#container").height()-($("#top").outerHeight()+$("#bottom").outerHeight()+$("div.toptrans").outerHeight()-1),t=$("body").width();$("#gestures_canvas").attr("height",e),$("#gestures_canvas").attr("width",t),$("#gestures_canvas").height(e),$("#gestures_canvas").width(t),sliders.resetVolumeSlider(),sliders.resetNPSeek(),setTimeout(function(){util.setSwipeThresholds()},1500)},executeObjC:function(e){var t=document.createElement("IFRAME");t.setAttribute("src",e),document.documentElement.appendChild(t),t.parentNode.removeChild(t),t=null},htmlEscape:function(e){return(e+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},splash:function(e){try{"hide"==e?navigator.splashscreen.hide():navigator.splashscreen.show()}catch(t){}},getEGBaseUrl:function(){for(var e=util.getCurrentRoom(),t=e.devices,n=0;t.length>n;n++)if("MCE"==t[n].shortname)return"http://"+t[n].IPAddress+":"+t[n].Port+"/";return""},getFirstMBServer:function(){for(var e="",t=0;settings.userSettings.rooms.length>t;t++){devices=settings.userSettings.rooms[t].devices;for(var n=0;devices.length>n;n++)if("MCE"==devices[n].shortname){e="http://"+devices[n].IPAddress+":"+devices[n].ServicePort+"/mbwebapi/service/";break}if(""!==e)break}return e},getMBUrl:function(){for(var e=util.getCurrentRoom(),t=e.devices,n=0;t.length>n;n++)if("MCE"==t[n].shortname)return"http://"+t[n].IPAddress+":"+t[n].ServicePort+"/mbwebapi/service/";return""},getCurrentDevice:function(){return settings.userSettings.rooms?settings.userSettings.rooms.length>0?settings.userSettings.rooms[settings.userSettings.roomIndex].devices.length>0?settings.userSettings.rooms[settings.userSettings.roomIndex].devices[settings.userSettings.deviceIndex]:null:null:void 0},getCurrentRoom:function(){return settings.userSettings.rooms[settings.userSettings.roomIndex]},getDeviceByShortName:function(e){for(var t=util.getCurrentRoom(),n=0;t.devices.length>n;n++)if(t.devices[n].shortname==e)return t.devices[n];return null},setDeviceByShortName:function(e){for(var t=util.getCurrentRoom(),n=0;t.devices.length>n;n++)if(t.devices[n].shortname==e)return settings.userSettings.deviceIndex=n,!0;return!1},getRoomStatus:function(){var e=util.getEGBaseUrl();$.ajax({type:"GET",dataType:"text",url:e,success:function(e){settings.userSettings.deviceIndex=0;try{var t=jQuery.parseJSON(e);if(""!==t.device){var n=util.getDeviceByShortName(t.device);settings.userSettings.deviceIndex=n.index}}catch(a){}util.updateStatus()}})},updateStatus:function(){var e=util.getCurrentDevice(),t=util.getCurrentRoom();$("#txtDevice").text(e.name),$("#txtRoom").text(t.name),t.IR===!0?$("#overallVolumeContainer").show():$("#overallVolumeContainer").hide(),(util.getItem("deviceIndex")!=settings.userSettings.deviceIndex||util.getItem("roomIndex")!=settings.userSettings.roomIndex)&&(util.getItem("deviceIndex")!=settings.userSettings.deviceIndex&&bottomDraw.updateBottomContents(),ui.clearNowPlaying()),setTimeout(function(){ui.queryNowPlaying()},1500),util.setItem("deviceIndex",settings.userSettings.deviceIndex),util.setItem("roomIndex",settings.userSettings.roomIndex)},hms2:function(e){if(0>=e)return"0:00";try{return hours=parseInt(e/3600,10)%24,minutes=parseInt(e/60,10)%60,seconds=e%60,hours+":"+(10>minutes?"0"+minutes:minutes)}catch(t){return"0:00"}},clearCallers:function(e){if(e===!1){var t=$("#gestureCallback div.dofadeout-final");$(t).remove()}else $("#gestureCallback div").remove()},doAlert:function(e){try{navigator.notification.alert(e,null,"gesturePad")}catch(t){alert(e)}},isWifi:function(){if(settings.userSettings.wifi===!1)return!0;try{return"WiFi connection"==util.netState()?!0:!1}catch(e){return!0}},netState:function(){try{var e=navigator.connection.type,t={};return t[Connection.UNKNOWN]="Unknown connection",t[Connection.ETHERNET]="Ethernet connection",t[Connection.WIFI]="WiFi connection",t[Connection.CELL_2G]="Cell 2G connection",t[Connection.CELL_3G]="Cell 3G connection",t[Connection.CELL_4G]="Cell 4G connection",t[Connection.NONE]="No network connection",t[e]}catch(n){return"WiFi connection"}},setItem:function(e,t){localStorage.setItem(e,t)},getItem:function(e,t){try{return localStorage.getItem(e)}catch(n){return 1==arguments.length?t:""}},reloadPage:function(){console.log("reloading"),util.splash("show"),window.location.reload()},playBeep:function(){if(settings.userSettings.sounds)try{navigator.notification.beep()}catch(e){}if(settings.userSettings.vibrate)try{navigator.notification.vibrate(1e3)}catch(e){}}};$.fn.hasAttr=function(e){return void 0!==this.attr(e)},Date.prototype.timeNow=function(){var e="AM",t=this.getHours();return this.getHours()>12&&(e="PM",t-=12),0===t&&(t=12),e=t+":"+(10>this.getMinutes()?"0":"")+this.getMinutes()+" "+e,"0:00 AM"==e?"":e};